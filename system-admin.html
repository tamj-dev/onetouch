<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ã‚¹ãƒ†ãƒ ç®¡ç† | ãƒ¯ãƒ³ã‚¿ãƒƒãƒç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans CJK JP", sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
        }
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
        }
        .card {
            background: #fff;
            border-radius: 14px;
            padding: 32px 24px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
            border: 1px solid #e8e8e8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }
        .card:hover {
            border-color: #ccc;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }
        .card-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            color: #888;
        }
        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1e293b;
        }
        .card-description {
            font-size: 13px;
            color: #888;
            line-height: 1.6;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #bbb;
            font-size: 12px;
        }
        @media (max-width: 768px) {
            .cards-grid { grid-template-columns: 1fr; gap: 12px; }
            .card { padding: 24px 20px; }
            .card-icon { width: 40px; height: 40px; }
            .card-title { font-size: 16px; }
        }

        /* ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸€è¦§ */
        .setup-section {
            margin-bottom: 20px;
        }
        .setup-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .setup-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            border: 1px solid #e8e8e8;
            border-radius: 10px;
            padding: 16px 20px;
            text-decoration: none;
            color: inherit;
            transition: all 0.2s;
        }
        .setup-item:hover {
            border-color: #ccc;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }
        .setup-item-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .setup-item-name {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }
        .setup-item-progress {
            font-size: 13px;
            color: #666;
        }
        .setup-badge {
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
        }
        .setup-badge.in-progress { background: #dbeafe; color: #1d4ed8; }
        .setup-badge.complete { background: #dcfce7; color: #166534; }
    </style>
    <script src="demo-mode.js"></script>
    <script src="unified-header.js"></script>
    <meta name="theme-color" content="#1e3a5f">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
</head>
<body>
    <div id="unified-header-mount"></div>
    <div class="container">
        <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸€è¦§ -->
        <div class="setup-section" id="setupSection">
            <div class="setup-list" id="setupList"></div>
        </div>

        <div class="cards-grid">
            <a href="setup-wizard.html" class="card">
                <div class="card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg></div>
                <div class="card-title">æ–°è¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</div>
                <div class="card-description">
                    æ¥­è€…ãƒ»ä¼šç¤¾ãƒ»äº‹æ¥­æ‰€ãƒ»å¥‘ç´„ãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»å•†å“ã‚’<br>
                    ã‚¹ãƒ†ãƒƒãƒ—ã«æ²¿ã£ã¦ç™»éŒ²
                </div>
            </a>

            <div class="card" onclick="document.getElementById('contractPanel').style.display=document.getElementById('contractPanel').style.display==='none'?'block':'none'" style="cursor:pointer;">
                <div class="card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M9 14l2 2 4-4"/></svg></div>
                <div class="card-title">å¥‘ç´„ç®¡ç†</div>
                <div class="card-description">
                    æ¥­è€… Ã— ä¼šç¤¾ Ã— ã‚«ãƒ†ã‚´ãƒªã®ç´ã¥ã‘<br>
                    å¥‘ç´„ä¸€è¦§ã®ç¢ºèªãƒ»æ“ä½œæ‰‹é †
                </div>
            </div>

            <a href="system-admin-dashboard.html" class="card">
                <div class="card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
                <div class="card-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
                <div class="card-description">
                    å…¨ä½“çµ±è¨ˆãƒ»ä¼šç¤¾ç®¡ç†ãƒ»ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ<br>
                    ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’ç›£è¦–ãƒ»ç®¡ç†
                </div>
            </a>

            <a href="report-history.html" class="card">
                <div class="card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
                <div class="card-title">å…¨é€šå ±å±¥æ­´</div>
                <div class="card-description">
                    å…¨ä¼šç¤¾ãƒ»å…¨äº‹æ¥­æ‰€ã®é€šå ±ã‚’<br>
                    æ¨ªæ–­çš„ã«ç¢ºèªãƒ»æ¤œç´¢
                </div>
            </a>

            <a href="master-top.html" class="card">
                <div class="card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></div>
                <div class="card-title">ãƒã‚¹ã‚¿ç®¡ç†</div>
                <div class="card-description">
                    ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»äº‹æ¥­æ‰€ãƒ»å–å¼•å…ˆãªã©<br>
                    ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†
                </div>
            </a>

            <a href="docs.html" class="card">
                <div class="card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/><line x1="9" y1="7" x2="16" y2="7"/><line x1="9" y1="11" x2="16" y2="11"/><line x1="9" y1="15" x2="13" y2="15"/></svg></div>
                <div class="card-title">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</div>
                <div class="card-description">
                    é‹ç”¨ã‚¬ã‚¤ãƒ‰ãƒ»æ“ä½œæ‰‹é †ãƒ»æ¨©é™ä¸€è¦§<br>
                    FAQãƒ»ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸
                </div>
            </a>
        </div>

        <!-- å¥‘ç´„ç®¡ç†ãƒ‘ãƒãƒ« -->
        <div id="contractPanel" style="display:none; margin-top:24px;">
            <div style="background:#fff; border-radius:14px; border:1px solid #e8e8e8; padding:24px; box-shadow:0 1px 3px rgba(0,0,0,0.03);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="font-size:18px; font-weight:700; color:#1e293b;">å¥‘ç´„ä¸€è¦§ï¼ˆæ¥­è€… Ã— ä¼šç¤¾ Ã— ã‚«ãƒ†ã‚´ãƒªï¼‰</h2>
                    <button onclick="document.getElementById('contractPanel').style.display='none'" style="background:none; border:none; font-size:20px; color:#999; cursor:pointer;">âœ•</button>
                </div>

                <div style="overflow-x:auto; margin-bottom:20px;">
                    <table style="width:100%; border-collapse:collapse; font-size:14px;">
                        <thead>
                            <tr style="background:#f8f9fa; border-bottom:2px solid #e8e8e8;">
                                <th style="padding:10px 12px; text-align:left; font-weight:600; color:#64748b;">æ¥­è€…ã‚³ãƒ¼ãƒ‰</th>
                                <th style="padding:10px 12px; text-align:left; font-weight:600; color:#64748b;">æ¥­è€…å</th>
                                <th style="padding:10px 12px; text-align:left; font-weight:600; color:#64748b;">å¥‘ç´„ä¼šç¤¾</th>
                                <th style="padding:10px 12px; text-align:left; font-weight:600; color:#64748b;">æ‹…å½“ã‚«ãƒ†ã‚´ãƒª</th>
                                <th style="padding:10px 12px; text-align:left; font-weight:600; color:#64748b;">çŠ¶æ…‹</th>
                                <th style="padding:10px 12px; text-align:center; font-weight:600; color:#64748b;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="sysContractBody">
                            <tr><td colspan="6" style="text-align:center; padding:30px; color:#aaa;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- å¥‘ç´„ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
                <div id="contractEditModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; display:none; align-items:center; justify-content:center;">
                    <div style="background:#fff; border-radius:14px; padding:28px; max-width:500px; width:90%; margin:auto; position:relative; top:50%; transform:translateY(-50%);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h3 style="font-size:16px; font-weight:700; color:#1e293b;" id="contractEditTitle">å¥‘ç´„ç·¨é›†</h3>
                            <button onclick="closeContractEdit()" style="background:none; border:none; font-size:20px; color:#999; cursor:pointer;">âœ•</button>
                        </div>
                        <input type="hidden" id="editContractId">
                        
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-size:13px; font-weight:600; color:#64748b; margin-bottom:6px;">æ‹…å½“ã‚«ãƒ†ã‚´ãƒª</label>
                            <div id="editCategoryCheckboxes" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="display:block; font-size:13px; font-weight:600; color:#64748b; margin-bottom:6px;">çŠ¶æ…‹</label>
                            <select id="editContractStatus" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px; font-size:14px;">
                                <option value="active">æœ‰åŠ¹</option>
                                <option value="inactive">åœæ­¢</option>
                            </select>
                        </div>
                        
                        <div style="display:flex; gap:10px;">
                            <button onclick="closeContractEdit()" style="flex:1; padding:12px; background:#f1f5f9; color:#334155; border:none; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="saveContractEdit()" style="flex:1; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer;">ä¿å­˜</button>
                        </div>
                    </div>
                </div>

                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <a href="docs.html#guide" style="display:inline-flex; align-items:center; gap:6px; padding:10px 16px; background:#f0f7ff; border:1px solid #bfdbfe; border-radius:8px; text-decoration:none; color:#1e3a5f; font-size:13px; font-weight:600;">
                        ğŸ“– å¥‘ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã¯ï¼ˆæ¦‚è¦ï¼‰
                    </a>
                    <a href="docs.html#howto" style="display:inline-flex; align-items:center; gap:6px; padding:10px 16px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; text-decoration:none; color:#166534; font-size:13px; font-weight:600;">
                        ğŸ”§ æ¥­è€…ã®å¤‰æ›´æ‰‹é †
                    </a>
                    <a href="docs.html#faq" style="display:inline-flex; align-items:center; gap:6px; padding:10px 16px; background:#fefce8; border:1px solid #fde68a; border-radius:8px; text-decoration:none; color:#854d0e; font-size:13px; font-weight:600;">
                        â“ ã‚ˆãã‚ã‚‹è³ªå•
                    </a>
                    <a href="partner-master.html" style="display:inline-flex; align-items:center; gap:6px; padding:10px 16px; background:#faf5ff; border:1px solid #e9d5ff; border-radius:8px; text-decoration:none; color:#7c3aed; font-size:13px; font-weight:600;">
                        ğŸ‘¤ å–å¼•å…ˆãƒã‚¹ã‚¿ã‚’é–‹ã
                    </a>
                </div>
            </div>
        </div>

        <div class="footer">
            &copy; OneTouch Management System. All rights reserved.
        </div>
    </div>

    <script>
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        } else if (currentUser.role !== 'system_admin') {
            alert('ã“ã®ç”»é¢ã¯ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚');
            window.location.href = 'login.html';
        }

        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸€è¦§ã‚’è¡¨ç¤º
        (function() {
            var setups = [];
            try { setups = JSON.parse(localStorage.getItem('onetouch.setups') || '[]'); } catch(e) {}
            if (setups.length === 0) {
                try { setups = JSON.parse(sessionStorage.getItem('onetouch.setups') || '[]'); } catch(e) {}
            }
            
            var list = document.getElementById('setupList');
            var filtered = setups.filter(function(s) { return s.companyName && s.companyName !== ''; });
            if (filtered.length === 0) {
                document.getElementById('setupSection').style.display = 'none';
                return;
            }
            
            var stepNames = ['æ¥­è€…é¸æŠ','ä¼šç¤¾ç™»éŒ²','äº‹æ¥­æ‰€ç™»éŒ²','å¥‘ç´„è¨­å®š','ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²','å•†å“ç™»éŒ²'];
            
            list.innerHTML = setups.filter(function(s) {
                // ã‚¹ãƒ†ãƒƒãƒ—1ï¼ˆä¼šç¤¾åæœªå…¥åŠ›ï¼‰ã®ã‚‚ã®ã¯éè¡¨ç¤º
                return s.companyName && s.companyName !== '';
            }).map(function(s) {
                var isComplete = s.currentStep > 6;
                var badgeClass = isComplete ? 'complete' : 'in-progress';
                var badgeText = isComplete ? 'å®Œäº†' : 'ã‚¹ãƒ†ãƒƒãƒ— ' + s.currentStep + '/6';
                var progressText = isComplete ? 'å…¨ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†' : 'æ¬¡ï¼š' + (stepNames[s.currentStep - 1] || '');
                
                return '<a href="setup-wizard.html?id=' + s.id + '" class="setup-item">'
                    + '<div class="setup-item-left">'
                    + '<div>'
                    + '<div class="setup-item-name">' + (s.companyName || 'æœªå…¥åŠ›') + '</div>'
                    + '<div class="setup-item-progress">' + progressText + '</div>'
                    + '</div>'
                    + '</div>'
                    + '<span class="setup-badge ' + badgeClass + '">' + badgeText + '</span>'
                    + '</a>';
            }).join('');
        })();
    </script>
    <script>
    UnifiedHeader.init({
        icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>',
        title: 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†',
        backButton: false
    });

    // å…¨ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆ
    var ALL_CATEGORIES = ['å®¶å…·/ä»€å™¨','å®¶é›»','å¨æˆ¿/é£Ÿå™¨','æ°´é“','æµ´å®¤','ã‚¬ã‚¹','ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ','ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼/æ˜‡é™æ©Ÿ','ä»‹è­·åŒ»ç™‚ç”¨å“','ãã®ä»–'];

    // å¥‘ç´„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒ
    var _sysContracts = [];
    var _sysPartners = [];
    var _sysCompanies = [];

    function _loadContractData() {
        _sysContracts = [];
        try { _sysContracts = JSON.parse(sessionStorage.getItem('onetouch.contracts') || '[]'); } catch(e) {}
        try { var cl = JSON.parse(localStorage.getItem('onetouch.contracts') || '[]'); cl.forEach(function(c){ if(!_sysContracts.find(function(x){return x.id===c.id;})) _sysContracts.push(c); }); } catch(e) {}

        _sysPartners = [];
        try { _sysPartners = JSON.parse(sessionStorage.getItem('partners') || '[]'); } catch(e) {}
        try { var pl = JSON.parse(localStorage.getItem('partners') || '[]'); pl.forEach(function(p){ if(!_sysPartners.find(function(x){return x.id===p.id || x.partnerCode===p.partnerCode;})) _sysPartners.push(p); }); } catch(e) {}

        _sysCompanies = [];
        try { _sysCompanies = JSON.parse(sessionStorage.getItem('companies') || '[]'); } catch(e) {}
        try { var cl2 = JSON.parse(localStorage.getItem('companies') || '[]'); cl2.forEach(function(c){ if(!_sysCompanies.find(function(x){return (x.companyCode||x.code)===(c.companyCode||c.code);})) _sysCompanies.push(c); }); } catch(e) {}
    }

    function getPartnerName(id) {
        var p = _sysPartners.find(function(x){ return x.id === id || x.partnerCode === id; });
        return p ? p.name : id;
    }
    function getCompanyName(code) {
        var c = _sysCompanies.find(function(x){ return (x.companyCode||x.code) === code; });
        return c ? (c.companyName||c.name) : code;
    }

    // å¥‘ç´„ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
    function renderSysContracts() {
        _loadContractData();
        var tbody = document.getElementById('sysContractBody');
        if (_sysContracts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#aaa;">å¥‘ç´„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
            return;
        }

        tbody.innerHTML = _sysContracts.map(function(c, idx) {
            var cats = (c.categories || []).map(function(cat) {
                return '<span style="display:inline-block;padding:2px 8px;background:#f0f0f0;border-radius:4px;margin:2px;font-size:12px;">' + cat + '</span>';
            }).join('');
            var statusColor = c.status === 'active' ? '#22c55e' : '#ef4444';
            var statusText = c.status === 'active' ? 'æœ‰åŠ¹' : 'åœæ­¢';
            return '<tr style="border-bottom:1px solid #f0f0f0;">'
                + '<td style="padding:10px 12px;font-family:monospace;font-size:13px;">' + (c.partnerId || '-') + '</td>'
                + '<td style="padding:10px 12px;">' + getPartnerName(c.partnerId) + '</td>'
                + '<td style="padding:10px 12px;">' + getCompanyName(c.companyCode) + (c.officeCode ? '<br><span style="font-size:11px;color:#999;">' + c.officeCode + '</span>' : '') + '</td>'
                + '<td style="padding:10px 12px;">' + (cats || '<span style="color:#ccc;">æœªè¨­å®š</span>') + '</td>'
                + '<td style="padding:10px 12px;"><span style="display:inline-block;padding:2px 10px;border-radius:10px;font-size:12px;font-weight:600;color:#fff;background:' + statusColor + ';">' + statusText + '</span></td>'
                + '<td style="padding:10px 12px; text-align:center;"><button onclick="openContractEdit(\'' + c.id + '\')" style="padding:6px 14px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;">ç·¨é›†</button></td>'
                + '</tr>';
        }).join('');
    }
    renderSysContracts();

    // å¥‘ç´„ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openContractEdit(contractId) {
        var contract = _sysContracts.find(function(c) { return c.id === contractId; });
        if (!contract) return;
        
        document.getElementById('editContractId').value = contractId;
        document.getElementById('contractEditTitle').textContent = getPartnerName(contract.partnerId) + ' ã®å¥‘ç´„ç·¨é›†';
        document.getElementById('editContractStatus').value = contract.status || 'active';
        
        // ã‚«ãƒ†ã‚´ãƒªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ
        var currentCats = contract.categories || [];
        var html = ALL_CATEGORIES.map(function(cat) {
            var checked = currentCats.indexOf(cat) >= 0 ? 'checked' : '';
            return '<label style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:' + (checked ? '#eff6ff' : '#f8f9fa') + ';border:1px solid ' + (checked ? '#2563eb' : '#e5e7eb') + ';border-radius:6px;cursor:pointer;font-size:13px;">'
                + '<input type="checkbox" name="editCat" value="' + cat + '" ' + checked + ' style="accent-color:#2563eb;">'
                + cat + '</label>';
        }).join('');
        document.getElementById('editCategoryCheckboxes').innerHTML = html;
        
        document.getElementById('contractEditModal').style.display = 'block';
    }

    function closeContractEdit() {
        document.getElementById('contractEditModal').style.display = 'none';
    }

    // å¥‘ç´„ä¿å­˜
    function saveContractEdit() {
        var contractId = document.getElementById('editContractId').value;
        var newStatus = document.getElementById('editContractStatus').value;
        var checkboxes = document.querySelectorAll('input[name="editCat"]:checked');
        var newCats = [];
        checkboxes.forEach(function(cb) { newCats.push(cb.value); });
        
        if (newCats.length === 0) {
            alert('ã‚«ãƒ†ã‚´ãƒªã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        var contracts = [];
        try { contracts = JSON.parse(sessionStorage.getItem('onetouch.contracts') || '[]'); } catch(e) {}
        if (contracts.length === 0) {
            try { contracts = JSON.parse(localStorage.getItem('onetouch.contracts') || '[]'); } catch(e) {}
        }
        
        var updated = false;
        contracts.forEach(function(c) {
            if (c.id === contractId) {
                c.categories = newCats;
                c.status = newStatus;
                updated = true;
            }
        });
        
        if (updated) {
            sessionStorage.setItem('onetouch.contracts', JSON.stringify(contracts));
            localStorage.setItem('onetouch.contracts', JSON.stringify(contracts));
            closeContractEdit();
            renderSysContracts();
            
            // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
            var toast = document.createElement('div');
            toast.textContent = 'å¥‘ç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ';
            toast.style.cssText = 'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#1e3a5f;color:#fff;padding:12px 24px;border-radius:8px;font-size:14px;font-weight:600;z-index:99999;';
            document.body.appendChild(toast);
            setTimeout(function() { toast.remove(); }, 2000);
        }
    }
    </script>
</body>
</html>
