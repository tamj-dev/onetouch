<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ç¢ºèª | ãƒ¯ãƒ³ã‚¿ãƒƒãƒç®¡ç†</title>
  <script src="document-storage.js"></script>
  <script src="unified-header.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", sans-serif;
      background: #fafafa;
      min-height: 100vh;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 16px 120px;
    }
    h2 {
      font-size: 20px;
      color: #333;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .toolbar .btn {
      padding: 8px 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .toolbar .btn:hover { background: #f5f5f5; border-color: #bbb; }
    .warning-badge {
      display: none;
      margin-left: auto;
      padding: 6px 12px;
      background: #fff3e0;
      color: #e65100;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    .table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead th {
      background: #f8f9fa;
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid #e0e0e0;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr { border-bottom: 1px solid #f0f0f0; transition: background 0.15s; }
    tbody tr:hover { background: #fafafa; }
    tbody td { padding: 6px 8px; vertical-align: middle; }
    .row-num { color: #999; text-align: center; width: 30px; }

    /* ç·¨é›†å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
    table input, table select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
      transition: border-color 0.15s;
    }
    table input:focus, table select:focus {
      outline: none;
      border-color: #E53935;
      box-shadow: 0 0 0 2px rgba(229,57,53,0.1);
    }
    table input[type="number"] { text-align: right; }
    .col-name input { min-width: 140px; font-weight: 600; }
    .col-maker input { min-width: 100px; }
    .col-model input { min-width: 100px; }
    .col-qty input { width: 60px; }
    .col-price input { width: 80px; }
    .col-category select { min-width: 90px; }

    /* ä¿¡é ¼åº¦ */
    .conf-cell { text-align: center; font-size: 12px; font-weight: 600; }
    .conf-cell.high { color: #4caf50; }
    .conf-cell.mid { color: #ff9800; }
    .conf-cell.low { color: #f44336; }
    tr.low-conf { background: #fff8e1; }

    /* å‰Šé™¤ãƒœã‚¿ãƒ³ */
    .btn-del {
      background: none; border: none; cursor: pointer;
      color: #999; font-size: 16px; padding: 4px;
      border-radius: 4px; transition: all 0.15s;
    }
    .btn-del:hover { color: #f44336; background: #ffebee; }

    /* ä¸‹éƒ¨ãƒãƒ¼ */
    .bottom-bar {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: white;
      border-top: 1px solid #e0e0e0;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
    }
    .bottom-summary { font-size: 15px; color: #333; }
    .bottom-summary strong { color: #E53935; font-size: 20px; }
    .bottom-actions { display: flex; gap: 8px; }
    .btn-cancel {
      padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px;
      background: white; font-size: 14px; cursor: pointer;
    }
    .btn-cancel:hover { background: #f5f5f5; }
    .btn-confirm {
      padding: 10px 24px; border: none; border-radius: 6px;
      background: #E53935; color: white; font-size: 14px;
      font-weight: 600; cursor: pointer; transition: background 0.15s;
    }
    .btn-confirm:hover { background: #D32F2F; }
    .btn-confirm:disabled { background: #ccc; cursor: not-allowed; }

    /* ç©ºçŠ¶æ…‹ */
    .empty-state {
      text-align: center; padding: 60px 20px; color: #999;
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 12px; }

    /* Toast */
    .toast {
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600;
      display: none; z-index: 200; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .toast.success { background: #4caf50; color: white; display: block; }
    .toast.error { background: #f44336; color: white; display: block; }

    @media (max-width: 768px) {
      .container { padding: 16px 8px 120px; }
      .bottom-bar { padding: 10px 16px; flex-direction: column; gap: 8px; }
    }
  </style>
</head>
<body>
  <div id="unified-header-mount"></div>

  <div class="container">
    <h2>ğŸ“‹ ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ç¢ºèª</h2>
    <p style="color: #666; font-size: 13px; margin-bottom: 16px;" id="docInfo">
      å–ã‚Šè¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªãƒ»ä¿®æ­£ã—ã¦ã‹ã‚‰å•†å“ãƒã‚¹ã‚¿ã«ç™»éŒ²ã—ã¾ã™ã€‚
    </p>

    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
    <div class="toolbar">
      <button class="btn" onclick="autoCategory()">ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªæ¨å®š</button>
      <button class="btn" onclick="normalizeAll()">ğŸ”¤ å…¨è§’â†’åŠè§’</button>
      <button class="btn" onclick="selectAll()">â˜‘ï¸ å…¨é¸æŠ</button>
      <span class="warning-badge" id="warningBadge">
        âš ï¸ <span id="warningCount">0</span>ä»¶ã®è¦ç¢ºèª
      </span>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>å•†å“å</th>
            <th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th>
            <th>å‹ç•ª</th>
            <th>æ•°é‡</th>
            <th>å˜ä¾¡</th>
            <th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
            <th>ä¿¡é ¼åº¦</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="9" class="empty-state"><div class="icon">â³</div>èª­ã¿è¾¼ã¿ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ä¸‹éƒ¨ãƒãƒ¼ -->
  <div class="bottom-bar">
    <div class="bottom-summary">
      <strong id="totalCount">0</strong>ä»¶ã®å•†å“ã‚’ç™»éŒ²ã—ã¾ã™
    </div>
    <div class="bottom-actions">
      <button class="btn-cancel" onclick="cancelAll()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-confirm" id="confirmBtn" onclick="confirmAll()">âœ… ç¢ºå®šã—ã¦å•†å“ãƒã‚¹ã‚¿ã«ç™»éŒ²</button>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ============================================
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ & ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
    // ============================================
    const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
    if (!currentUser) { window.location.href = 'login.html'; }

    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('docId') || urlParams.get('doc');

    if (!docId) {
      alert('æ›¸é¡IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      window.location.href = 'import.html';
    }

    let lineItems = [];
    const CATEGORIES = ["ç©ºèª¿", "çµ¦æ¹¯", "é›»æ°—", "æ°´é“", "è¨­å‚™", "ç¦ç¥‰ç”¨å…·", "åŒ»ç™‚æ©Ÿå™¨", "æ¶ˆè€—å“", "ä»€å™¨", "ãã®ä»–"];

    // ã‚«ãƒ†ã‚´ãƒªæ¨å®šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    const CATEGORY_KEYWORDS = {
      "ç©ºèª¿": ["ã‚¨ã‚¢ã‚³ãƒ³", "ç©ºèª¿", "å†·æš–æˆ¿", "å®¤å¤–æ©Ÿ"],
      "çµ¦æ¹¯": ["çµ¦æ¹¯", "ãƒœã‚¤ãƒ©ãƒ¼", "æ¸©æ°´"],
      "é›»æ°—": ["ç…§æ˜", "LED", "é…ç·š", "åˆ†é›»ç›¤", "ã‚³ãƒ³ã‚»ãƒ³ãƒˆ"],
      "æ°´é“": ["ãƒˆã‚¤ãƒ¬", "è›‡å£", "é…ç®¡", "æ’æ°´", "æµ„åŒ–æ§½"],
      "è¨­å‚™": ["ãƒ‰ã‚¢", "è‡ªå‹•ãƒ‰ã‚¢", "ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼", "ç™ºé›»", "å†·è”µåº«", "æ´—æ¿¯æ©Ÿ", "ä¹¾ç‡¥æ©Ÿ"],
      "ç¦ç¥‰ç”¨å…·": ["è»Šã„ã™", "è»Šæ¤…å­", "ãƒ™ãƒƒãƒ‰", "å¯å°", "æ­©è¡Œå™¨", "æ–", "æ‰‹ã™ã‚Š", "ãƒãƒ¼ã‚¿ãƒ–ãƒ«ãƒˆã‚¤ãƒ¬", "ãƒªãƒ•ãƒˆ"],
      "åŒ»ç™‚æ©Ÿå™¨": ["è¡€åœ§è¨ˆ", "ä½“æ¸©è¨ˆ", "ãƒ‘ãƒ«ã‚¹ã‚ªã‚­ã‚·ãƒ¡ãƒ¼ã‚¿ãƒ¼", "å¸å¼•å™¨", "AED", "é…¸ç´ "],
      "æ¶ˆè€—å“": ["ãŠã‚€ã¤", "ã‚°ãƒ­ãƒ¼ãƒ–", "ãƒã‚¹ã‚¯", "ã‚¬ãƒ¼ã‚¼", "æ¶ˆæ¯’", "æ´—å‰¤"],
      "ä»€å™¨": ["ãƒ†ãƒ¼ãƒ–ãƒ«", "æ¤…å­", "æ£š", "ãƒ­ãƒƒã‚«ãƒ¼", "ã‚«ãƒ¼ãƒ†ãƒ³"],
    };

    // ============================================
    // åˆæœŸåŒ–
    // ============================================
    UnifiedHeader.init({
      title: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¢ºèª',
      icon: 'ğŸ“‹',
      backUrl: 'import.html'
    });

    loadData();

    async function loadData() {
      try {
        // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
        const doc = await DocumentStorage.getDocument(docId);
        if (doc) {
          const info = document.getElementById('docInfo');
          info.textContent = `ğŸ“„ ${doc.fileName || 'ä¸æ˜'} ã‹ã‚‰ã®å–ã‚Šè¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
        }

        // LineItemså–å¾—
        lineItems = await DocumentStorage.getLineItemsByDoc(docId);

        if (lineItems.length === 0) {
          document.getElementById('tableBody').innerHTML =
            '<tr><td colspan="9" class="empty-state"><div class="icon">ğŸ“‹</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></td></tr>';
          document.getElementById('confirmBtn').disabled = true;
          return;
        }

        renderTable();
        updateCounts();
      } catch (e) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ============================================
    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    // ============================================
    function renderTable() {
      const tbody = document.getElementById('tableBody');

      if (lineItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><div class="icon">ğŸ“‹</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></td></tr>';
        return;
      }

      tbody.innerHTML = lineItems.map((item, idx) => {
        const conf = item.confidence || 1;
        const isLow = conf < 0.75;
        const confClass = conf >= 0.85 ? 'high' : (conf >= 0.60 ? 'mid' : 'low');
        return `
        <tr data-line-id="${item.lineId}" class="${isLow ? 'low-conf' : ''}">
          <td class="row-num">${idx + 1}</td>
          <td class="col-name"><input type="text" value="${esc(item.name)}" data-field="name"></td>
          <td class="col-maker"><input type="text" value="${esc(item.maker || '')}" data-field="maker"></td>
          <td class="col-model"><input type="text" value="${esc(item.model || '')}" data-field="model"></td>
          <td class="col-qty"><input type="number" value="${item.quantity || item.qty || ''}" data-field="quantity" style="width:60px;"></td>
          <td class="col-price"><input type="number" value="${item.price || item.unitPrice || ''}" data-field="price" style="width:80px;"></td>
          <td class="col-category">
            <select data-field="category">
              <option value="">æœªåˆ†é¡</option>
              ${CATEGORIES.map(c => `<option value="${c}" ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}
            </select>
          </td>
          <td class="conf-cell ${confClass}">${Math.round(conf * 100)}%</td>
          <td><button class="btn-del" onclick="deleteRow('${item.lineId}')" title="å‰Šé™¤">âœ•</button></td>
        </tr>`;
      }).join('');

      // å¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼
      tbody.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('change', handleFieldChange);
      });
    }

    function esc(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // ============================================
    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´
    // ============================================
    function handleFieldChange(e) {
      const tr = e.target.closest('tr');
      const lineId = tr.dataset.lineId;
      const field = e.target.dataset.field;
      let value = e.target.value;

      const item = lineItems.find(i => i.lineId === lineId);
      if (!item) return;

      if (field === 'quantity' || field === 'price') {
        value = parseFloat(value) || 0;
      }
      item[field] = value;
      updateCounts();
    }

    // ============================================
    // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
    // ============================================
    function updateCounts() {
      const validCount = lineItems.filter(i => i.name && i.name.trim()).length;
      document.getElementById('totalCount').textContent = validCount;
      document.getElementById('confirmBtn').disabled = validCount === 0;

      const warningCount = lineItems.filter(i => (i.confidence || 1) < 0.75).length;
      const badge = document.getElementById('warningBadge');
      if (warningCount > 0) {
        badge.style.display = 'inline-flex';
        document.getElementById('warningCount').textContent = warningCount;
      } else {
        badge.style.display = 'none';
      }
    }

    // ============================================
    // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½
    // ============================================
    function deleteRow(lineId) {
      lineItems = lineItems.filter(i => i.lineId !== lineId);
      renderTable();
      updateCounts();
    }

    function normalizeAll() {
      lineItems.forEach(item => {
        ['name', 'maker', 'model'].forEach(f => {
          if (item[f]) {
            item[f] = item[f]
              .replace(/[\uff01-\uff5e]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xfee0))
              .replace(/\u3000/g, ' ')
              .trim();
          }
        });
      });
      renderTable();
      updateCounts();
      showToast('å…¨è§’â†’åŠè§’ã«å¤‰æ›ã—ã¾ã—ãŸ', 'success');
    }

    function autoCategory() {
      let count = 0;
      lineItems.forEach(item => {
        if (item.category && item.category !== 'ãã®ä»–') return;
        const text = ((item.name || '') + ' ' + (item.maker || '')).toLowerCase();
        for (const [category, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
          for (const kw of keywords) {
            if (text.includes(kw.toLowerCase())) {
              item.category = category;
              count++;
              return;
            }
          }
        }
        if (!item.category) item.category = 'ãã®ä»–';
      });
      renderTable();
      updateCounts();
      showToast(`${count}ä»¶ã®ã‚«ãƒ†ã‚´ãƒªã‚’æ¨å®šã—ã¾ã—ãŸ`, 'success');
    }

    function selectAll() {
      document.querySelectorAll('#tableBody input[data-field="name"]').forEach(el => {
        el.select();
      });
    }

    // ============================================
    // ç¢ºå®š / ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    // ============================================
    async function confirmAll() {
      const validCount = lineItems.filter(i => i.name && i.name.trim()).length;

      if (validCount === 0) {
        showToast('ç™»éŒ²ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      if (!confirm(`${validCount}ä»¶ã®å•†å“ã‚’å•†å“ãƒã‚¹ã‚¿ã«ç™»éŒ²ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

      const btn = document.getElementById('confirmBtn');
      btn.disabled = true;
      btn.textContent = 'ç™»éŒ²ä¸­...';

      try {
        // å¤‰æ›´ã‚’LineItemsã«ä¿å­˜ã—ã¦ã‹ã‚‰ç¢ºå®š
        for (const item of lineItems) {
          await DocumentStorage.updateLineItem(item);
        }

        // LineItems â†’ å•†å“ãƒã‚¹ã‚¿ã«ç™»éŒ²
        const newItems = await DocumentStorage.confirmLineItems(docId);

        showToast(`${newItems.length}ä»¶ã‚’å•†å“ãƒã‚¹ã‚¿ã«ç™»éŒ²ã—ã¾ã—ãŸï¼`, 'success');

        setTimeout(() => {
          window.location.href = 'items.html';
        }, 1500);

      } catch (e) {
        console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', e);
        showToast('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error');
        btn.disabled = false;
        btn.textContent = 'âœ… ç¢ºå®šã—ã¦å•†å“ãƒã‚¹ã‚¿ã«ç™»éŒ²';
      }
    }

    function cancelAll() {
      if (confirm('å¤‰æ›´ã‚’ç ´æ£„ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
        window.location.href = 'import.html';
      }
    }

    // ============================================
    // Toast
    // ============================================
    function showToast(msg, type) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast ' + type;
      setTimeout(() => { toast.className = 'toast'; }, 3000);
    }
  </script>
</body>
</html>
