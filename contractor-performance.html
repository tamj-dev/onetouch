<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¾å¿œå®Ÿç¸¾ | ãƒ¯ãƒ³ã‚¿ãƒƒãƒç®¡ç†</title>
    <script src="demo-mode.js"></script>
    <script src="unified-header.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans",sans-serif; background:#f5f5f5; min-height:100vh; }
        .container { max-width:800px; margin:0 auto; padding:24px; }

        /* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
        .summary-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:12px; margin-bottom:28px; }
        .summary-card { background:#fff; border-radius:12px; padding:16px; border:1px solid #e8e8e8; text-align:center; }
        .summary-card .label { font-size:12px; color:#888; margin-bottom:6px; }
        .summary-card .value { font-size:28px; font-weight:700; color:#333; }
        .summary-card .unit { font-size:12px; color:#888; font-weight:400; }
        .summary-card.highlight { border-color:#4361ee; background:#f8faff; }
        .summary-card.highlight .value { color:#4361ee; }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .section-title { font-size:16px; font-weight:700; color:#1e293b; margin-bottom:16px; display:flex; align-items:center; gap:8px; }

        /* æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ */
        .period-filter { display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap; }
        .period-btn { padding:6px 14px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer; font-size:13px; color:#666; }
        .period-btn.active { background:#333; color:#fff; border-color:#333; }

        /* ãƒãƒ¼ãƒãƒ£ãƒ¼ãƒˆ */
        .chart-container { background:#fff; border-radius:12px; padding:20px; border:1px solid #e8e8e8; margin-bottom:20px; }
        .chart-title { font-size:14px; font-weight:600; color:#333; margin-bottom:16px; }
        .bar-row { display:flex; align-items:center; margin-bottom:10px; }
        .bar-label { width:120px; font-size:12px; color:#666; flex-shrink:0; }
        .bar-track { flex:1; height:24px; background:#f3f4f6; border-radius:4px; overflow:hidden; position:relative; }
        .bar-fill { height:100%; border-radius:4px; transition:width 0.5s ease; }
        .bar-value { position:absolute; right:8px; top:50%; transform:translateY(-50%); font-size:11px; font-weight:600; color:#333; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .history-table { width:100%; border-collapse:collapse; font-size:13px; }
        .history-table th { text-align:left; padding:10px 12px; background:#f9fafb; color:#666; font-weight:600; border-bottom:1px solid #e5e7eb; font-size:12px; }
        .history-table td { padding:10px 12px; border-bottom:1px solid #f3f4f6; color:#333; }
        .status-badge { display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; }
        .status-badge.completed { background:#ecfdf5; color:#059669; }
        .status-badge.in-progress { background:#eff6ff; color:#2563eb; }
        .status-badge.rejected { background:#fef2f2; color:#dc2626; }

        /* ç©ºçŠ¶æ…‹ */
        .empty-state { text-align:center; padding:60px 20px; color:#999; }
        .empty-state .icon { font-size:48px; margin-bottom:12px; }
    </style>
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <div id="unified-header-mount"></div>

    <div class="container">
        <!-- ã‚µãƒãƒªãƒ¼ -->
        <div class="section-title">å®Ÿç¸¾ã‚µãƒãƒªãƒ¼</div>
        <div class="summary-grid">
            <div class="summary-card highlight">
                <div class="label">å¯¾å¿œå®Œäº†</div>
                <div class="value" id="totalCompleted">0<span class="unit">ä»¶</span></div>
            </div>
            <div class="summary-card">
                <div class="label">å¹³å‡å¯¾å¿œæ™‚é–“</div>
                <div class="value" id="avgTime">-<span class="unit"></span></div>
            </div>
            <div class="summary-card">
                <div class="label">å¯¾å¿œä¸å¯</div>
                <div class="value" id="totalRejected">0<span class="unit">ä»¶</span></div>
            </div>
            <div class="summary-card">
                <div class="label">å¯¾å¿œç‡</div>
                <div class="value" id="completionRate">-<span class="unit">%</span></div>
            </div>
        </div>

        <!-- æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ -->
        <div class="period-filter">
            <button class="period-btn" onclick="setPeriod('week', this)">ä»Šé€±</button>
            <button class="period-btn active" onclick="setPeriod('month', this)">ä»Šæœˆ</button>
            <button class="period-btn" onclick="setPeriod('3months', this)">3ãƒ¶æœˆ</button>
            <button class="period-btn" onclick="setPeriod('all', this)">å…¨æœŸé–“</button>
        </div>

        <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥å®Ÿç¸¾ -->
        <div class="chart-container">
            <div class="chart-title">ã‚«ãƒ†ã‚´ãƒªåˆ¥ å¯¾å¿œä»¶æ•°</div>
            <div id="categoryChart"></div>
        </div>

        <!-- å¯¾å¿œå±¥æ­´ -->
        <div class="section-title">å¯¾å¿œå±¥æ­´</div>
        <div class="chart-container" style="padding:0;overflow:hidden;">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>æ—¥æ™‚</th>
                        <th>è¨­å‚™å</th>
                        <th>ã‚«ãƒ†ã‚´ãƒª</th>
                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th>å¯¾å¿œæ™‚é–“</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
    UnifiedHeader.init({
        title: 'å¯¾å¿œå®Ÿç¸¾',
        backButton: false
    });

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
    var currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
    if (!currentUser) { window.location.href = 'login.html'; }
    var currentContractor = JSON.parse(sessionStorage.getItem('currentContractor') || 'null');

    var allReports = [];
    var currentPeriod = 'month';
    var COLORS = ['#4361ee','#059669','#d97706','#dc2626','#8b5cf6','#0891b2','#e11d48','#65a30d','#9333ea'];

    // é€šå ±ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadReports() {
        var reports = [];
        try { reports = JSON.parse(sessionStorage.getItem('demo.reports') || '[]'); } catch(e) {}
        try { var r2 = JSON.parse(localStorage.getItem('onetouch.reports') || '[]'); r2.forEach(function(r){ if(!reports.find(function(m){return m.id===r.id;})) reports.push(r); }); } catch(e) {}
        try { var r3 = JSON.parse(sessionStorage.getItem('reports') || '[]'); r3.forEach(function(r){ if(!reports.find(function(m){return m.id===r.id;})) reports.push(r); }); } catch(e) {}

        // è‡ªåˆ†ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸé€šå ±ã®ã¿
        if (currentContractor) {
            reports = reports.filter(function(r) {
                return r.assignedPartnerId === currentContractor.id ||
                       r.assignedPartnerId === currentContractor.partnerCode;
            });
        }

        allReports = reports;
        renderAll();
    }

    function setPeriod(period, btn) {
        currentPeriod = period;
        document.querySelectorAll('.period-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        renderAll();
    }

    function getFilteredReports() {
        var now = new Date();
        return allReports.filter(function(r) {
            if (currentPeriod === 'all') return true;
            var d = new Date(r.timestamp || r.createdAt);
            if (isNaN(d.getTime())) return true;
            if (currentPeriod === 'week') {
                return (now - d) < 7 * 24 * 60 * 60 * 1000;
            }
            if (currentPeriod === 'month') {
                return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
            }
            if (currentPeriod === '3months') {
                var threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 2, 1);
                return d >= threeMonthsAgo;
            }
            return true;
        });
    }

    function renderAll() {
        var filtered = getFilteredReports();

        // ã‚µãƒãƒªãƒ¼
        var completed = filtered.filter(function(r) { var s = r.contractorStatus || r.status || ''; return s === 'å®Œäº†' || s === 'completed'; });
        var rejected = filtered.filter(function(r) { var s = r.contractorStatus || r.status || ''; return s === 'å¯¾å¿œä¸å¯' || s === 'rejected'; });
        var total = completed.length + rejected.length;

        document.getElementById('totalCompleted').innerHTML = completed.length + '<span class="unit">ä»¶</span>';
        document.getElementById('totalRejected').innerHTML = rejected.length + '<span class="unit">ä»¶</span>';

        // å¯¾å¿œç‡
        if (filtered.length > 0) {
            var rate = Math.round((completed.length / filtered.length) * 100);
            document.getElementById('completionRate').innerHTML = rate + '<span class="unit">%</span>';
        } else {
            document.getElementById('completionRate').innerHTML = '-<span class="unit">%</span>';
        }

        // å¹³å‡å¯¾å¿œæ™‚é–“
        var times = [];
        completed.forEach(function(r) {
            if (r.timestamp && r.completedAt) {
                var start = new Date(r.timestamp);
                var end = new Date(r.completedAt);
                if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
                    times.push(end - start);
                }
            } else if (r.statusHistory && r.statusHistory.length > 0) {
                var created = new Date(r.timestamp || r.createdAt);
                var last = r.statusHistory[r.statusHistory.length - 1];
                var done = new Date(last.timestamp || last.changedAt);
                if (!isNaN(created.getTime()) && !isNaN(done.getTime())) {
                    times.push(done - created);
                }
            }
        });

        if (times.length > 0) {
            var avg = times.reduce(function(a, b) { return a + b; }, 0) / times.length;
            var hours = Math.floor(avg / (1000 * 60 * 60));
            var minutes = Math.floor((avg % (1000 * 60 * 60)) / (1000 * 60));
            if (hours > 24) {
                var days = Math.floor(hours / 24);
                document.getElementById('avgTime').innerHTML = days + '<span class="unit">æ—¥</span>';
            } else if (hours > 0) {
                document.getElementById('avgTime').innerHTML = hours + '<span class="unit">æ™‚é–“</span>' + minutes + '<span class="unit">åˆ†</span>';
            } else {
                document.getElementById('avgTime').innerHTML = minutes + '<span class="unit">åˆ†</span>';
            }
        } else {
            document.getElementById('avgTime').innerHTML = '-<span class="unit"></span>';
        }

        // ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒãƒ£ãƒ¼ãƒˆ
        renderCategoryChart(filtered);

        // å¯¾å¿œå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«
        renderHistory(filtered);
    }

    function renderCategoryChart(reports) {
        var cats = {};
        reports.forEach(function(r) {
            var cat = r.category || 'ãã®ä»–';
            cats[cat] = (cats[cat] || 0) + 1;
        });

        var sorted = Object.entries(cats).sort(function(a, b) { return b[1] - a[1]; });
        var max = sorted.length > 0 ? sorted[0][1] : 1;

        var container = document.getElementById('categoryChart');
        if (sorted.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“Š</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
            return;
        }

        container.innerHTML = sorted.map(function(entry, idx) {
            var pct = Math.round((entry[1] / max) * 100);
            var color = COLORS[idx % COLORS.length];
            return '<div class="bar-row">' +
                '<div class="bar-label">' + entry[0] + '</div>' +
                '<div class="bar-track">' +
                    '<div class="bar-fill" style="width:' + pct + '%;background:' + color + ';"></div>' +
                    '<div class="bar-value">' + entry[1] + 'ä»¶</div>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    function renderHistory(reports) {
        var tbody = document.getElementById('historyBody');

        // å®Œäº†ãƒ»å¯¾å¿œä¸å¯ã®ã¿ã€æ–°ã—ã„é †
        var history = reports.filter(function(r) {
            var s = r.contractorStatus || r.status || '';
            return s === 'å®Œäº†' || s === 'å¯¾å¿œä¸å¯' || s === 'completed' || s === 'rejected';
        }).sort(function(a, b) {
            return new Date(b.completedAt || b.timestamp) - new Date(a.completedAt || a.timestamp);
        });

        if (history.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:#999;">å¯¾å¿œæ¸ˆã¿ã®å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
            return;
        }

        tbody.innerHTML = history.slice(0, 50).map(function(r) {
            var date = new Date(r.completedAt || r.timestamp);
            var dateStr = isNaN(date.getTime()) ? '-' :
                date.getFullYear() + '/' + String(date.getMonth()+1).padStart(2,'0') + '/' + String(date.getDate()).padStart(2,'0');

            var rawStatus = r.contractorStatus || r.status || '';
            var statusClass = (rawStatus === 'å®Œäº†' || rawStatus === 'completed') ? 'completed' : 'rejected';
            var statusLabel = (rawStatus === 'completed') ? 'å®Œäº†' : (rawStatus === 'rejected') ? 'å¯¾å¿œä¸å¯' : rawStatus;

            // å¯¾å¿œæ™‚é–“è¨ˆç®—
            var timeStr = '-';
            var start = new Date(r.timestamp || r.createdAt);
            var end = new Date(r.completedAt);
            if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
                var diff = end - start;
                var h = Math.floor(diff / (1000*60*60));
                var m = Math.floor((diff % (1000*60*60)) / (1000*60));
                if (h > 24) {
                    timeStr = Math.floor(h/24) + 'æ—¥';
                } else if (h > 0) {
                    timeStr = h + 'æ™‚é–“' + m + 'åˆ†';
                } else {
                    timeStr = m + 'åˆ†';
                }
            }

            return '<tr>' +
                '<td>' + dateStr + '</td>' +
                '<td>' + (r.title || '-') + '</td>' +
                '<td>' + (r.category || '-') + '</td>' +
                '<td><span class="status-badge ' + statusClass + '">' + statusLabel + '</span></td>' +
                '<td>' + timeStr + '</td>' +
            '</tr>';
        }).join('');
    }

    loadReports();
    </script>
</body>
</html>
