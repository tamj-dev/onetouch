<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ä¸€è¦§ | ãƒ¯ãƒ³ã‚¿ãƒƒãƒç®¡ç†</title>
    <script src="demo-mode.js"></script>
    <script>
        // item-storage.js ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã¿
        const DB_NAME = 'OneTouchDB';
        const DB_VERSION = 1;
        let db = null;

        async function openDB() {
          return new Promise((resolve, reject) => {
            if (db) return resolve(db);
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => { db = request.result; resolve(db); };
            request.onupgradeneeded = (event) => {
              const database = event.target.result;
              if (!database.objectStoreNames.contains('items')) {
                const itemStore = database.createObjectStore('items', { keyPath: 'itemId' });
                itemStore.createIndex('companyCode', 'companyCode', { unique: false });
                itemStore.createIndex('officeCode', 'officeCode', { unique: false });
              }
            };
          });
        }

        function isDemoMode() {
          try {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            console.log('[isDemoMode] currentUser:', currentUser);
            console.log('[isDemoMode] companyCode:', currentUser?.companyCode);
            const result = currentUser && currentUser.companyCode === 'TAMJ';
            console.log('[isDemoMode] result:', result);
            return result;
          } catch (e) { 
            console.log('[isDemoMode] error:', e);
            return false; 
          }
        }

        async function initDemoItems() {
          if (!isDemoMode() || sessionStorage.getItem('demo.items')) return;
          sessionStorage.setItem('demo.items', JSON.stringify([]));
        }

        async function getItems() {
          const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
          if (!currentUser) return [];
          if (isDemoMode()) {
            return JSON.parse(sessionStorage.getItem('demo.items') || '[]');
          }
          // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰: localStorageã‹ã‚‰å–å¾—ï¼ˆscopeåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
          const allItems = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
          if (currentUser.role === 'system_admin') return allItems;
          if (currentUser.role === 'company_admin') return allItems.filter(i => i.companyCode === currentUser.companyCode);
          return allItems.filter(i => i.officeCode === currentUser.officeCode);
        }

        // å•†å“ãƒŠãƒ³ãƒãƒ¼ç”Ÿæˆ: æ¥­è€…ã‚³ãƒ¼ãƒ‰ + yymm + 4æ¡é€£ç•ª
        // ä¾‹: P001250200001
        function generateItemNumber(assignedPartnerId) {
          // æ¥­è€…ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
          var partnerCode = '';
          if (assignedPartnerId) {
            var partners = [];
            try { partners = JSON.parse(sessionStorage.getItem('partners') || '[]'); } catch(e) {}
            try { var pl = JSON.parse(localStorage.getItem('partners') || '[]'); pl.forEach(function(p){ if(!partners.find(function(m){return m.id===p.id;})) partners.push(p); }); } catch(e) {}
            var partner = partners.find(function(p) { return p.id === assignedPartnerId; });
            if (partner && partner.partnerCode) partnerCode = partner.partnerCode;
          }
          if (!partnerCode) partnerCode = 'P000';

          // yymm
          var now = new Date();
          var yy = String(now.getFullYear()).slice(-2);
          var mm = String(now.getMonth() + 1).padStart(2, '0');
          var prefix = partnerCode + yy + mm;

          // æ—¢å­˜ã®åŒãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹æœ€å¤§é€£ç•ªã‚’å–å¾—
          var maxSeq = 0;
          allItems.forEach(function(item) {
            if (item.itemId && item.itemId.startsWith(prefix)) {
              var seqPart = item.itemId.substring(prefix.length);
              var num = parseInt(seqPart, 10);
              if (!isNaN(num) && num > maxSeq) maxSeq = num;
            }
          });

          return prefix + String(maxSeq + 1).padStart(4, '0');
        }

        async function addItem(item) {
          const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
          console.log('[addItem] currentUser:', currentUser);
          console.log('[addItem] isDemoMode():', isDemoMode());
          
          if (!item.itemId) {
            item.itemId = generateItemNumber(item.assignedPartnerId);
          }
          item.createdAt = item.createdAt || new Date().toISOString();
          item.updatedAt = new Date().toISOString();
          item.companyCode = item.companyCode || currentUser.companyCode;
          item.officeCode = item.officeCode || currentUser.officeCode;
          
          if (isDemoMode()) {
            console.log('[addItem] DEMOãƒ¢ãƒ¼ãƒ‰ã§ä¿å­˜');
            const items = JSON.parse(sessionStorage.getItem('demo.items') || '[]');
            items.push(item);
            sessionStorage.setItem('demo.items', JSON.stringify(items));
            console.log('[addItem] ä¿å­˜å¾Œã®demo.items:', sessionStorage.getItem('demo.items'));
            return item;
          }
          console.log('[addItem] é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆlocalStorageã«ä¿å­˜ï¼‰');
          const items = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
          items.push(item);
          localStorage.setItem('onetouch.items', JSON.stringify(items));
          return item;
        }

        async function updateItem(item) {
          item.updatedAt = new Date().toISOString();
          if (isDemoMode()) {
            const items = JSON.parse(sessionStorage.getItem('demo.items') || '[]');
            const index = items.findIndex(i => i.itemId === item.itemId);
            if (index !== -1) {
              items[index] = item;
              sessionStorage.setItem('demo.items', JSON.stringify(items));
            }
            return item;
          }
          // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰
          const items = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
          const index = items.findIndex(i => i.itemId === item.itemId);
          if (index !== -1) {
            items[index] = item;
            localStorage.setItem('onetouch.items', JSON.stringify(items));
          }
          return item;
        }

        async function deleteItem(itemId) {
          if (isDemoMode()) {
            const items = JSON.parse(sessionStorage.getItem('demo.items') || '[]');
            const filtered = items.filter(i => i.itemId !== itemId);
            sessionStorage.setItem('demo.items', JSON.stringify(filtered));
            return true;
          }
          // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰
          const items = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
          const filtered = items.filter(i => i.itemId !== itemId);
          localStorage.setItem('onetouch.items', JSON.stringify(filtered));
          return true;
        }

        window.ItemStorage = { isDemoMode, initDemoItems, getItems, addItem, updateItem, deleteItem };

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        /* çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .unified-header {
            background: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .demo-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        .back-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .back-btn:hover {
            background: #f5f5f5;
            color: #1a1a1a;
        }

        .header-icon {
            font-size: 24px;
            line-height: 1;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            background: none;
            border: none;
        }

        .user-info-btn:hover {
            background: #f5f5f5;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #1a1a1a;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .user-name {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }


        /* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: 24px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 220px;
            display: none;
            z-index: 1000;
        }

        .dropdown-menu.show {
            display: block;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }

        .menu-item:hover {
            background: #f5f5f5;
        }

        .menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .menu-item.user-info-detail {
            cursor: default;
            background: #fafafa;
        }

        .menu-item.user-info-detail:hover {
            background: #fafafa;
        }

        .menu-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .menu-text {
            flex: 1;
        }

        .menu-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .menu-detail {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .menu-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 4px 0;
        }

        .menu-item.logout {
            color: #d32f2f;
        }

        .menu-item.logout:hover {
            background: #ffebee;
        }

        /* æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 24px;
        }

        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .search-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        h1 {
            font-size: 20px;
            color: #333;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: white;
            border: 1px solid #e0e0e0;
            color: #333;
        }

        .btn-primary:hover {
            background: #f5f5f5;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: white;
            border: 1px solid #e0e0e0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #f5f5f5;
        }

        .btn-save {
            background: #1a1a1a;
            color: white;
        }

        .btn-save:hover {
            background: #333;
        }

        .filters {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-label {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
        }

        .stats {
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 32px;
            align-items: center;
        }

        .stat-item {
            font-size: 14px;
            color: #666;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-left: 8px;
        }

        .items-grid {
            /* ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º */
        }

        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .items-table thead th {
            background: #f8f9fa;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }

        .items-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s;
        }

        .items-table tbody tr:hover {
            background: #fafafa;
        }

        .items-table td {
            padding: 10px 12px;
            color: #333;
            vertical-align: middle;
        }

        .items-table .col-name {
            font-weight: 600;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .items-table .col-price {
            font-weight: 600;
            color: #1a1a1a;
            text-align: right;
            white-space: nowrap;
        }

        .items-table .col-actions {
            white-space: nowrap;
            text-align: center;
        }

        .items-table .col-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            padding: 4px 6px;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .items-table .col-actions button:hover {
            background: #f0f0f0;
        }

        .badge-partner {
            display: inline-block;
            padding: 2px 6px;
            background: #e3f2fd;
            color: #1565c0;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .badge-category {
            display: inline-block;
            padding: 2px 6px;
            background: #f3e5f5;
            color: #7b1fa2;
            border-radius: 4px;
            font-size: 11px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .close-btn:hover {
            background: #f5f5f5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .form-label.required::after {
            content: " *";
            color: #e53935;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        @media (max-width: 768px) {
            .unified-header {
                padding: 12px 16px;
            }
            
            .header-title {
                font-size: 16px;
            }
            
            .user-name {
                display: none; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚¢ãƒã‚¿ãƒ¼ã®ã¿ */
            }
            
            .header-icon {
                font-size: 20px;
            }
            
            .dropdown-menu {
                right: 16px;
            }
            
            .header {
                padding: 12px 16px;
            }

            .container {
                padding: 16px;
            }

            .items-grid {
                /* ãƒ†ãƒ¼ãƒ–ãƒ«ã¯overflow-xã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
        }
        
        /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #1a1a1a;
        }
        
        .pagination-btn.active {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
            font-weight: 600;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
    <meta name="theme-color" content="#1a1a1a">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
</head>
<body>
    <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="unified-header">
        <div class="header-left">
            <button class="back-btn" onclick="goBack()">â† æˆ»ã‚‹</button>
            <span class="header-icon">ğŸ“¦</span>
            <h1 class="header-title">å•†å“ãƒã‚¹ã‚¿</h1>
        </div>
        <div class="header-center" id="demoModeBadge" style="display: none;">
            <span class="demo-badge">ğŸ”¥ DEMOãƒ¢ãƒ¼ãƒ‰</span>
        </div>
        <div class="header-right">
            <button class="user-info-btn" onclick="toggleUserMenu()">
                <div class="user-avatar" id="userAvatar">-</div>
                <span class="user-name" id="userName">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
            </button>
        </div>
    </div>

    <!-- ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="menu-item user-info-detail">
            <div class="menu-icon">ğŸ‘¤</div>
            <div class="menu-text">
                <div class="menu-name" id="menuUserName">ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
                <div class="menu-detail" id="menuUserDetail">-</div>
            </div>
        </div>
        <div class="menu-divider"></div>
        <a href="#" onclick="openPasswordChangeModal(); return false;" class="menu-item">
            <div class="menu-icon">ğŸ”‘</div>
            <span class="menu-text">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</span>
        </a>
        <div class="menu-divider"></div>
        <a href="#" onclick="logout(); return false;" class="menu-item logout">
            <div class="menu-icon">ğŸšª</div>
            <span class="menu-text">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
        </a>
    </div>

    <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ -->
    <div class="header">
        <div class="search-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="å•†å“åãƒ»å‹ç•ªãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ã§æ¤œç´¢" onkeypress="if(event.key==='Enter') applyFilters()">
            <button class="btn btn-primary" onclick="applyFilters()">æ¤œç´¢</button>
            <button class="btn btn-secondary" onclick="clearSearch()" style="margin-left: 4px;">ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="filters">
            <span class="filter-label">æ‹…å½“æ¥­è€…:</span>
            <select class="filter-select" id="partnerFilter" onchange="applyFilters()">
                <option value="">å…¨ã¦</option>
            </select>
            
            <div style="margin-left: auto; display: flex; gap: 8px;">
                <button class="btn btn-secondary" onclick="openImport()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <button class="btn btn-secondary" onclick="exportItems()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button class="btn btn-primary" onclick="openCreateModal()">æ–°è¦ç™»éŒ²</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- æ¤œç´¢å‰ã®ã‚¬ã‚¤ãƒ‰è¡¨ç¤º -->
        <div id="searchGuide" style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="margin-bottom: 16px; color: #ccc;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
            <div style="font-size: 16px; font-weight: 600; color: #666; margin-bottom: 8px;">æ¤œç´¢æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
            <div style="font-size: 13px;">å•†å“åãƒ»å‹ç•ªãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ã§æ¤œç´¢ã€ã¾ãŸã¯æ‹…å½“æ¥­è€…ãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ã§çµã‚Šè¾¼ã¿ã§ãã¾ã™</div>
            <button class="btn btn-primary" onclick="showAllItems()" style="margin-top: 20px; padding: 10px 24px;">å…¨ä»¶è¡¨ç¤º</button>
        </div>

        <!-- æ¤œç´¢çµæœã‚¨ãƒªã‚¢ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
        <div id="resultsSection" style="display: none;">
            <div class="stats">
                <div class="stat-item">
                    å…¨<span class="stat-value" id="totalCount">0</span>ä»¶
                </div>
                <div class="stat-item">
                    è¡¨ç¤ºä¸­<span class="stat-value" id="displayCount">0</span>ä»¶
                </div>
            </div>

            <div class="items-grid" id="itemsGrid"></div>
            
            <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div id="pagination" style="display: none; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; padding: 20px;"></div>
        </div>
    </div>

    <!-- æ–°è¦ç™»éŒ²/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">æ–°è¦å•†å“ç™»éŒ²</h2>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>

            <form id="itemForm" onsubmit="saveItem(event)">
                <!-- æ¥­è€…ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿è¡¨ç¤º: ç´å“å…ˆä¼šç¤¾é¸æŠ -->
                <div class="form-group" id="contractorCompanyGroup" style="display: none;">
                    <label class="form-label required">ç´å“å…ˆä¼šç¤¾</label>
                    <select class="form-input" id="itemDeliveryCompany">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                        â€» ã“ã®å•†å“ã‚’ç´å“ã™ã‚‹ä¼šç¤¾ã‚’é¸æŠã—ã¦ãã ã•ã„
                    </div>
                </div>
                
                <div class="form-group" id="itemNumberGroup" style="display: none;">
                    <label class="form-label">å•†å“No.</label>
                    <input type="text" class="form-input" id="itemNumberDisplay" readonly style="background: #f5f5f5; color: #666; font-family: monospace;">
                    <div style="font-size: 12px; color: #888; margin-top: 4px;">ä¿å­˜æ™‚ã«è‡ªå‹•æ¡ç•ªã•ã‚Œã¾ã™</div>
                </div>

                <div class="form-group">
                    <label class="form-label required">å•†å“å</label>
                    <input type="text" class="form-input" id="itemName" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">æ‹…å½“æ¥­è€…</label>
                    <select class="form-input" id="itemAssignedPartner" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                    <div style="font-size: 12px; color: #888; margin-top: 4px;">
                        â€» ãƒˆãƒ©ãƒ–ãƒ«æ™‚ã€ã“ã®æ¥­è€…ã«è‡ªå‹•ã§é€šçŸ¥ã•ã‚Œã¾ã™
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ãƒ¡ãƒ¼ã‚«ãƒ¼</label>
                        <input type="text" class="form-input" id="itemMaker">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å‹ç•ª</label>
                        <input type="text" class="form-input" id="itemModel">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å˜ä¾¡ï¼ˆå††ï¼‰</label>
                        <input type="number" class="form-input" id="itemPrice" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">åœ¨åº«æ•°</label>
                        <input type="number" class="form-input" id="itemStock" value="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å˜ä½</label>
                        <input type="text" class="form-input" id="itemUnit" value="å€‹">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆä»»æ„ï¼‰</label>
                        <select class="form-input" id="itemCategory">
                            <option value="">æœªè¨­å®š</option>
                            <option value="ç©ºèª¿">ç©ºèª¿</option>
                            <option value="çµ¦æ¹¯">çµ¦æ¹¯</option>
                            <option value="é›»æ°—">é›»æ°—</option>
                            <option value="æ°´é“">æ°´é“</option>
                            <option value="ã‚¬ã‚¹">ã‚¬ã‚¹</option>
                            <option value="è¨­å‚™">è¨­å‚™</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">å‚™è€ƒ</label>
                    <textarea class="form-textarea" id="itemDescription"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">çµ‚äº†æ—¥</label>
                    <input type="date" class="form-input" id="itemEndDate">
                </div>

                <input type="hidden" id="itemId">

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-save">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allItems = [];
        let filteredItems = [];
        let currentEditId = null;
        let currentPage = 1;
        const itemsPerPage = 50;

        // åˆæœŸåŒ–
        async function init() {
            await ItemStorage.initDemoItems();
            await loadItems();
            initUserInfo();
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
        function initUserInfo() {
            const userName = currentUser.userName || currentUser.name || currentUser.userId || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            const officeName = currentUser.officeName || '';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å
            document.getElementById('userName').textContent = userName;
            
            // ã‚¢ãƒã‚¿ãƒ¼ï¼ˆåå‰ã®æœ€åˆã®1æ–‡å­—ï¼‰
            document.getElementById('userAvatar').textContent = userName.charAt(0);
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
            document.getElementById('menuUserName').textContent = userName;
            document.getElementById('menuUserDetail').textContent = officeName || currentUser.companyName || '-';
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒˆã‚°ãƒ«
        function toggleUserMenu() {
            const menu = document.getElementById('dropdownMenu');
            menu.classList.toggle('show');
        }
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('dropdownMenu');
            const userBtn = document.querySelector('.user-info-btn');
            
            if (!menu.contains(event.target) && !userBtn.contains(event.target)) {
                menu.classList.remove('show');
            }
        });

        // æ¥­è€…ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        function loadPartners() {
            console.log('[loadPartners] é–‹å§‹');
            
            try {
                // æ¥­è€…ãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ
                if (currentUser.role === 'contractor') {
                    console.log('[loadPartners] æ¥­è€…ãƒ­ã‚°ã‚¤ãƒ³: è‡ªç¤¾ã®ã¿è¡¨ç¤º');
                    const currentContractor = JSON.parse(sessionStorage.getItem('currentContractor'));
                    
                    if (!currentContractor) {
                        console.error('[loadPartners] æ¥­è€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        return;
                    }
                    
                    const select = document.getElementById('itemAssignedPartner');
                    select.innerHTML = `<option value="${currentContractor.id}" data-partner-name="${currentContractor.name}" selected>${currentContractor.name}</option>`;
                    select.disabled = true; // æ¥­è€…ã¯å¤‰æ›´ã§ããªã„
                    
                    console.log('[loadPartners] æ¥­è€…ãƒ¢ãƒ¼ãƒ‰å®Œäº†:', currentContractor.name);
                    return;
                }
                
                let partners = [];
                try { partners = JSON.parse(sessionStorage.getItem('partners') || '[]'); } catch(e) {}
                let partnersLocal = [];
                try { partnersLocal = JSON.parse(localStorage.getItem('partners') || '[]'); } catch(e) {}
                partnersLocal.forEach(p => { if (!partners.find(m => m.id === p.id)) partners.push(p); });
                
                // DEMOãƒ¢ãƒ¼ãƒ‰ã§æ¥­è€…ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                if (partners.length === 0 && currentUser.companyCode === 'TAMJ') {
                    console.log('[loadPartners] DEMOãƒ¢ãƒ¼ãƒ‰: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¥­è€…ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
                    partners = [
                        {
                            id: 'PARTNER-001',
                            name: 'æ±äº¬è¨­å‚™å·¥æ¥­æ ªå¼ä¼šç¤¾',
                            partnerCode: 'P001',
                            categories: ['ç©ºèª¿', 'çµ¦æ¹¯', 'é›»æ°—'],
                            assignedCompanies: ['TAMJ'],
                            status: 'active'
                        },
                        {
                            id: 'PARTNER-002',
                            name: 'é–¢æ±æ°´é“ã‚µãƒ¼ãƒ“ã‚¹',
                            partnerCode: 'P002',
                            categories: ['æ°´é“', 'çµ¦æ¹¯', 'æ’æ°´'],
                            assignedCompanies: ['TAMJ'],
                            status: 'active'
                        },
                        {
                            id: 'PARTNER-003',
                            name: 'æ—¥æœ¬é›»æ°—å·¥äº‹',
                            partnerCode: 'P003',
                            categories: ['é›»æ°—', 'ç…§æ˜', 'è¨­å‚™'],
                            assignedCompanies: ['TAMJ'],
                            status: 'active'
                        }
                    ];
                }
                
                console.log('[loadPartners] partnersç·æ•°:', partners.length);
                
                // ç¾åœ¨ã®ä¼šç¤¾ã«ç´ä»˜ã„ã¦ã„ã‚‹æ¥­è€…ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                const filteredPartners = partners.filter(p => {
                    const companies = p.assignedCompanies || [];
                    const isAssigned = Array.isArray(companies) && companies.includes(currentUser.companyCode);
                    const sameCompany = p.companyCode === currentUser.companyCode;
                    const isActive = p.status !== 'inactive';
                    return (isAssigned || sameCompany) && isActive;
                });
                
                console.log('[loadPartners] ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®æ¥­è€…æ•°:', filteredPartners.length);
                
                // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ 
                const select = document.getElementById('itemAssignedPartner');
                select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                
                filteredPartners.forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    option.textContent = partner.name;
                    option.dataset.partnerName = partner.name;
                    select.appendChild(option);
                });
                
                console.log('[loadPartners] å®Œäº†');
            } catch (e) {
                console.error('[loadPartners] ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        // å•†å“èª­ã¿è¾¼ã¿
        async function loadItems(showResults = false) {
            console.log('[loadItems] é–‹å§‹, showResults:', showResults);
            console.log('[loadItems] isDemoMode:', ItemStorage.isDemoMode());
            console.log('[loadItems] sessionStorage demo.items:', sessionStorage.getItem('demo.items'));
            
            try {
                allItems = await ItemStorage.getItems();
                console.log('[loadItems] å–å¾—ã—ãŸå•†å“æ•°:', allItems.length);
                console.log('[loadItems] å•†å“ãƒªã‚¹ãƒˆ:', allItems);
                
                // DEMOãƒ¢ãƒ¼ãƒ‰ï¼ˆTAMJï¼‰ã§å•†å“ãŒ0ä»¶ã®å ´åˆã€ãƒ€ãƒŸãƒ¼å•†å“ã‚’è‡ªå‹•ç”Ÿæˆ
                if (allItems.length === 0 && currentUser?.companyCode === 'TAMJ') {
                    console.log('[loadItems] DEMOãƒ¢ãƒ¼ãƒ‰: ãƒ€ãƒŸãƒ¼å•†å“ã‚’è‡ªå‹•ç”Ÿæˆ');
                    const demoItems = [
                        {
                            itemId: 'P00125020001',
                            companyCode: 'TAMJ',
                            officeCode: 'TAMJ-J0001',
                            name: 'ã‚¨ã‚¢ã‚³ãƒ³ 1å·æ©Ÿ',
                            maker: 'ãƒ€ã‚¤ã‚­ãƒ³',
                            model: 'AN22XRS-W',
                            category: 'ç©ºèª¿',
                            assignedPartnerId: 'PARTNER-001',
                            assignedPartnerName: 'æ±äº¬è¨­å‚™å·¥æ¥­æ ªå¼ä¼šç¤¾',
                            unit: 'å°',
                            price: 150000,
                            stock: 1,
                            description: '2F ä¼šè­°å®¤ã«è¨­ç½®',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            itemId: 'P00125020002',
                            companyCode: 'TAMJ',
                            officeCode: 'TAMJ-J0001',
                            name: 'çµ¦æ¹¯å™¨ A',
                            maker: 'ãƒªãƒ³ãƒŠã‚¤',
                            model: 'RUX-A1615W-E',
                            category: 'çµ¦æ¹¯',
                            assignedPartnerId: 'PARTNER-001',
                            assignedPartnerName: 'æ±äº¬è¨­å‚™å·¥æ¥­æ ªå¼ä¼šç¤¾',
                            unit: 'å°',
                            price: 80000,
                            stock: 1,
                            description: '1F çµ¦æ¹¯å®¤',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            itemId: 'P00325020001',
                            companyCode: 'TAMJ',
                            officeCode: 'TAMJ-J0001',
                            name: 'ç…§æ˜å™¨å…· LED-01',
                            maker: 'ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯',
                            model: 'LGB51210',
                            category: 'é›»æ°—',
                            assignedPartnerId: 'PARTNER-003',
                            assignedPartnerName: 'æ—¥æœ¬é›»æ°—å·¥äº‹',
                            unit: 'å€‹',
                            price: 12000,
                            stock: 10,
                            description: 'å„ãƒ•ãƒ­ã‚¢å…±é€š',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            itemId: 'P00225020001',
                            companyCode: 'TAMJ',
                            officeCode: 'TAMJ-J0001',
                            name: 'ãƒˆã‚¤ãƒ¬ 1F',
                            maker: 'TOTO',
                            model: 'CES9788F',
                            category: 'æ°´é“',
                            assignedPartnerId: 'PARTNER-002',
                            assignedPartnerName: 'é–¢æ±æ°´é“ã‚µãƒ¼ãƒ“ã‚¹',
                            unit: 'å°',
                            price: 180000,
                            stock: 1,
                            description: '1F ç”·å­ãƒˆã‚¤ãƒ¬',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            itemId: 'P00125020003',
                            companyCode: 'TAMJ',
                            officeCode: 'TAMJ-J0001',
                            name: 'ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼',
                            maker: 'ä¸‰è±é›»æ©Ÿ',
                            model: 'NEXIEZ-MR',
                            category: 'è¨­å‚™',
                            assignedPartnerId: 'PARTNER-003',
                            assignedPartnerName: 'æ—¥æœ¬é›»æ°—å·¥äº‹',
                            unit: 'å°',
                            price: 5000000,
                            stock: 1,
                            description: '1F-5F',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        }
                    ];
                    
                    // sessionStorageã«ä¿å­˜
                    const storageKey = isDemoMode() ? 'demo.items' : 'items';
                    const storage = isDemoMode() ? sessionStorage : localStorage;
                    storage.setItem(storageKey, JSON.stringify(demoItems));
                    
                    allItems = demoItems;
                    console.log('[loadItems] ãƒ€ãƒŸãƒ¼å•†å“ã‚’ç”Ÿæˆãƒ»ä¿å­˜ã—ã¾ã—ãŸ:', allItems.length);
                }
                
                allItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                console.log('[loadItems] updateFilterså‘¼ã³å‡ºã—');
                updateFilters();
                if (showResults) {
                    console.log('[loadItems] applyFilterså‘¼ã³å‡ºã—ï¼ˆçµæœè¡¨ç¤ºï¼‰');
                    applyFilters();
                }
                console.log('[loadItems] å®Œäº†');
            } catch (e) {
                console.error('å•†å“èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                alert('å•†å“ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
        function updateFilters() {
            // æ‹…å½“æ¥­è€…
            const partners = [...new Set(allItems.map(item => item.assignedPartnerName).filter(Boolean))];
            const partnerFilter = document.getElementById('partnerFilter');
            partnerFilter.innerHTML = '<option value="">å…¨ã¦</option>' + 
                partners.map(p => `<option value="${p}">${p}</option>`).join('');
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function applyFilters() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const partnerFilter = document.getElementById('partnerFilter').value;

            filteredItems = allItems.filter(item => {
                // æ¥­è€…ãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ: è‡ªç¤¾ãŒæ‹…å½“ã—ã¦ã„ã‚‹å•†å“ã®ã¿è¡¨ç¤º
                if (currentUser.role === 'contractor') {
                    const currentContractor = JSON.parse(sessionStorage.getItem('currentContractor'));
                    if (currentContractor && item.assignedPartnerId !== currentContractor.id) {
                        return false;
                    }
                }
                
                // æ¤œç´¢
                const matchSearch = !searchQuery || 
                    (item.name && item.name.toLowerCase().includes(searchQuery)) ||
                    (item.model && item.model.toLowerCase().includes(searchQuery)) ||
                    (item.maker && item.maker.toLowerCase().includes(searchQuery));

                // æ‹…å½“æ¥­è€…
                const matchPartner = !partnerFilter || item.assignedPartnerName === partnerFilter;

                return matchSearch && matchPartner;
            });

            // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿æ™‚ã¯ãƒšãƒ¼ã‚¸ã‚’1ã«æˆ»ã™
            currentPage = 1;
            // æ¤œç´¢çµæœã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºã€ã‚¬ã‚¤ãƒ‰ã‚’éè¡¨ç¤º
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('searchGuide').style.display = 'none';
            renderItems();
        }

        // å…¨ä»¶è¡¨ç¤º
        function showAllItems() {
            document.getElementById('searchInput').value = '';
            document.getElementById('partnerFilter').value = '';
            
            applyFilters();
        }

        // æ¤œç´¢æ¡ä»¶ã‚¯ãƒªã‚¢ï¼ˆåˆæœŸçŠ¶æ…‹ã«æˆ»ã™ï¼‰
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('partnerFilter').value = '';
            
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('searchGuide').style.display = 'block';
        }

        // å•†å“è¡¨ç¤º
        function renderItems() {
            const grid = document.getElementById('itemsGrid');
            const totalCount = document.getElementById('totalCount');
            const displayCount = document.getElementById('displayCount');

            totalCount.textContent = allItems.length;
            displayCount.textContent = filteredItems.length;

            if (filteredItems.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = filteredItems.slice(startIndex, endIndex);

            console.log(`[renderItems] ãƒšãƒ¼ã‚¸ ${currentPage}/${totalPages}, è¡¨ç¤º: ${startIndex}-${endIndex} / å…¨${filteredItems.length}ä»¶`);

            grid.innerHTML = `
            <div class="table-container">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>å•†å“No.</th>
                            <th>å•†å“å</th>
                            <th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th>
                            <th>å‹ç•ª</th>
                            <th>æ‹…å½“æ¥­è€…</th>
                            <th>åœ¨åº«</th>
                            <th>å˜ä¾¡</th>
                            <th>ç·¨é›†</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageItems.map(item => `
                        <tr style="${item.endDate ? 'background: #f0f0f0; color: #aaa;' : ''}">
                            <td style="font-family: monospace; font-size: 12px; color: ${item.endDate ? '#ccc' : '#888'};">${item.itemId || '-'}</td>
                            <td class="col-name" title="${item.name || ''}">${item.name || '-'}${item.endDate ? ' <span style="font-size:11px;color:#bbb;">ï¼ˆçµ‚äº†ï¼‰</span>' : ''}</td>
                            <td>${item.maker || '-'}</td>
                            <td>${item.model || '-'}</td>
                            <td>${item.assignedPartnerName ? `<span class="badge-partner" title="${item.assignedPartnerName}" style="${item.endDate ? 'opacity:0.5;' : ''}">${item.assignedPartnerName}</span>` : '-'}</td>
                            <td>${item.stock || 0} ${item.unit || 'å€‹'}</td>
                            <td class="col-price">Â¥${(item.price || 0).toLocaleString()}</td>
                            <td class="col-actions">
                                <button onclick="editItem('${item.itemId}')" title="ç·¨é›†">ç·¨é›†</button>
                            </td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
            
            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
            renderPagination(totalPages);
        }
        
        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            let html = '';
            
            // å‰ã¸ãƒœã‚¿ãƒ³
            html += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">â† å‰ã¸</button>`;
            
            // ãƒšãƒ¼ã‚¸ç•ªå·
            html += '<div style="display: flex; gap: 4px;">';
            
            // æœ€åˆã®ãƒšãƒ¼ã‚¸
            if (currentPage > 3) {
                html += `<button class="pagination-btn" onclick="changePage(1)">1</button>`;
                if (currentPage > 4) {
                    html += '<span style="padding: 8px;">...</span>';
                }
            }
            
            // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸å‘¨è¾º
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }
            
            // æœ€å¾Œã®ãƒšãƒ¼ã‚¸
            if (currentPage < totalPages - 2) {
                if (currentPage < totalPages - 3) {
                    html += '<span style="padding: 8px;">...</span>';
                }
                html += `<button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }
            
            html += '</div>';
            
            // æ¬¡ã¸ãƒœã‚¿ãƒ³
            html += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">æ¬¡ã¸ â†’</button>`;
            
            pagination.innerHTML = html;
        }
        
        // ãƒšãƒ¼ã‚¸å¤‰æ›´
        function changePage(page) {
            currentPage = page;
            renderItems();
            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.querySelector('.header').scrollIntoView({ behavior: 'smooth' });
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        }

        // æ¤œç´¢
        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ãï¼ˆæ–°è¦ï¼‰
        function openCreateModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'æ–°è¦å•†å“ç™»éŒ²';
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('itemNumberGroup').style.display = 'none';
            loadPartners(); // æ¥­è€…ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
            
            // æ¥­è€…ãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã€ç´å“å…ˆä¼šç¤¾ã‚’é¸æŠ
            if (currentUser.role === 'contractor') {
                const currentContractor = JSON.parse(sessionStorage.getItem('currentContractor'));
                const companyGroup = document.getElementById('contractorCompanyGroup');
                companyGroup.style.display = 'block';
                
                // å¥‘ç´„ä¼šç¤¾ä¸€è¦§ã‚’è¡¨ç¤º
                const select = document.getElementById('itemDeliveryCompany');
                select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                
                if (currentContractor && currentContractor.assignedCompanies) {
                    // ä¼šç¤¾ãƒã‚¹ã‚¿ã‚’å–å¾—
                    let companies = [];
                    try { companies = JSON.parse(sessionStorage.getItem('companies') || '[]'); } catch(e) {}
                    try { var cl = JSON.parse(localStorage.getItem('companies') || '[]'); cl.forEach(function(c){ if(!companies.find(function(m){return m.companyCode===c.companyCode;})) companies.push(c); }); } catch(e) {}
                    
                    currentContractor.assignedCompanies.forEach(companyCode => {
                        const company = companies.find(c => c.companyCode === companyCode);
                        const companyName = company ? company.companyName : companyCode;
                        
                        const option = document.createElement('option');
                        option.value = companyCode;
                        option.textContent = companyName;
                        select.appendChild(option);
                    });
                    
                    // 1ç¤¾ã®ã¿ãªã‚‰è‡ªå‹•é¸æŠ
                    if (currentContractor.assignedCompanies.length === 1) {
                        select.value = currentContractor.assignedCompanies[0];
                    }
                }
            } else {
                document.getElementById('contractorCompanyGroup').style.display = 'none';
            }
            
            document.getElementById('itemModal').classList.add('show');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ãï¼ˆç·¨é›†ï¼‰
        function editItem(itemId) {
            const item = allItems.find(i => i.itemId === itemId);
            if (!item) return;

            loadPartners(); // æ¥­è€…ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
            
            currentEditId = itemId;
            document.getElementById('modalTitle').textContent = 'å•†å“ç·¨é›†';
            document.getElementById('itemId').value = item.itemId;
            document.getElementById('itemNumberGroup').style.display = 'block';
            document.getElementById('itemNumberDisplay').value = item.itemId || '';
            document.getElementById('itemName').value = item.name || '';
            document.getElementById('itemMaker').value = item.maker || '';
            document.getElementById('itemModel').value = item.model || '';
            document.getElementById('itemCategory').value = item.category || '';
            document.getElementById('itemAssignedPartner').value = item.assignedPartnerId || '';
            document.getElementById('itemUnit').value = item.unit || 'å€‹';
            document.getElementById('itemPrice').value = item.price || 0;
            document.getElementById('itemStock').value = item.stock || 0;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemEndDate').value = item.endDate || '';

            document.getElementById('itemModal').classList.add('show');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('itemModal').classList.remove('show');
        }

        // ä¿å­˜
        // ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
        function logItemEvent(type, detail) {
            try {
                var logs = JSON.parse(demoGetFromLocalStorage('audit.logs') || '[]');
                logs.push({
                    timestamp: new Date().toISOString(),
                    type: type,
                    screen: 'items',
                    user: currentUser?.name || '',
                    userId: currentUser?.userId || currentUser?.id || '',
                    companyCode: currentUser?.companyCode || '',
                    details: typeof detail === 'string' ? detail : JSON.stringify(detail)
                });
                demoSaveToLocalStorage('audit.logs', JSON.stringify(logs));
            } catch(e) { console.error('ç›£æŸ»ãƒ­ã‚°ã‚¨ãƒ©ãƒ¼:', e); }
        }

        async function saveItem(e) {
            e.preventDefault();
            console.log('[saveItem] é–‹å§‹');

            // currentUserã‚’å–å¾—ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—å•é¡Œå¯¾ç­–ï¼‰
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            console.log('[saveItem] currentUser:', currentUser);
            
            if (!currentUser) {
                alert('ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const partnerSelect = document.getElementById('itemAssignedPartner');
            const selectedOption = partnerSelect.options[partnerSelect.selectedIndex];
            
            // æ¥­è€…ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ç´å“å…ˆä¼šç¤¾ã‚’ä½¿ç”¨
            let companyCode = currentUser.companyCode;
            let officeCode = currentUser.officeCode;
            
            if (currentUser.role === 'contractor') {
                const deliveryCompany = document.getElementById('itemDeliveryCompany').value;
                if (!deliveryCompany) {
                    alert('ç´å“å…ˆä¼šç¤¾ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                companyCode = deliveryCompany;
                // æ¥­è€…ãŒç™»éŒ²ã™ã‚‹å ´åˆã€äº‹æ¥­æ‰€ã¯æœªè¨­å®š
                officeCode = '';
            }
            
            const item = {
                itemId: document.getElementById('itemId').value || null,
                companyCode: companyCode,
                officeCode: officeCode,
                name: document.getElementById('itemName').value,
                maker: document.getElementById('itemMaker').value,
                model: document.getElementById('itemModel').value,
                category: document.getElementById('itemCategory').value,
                assignedPartnerId: partnerSelect.value,
                assignedPartnerName: selectedOption.dataset.partnerName || selectedOption.textContent || '',
                unit: document.getElementById('itemUnit').value,
                price: parseFloat(document.getElementById('itemPrice').value) || 0,
                stock: parseFloat(document.getElementById('itemStock').value) || 0,
                description: document.getElementById('itemDescription').value,
                endDate: document.getElementById('itemEndDate').value
            };
            
            console.log('[saveItem] item:', item);

            try {
                if (currentEditId) {
                    // æ›´æ–°æ™‚: æ¥­è€…å¤‰æ›´å±¥æ­´ã‚’è¨˜éŒ²
                    const oldItem = allItems.find(i => i.itemId === currentEditId);
                    
                    if (oldItem && oldItem.assignedPartnerId !== item.assignedPartnerId) {
                        console.log('[saveItem] æ¥­è€…å¤‰æ›´ã‚’æ¤œå‡º');
                        
                        // æ¥­è€…å¤‰æ›´å±¥æ­´ã‚’åˆæœŸåŒ–ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
                        if (!item.partnerHistory) {
                            item.partnerHistory = oldItem.partnerHistory || [];
                        }
                        
                        // å¤‰æ›´å±¥æ­´ã‚’è¿½åŠ 
                        item.partnerHistory.push({
                            changedAt: new Date().toISOString(),
                            changedBy: currentUser.userId || currentUser.id,
                            changedByName: currentUser.userName || currentUser.name,
                            oldPartnerId: oldItem.assignedPartnerId,
                            oldPartnerName: oldItem.assignedPartnerName,
                            newPartnerId: item.assignedPartnerId,
                            newPartnerName: item.assignedPartnerName
                        });
                        
                        console.log('[saveItem] æ¥­è€…å¤‰æ›´å±¥æ­´ã‚’è¿½åŠ :', item.partnerHistory);
                    } else {
                        // æ¥­è€…å¤‰æ›´ãŒãªã„å ´åˆã¯æ—¢å­˜ã®å±¥æ­´ã‚’ä¿æŒ
                        item.partnerHistory = oldItem?.partnerHistory || [];
                    }
                    
                    // æ›´æ–°è€…æƒ…å ±ã‚’è¿½åŠ 
                    item.updatedBy = currentUser.userId || currentUser.id;
                    item.updatedByRole = currentUser.role;
                    item.updatedAt = new Date().toISOString();
                    
                    console.log('[saveItem] æ›´æ–°ãƒ¢ãƒ¼ãƒ‰');
                    await ItemStorage.updateItem(item);
                    logItemEvent('update_item', { itemId: item.itemId, itemName: item.name });
                    alert('å•†å“ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                } else {
                    // æ–°è¦ç™»éŒ²: ç™»éŒ²è€…æƒ…å ±ã‚’è¿½åŠ 
                    item.createdBy = currentUser.userId || currentUser.id;
                    item.createdByRole = currentUser.role;
                    item.createdAt = new Date().toISOString();
                    item.updatedAt = new Date().toISOString();
                    item.partnerHistory = []; // å±¥æ­´ã‚’åˆæœŸåŒ–
                    
                    console.log('[saveItem] æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰');
                    await ItemStorage.addItem(item);
                    logItemEvent('add_item', { itemId: item.itemId, itemName: item.name });
                    console.log('[saveItem] addItemå®Œäº†');
                    alert('å•†å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                }

                console.log('[saveItem] closeModalå‘¼ã³å‡ºã—');
                closeModal();
                console.log('[saveItem] loadItemså‘¼ã³å‡ºã—');
                await loadItems(true);
                console.log('[saveItem] å®Œäº†');
            } catch (e) {
                console.error('[saveItem] ã‚¨ãƒ©ãƒ¼:', e);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n\n' + e.message + '\n\n' + e.stack);
            }
        }

        // å‰Šé™¤
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportItems() {
            if (ItemStorage.isDemoMode()) {
                alert('DEMOãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã¾ã›ã‚“');
                return;
            }

            const csv = [
                ['å•†å“No.', 'å•†å“å', 'æ‹…å½“æ¥­è€…', 'ãƒ¡ãƒ¼ã‚«ãƒ¼', 'å‹ç•ª', 'ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'å˜ä¾¡', 'åœ¨åº«', 'å˜ä½', 'å‚™è€ƒ', 'çµ‚äº†æ—¥', 'ç™»éŒ²æ—¥', 'æ›´æ–°æ—¥'].join(','),
                ...allItems.map(item => [
                    item.itemId || '',
                    item.name || '',
                    item.assignedPartnerName || '',
                    item.maker || '',
                    item.model || '',
                    item.category || '',
                    item.price || 0,
                    item.stock || 0,
                    item.unit || 'å€‹',
                    item.description || '',
                    item.endDate || '',
                    formatDate(item.createdAt),
                    formatDate(item.updatedAt)
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `items-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function openImport() {
            window.location.href = 'import.html';
        }

        // æˆ»ã‚‹
        // æˆ»ã‚‹ï¼ˆãƒ­ãƒ¼ãƒ«ã«å¿œã˜ãŸãƒ›ãƒ¼ãƒ ã«é·ç§»ï¼‰
        function goBack() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                
                if (!currentUser || !currentUser.role) {
                    window.location.href = 'login.html';
                    return;
                }

                // ãƒ­ãƒ¼ãƒ«åˆ¥ã®ãƒ›ãƒ¼ãƒ ç”»é¢
                const homePages = {
                    'system_admin': 'system-admin.html',
                    'company_admin': 'master-top.html',
                    'office_admin': 'master-top.html',
                    'staff': 'report.html',
                    'contractor': 'contractor-dashboard.html'
                };

                const homePage = homePages[currentUser.role] || 'master-top.html';
                window.location.href = homePage;
            } catch (e) {
                console.error('goBack error:', e);
                window.location.href = 'master-top.html';
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                sessionStorage.clear();
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }
        
        // åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒãƒŠãƒ¼è¡¨ç¤º
        function showFirstLoginBanner() {
            if (currentUser && currentUser.isFirstLogin && !sessionStorage.getItem('firstLoginBannerDismissed')) {
                document.getElementById('firstLoginBanner').style.display = 'block';
            }
        }
        
        // åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒãƒŠãƒ¼ã‚’é–‰ã˜ã‚‹
        function dismissFirstLoginBanner() {
            document.getElementById('firstLoginBanner').style.display = 'none';
            sessionStorage.setItem('firstLoginBannerDismissed', 'true');
        }
        
        // ãƒãƒŠãƒ¼ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openPasswordChangeFromBanner() {
            dismissFirstLoginBanner();
            openPasswordChangeModal();
        }
        
        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
        
        // DEMOãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
        if (currentUser && currentUser.companyCode === 'TAMJ') {
            document.getElementById('demoModeBadge').style.display = 'block';
        }
        
        // åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒãƒŠãƒ¼è¡¨ç¤º
        showFirstLoginBanner();
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openPasswordChangeModal() {
            document.getElementById('passwordChangeModal').style.display = 'flex';
            document.getElementById('dropdownMenu').classList.remove('show');
        }
        
        function closePasswordChangeModal() {
            document.getElementById('passwordChangeModal').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç¢ºèª
            if (newPassword !== confirmPassword) {
                alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚');
                return;
            }
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®é•·ã•ãƒã‚§ãƒƒã‚¯
            if (newPassword.length < 6) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
            if (currentUser.password !== currentPassword) {
                alert('ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
            try {
                const isDemoMode = currentUser.companyCode === 'TAMJ';
                
                if (isDemoMode) {
                    // DEMOãƒ¢ãƒ¼ãƒ‰: currentUserã®ã¿æ›´æ–°ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã¿æœ‰åŠ¹ï¼‰
                    currentUser.password = newPassword;
                    currentUser.isFirstLogin = false;  // åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ©ã‚°ã‚’falseã«
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚\nâ€» DEMOãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã¯å…ƒã«æˆ»ã‚Šã¾ã™ã€‚');
                    closePasswordChangeModal();
                } else {
                    // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰: localStorageã®accountsã‚’æ›´æ–°
                    let accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                    const accountIndex = accounts.findIndex(a => a.userId === currentUser.userId);
                    
                    if (accountIndex !== -1) {
                        accounts[accountIndex].password = newPassword;
                        accounts[accountIndex].isFirstLogin = false;  // åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ©ã‚°ã‚’falseã«
                        accounts[accountIndex].passwordChangedAt = new Date().toISOString();
                        localStorage.setItem('accounts', JSON.stringify(accounts));
                        
                        // currentUserã‚‚æ›´æ–°
                        currentUser.password = newPassword;
                        currentUser.isFirstLogin = false;
                        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                        
                        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚');
                        closePasswordChangeModal();
                    } else {
                        alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                }
            } catch (e) {
                console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', e);
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }
    </script>
    
    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="passwordChangeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 400px; box-shadow: 0 8px 24px rgba(0,0,0,0.2);">
            <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #333;">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 14px; color: #666; margin-bottom: 6px;">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="currentPassword" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 14px; color: #666; margin-bottom: 6px;">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="newPassword" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
                <div style="font-size: 12px; color: #666; margin-top: 4px;">â€» 6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
            </div>
            
            <div style="margin-bottom: 24px;">
                <label style="display: block; font-size: 14px; color: #666; margin-bottom: 6px;">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                <input type="password" id="confirmPassword" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closePasswordChangeModal()" style="padding: 10px 20px; background: #f5f5f5; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; color: #666;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="changePassword()" style="padding: 10px 20px; background: #1a1a1a; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; color: white;">å¤‰æ›´ã™ã‚‹</button>
            </div>
        </div>
    </div>
    
    <!-- åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ¨å¥¨ãƒãƒŠãƒ¼ -->
    <div id="firstLoginBanner" style="display: none; position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); z-index: 9999; max-width: 500px; width: 90%;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="font-size: 32px;">ğŸ”</div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’ãŠã™ã™ã‚ã—ã¾ã™</div>
                <div style="font-size: 13px; opacity: 0.9;">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šã®ãŸã‚ã€åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</div>
            </div>
            <button onclick="dismissFirstLoginBanner()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 20px; line-height: 1;">Ã—</button>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button onclick="openPasswordChangeFromBanner()" style="flex: 1; padding: 8px 16px; background: white; color: #1a1a1a; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">ä»Šã™ãå¤‰æ›´</button>
            <button onclick="dismissFirstLoginBanner()" style="flex: 1; padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">å¾Œã§å¤‰æ›´</button>
        </div>
    </div>
</body>
</html>
