<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ | ãƒã‚¹ã‚¿ç®¡ç†</title>
  <meta name="theme-color" content="#1a1a1a">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- æ–°ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    // item-storage.js ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã¿ï¼ˆfile:// ãƒ—ãƒ­ãƒˆã‚³ãƒ«å¯¾å¿œï¼‰
    const DB_NAME = 'OneTouchDB';
    const DB_VERSION = 1;
    let db = null;

    async function openDB() {
      return new Promise((resolve, reject) => {
        if (db) return resolve(db);
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => { db = request.result; resolve(db); };
        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          if (!database.objectStoreNames.contains('items')) {
            const itemStore = database.createObjectStore('items', { keyPath: 'itemId' });
            itemStore.createIndex('companyCode', 'companyCode', { unique: false });
            itemStore.createIndex('officeCode', 'officeCode', { unique: false });
          }
        };
      });
    }

    function isDemoMode() {
      try {
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        return currentUser && currentUser.companyCode === 'TAMJ';
      } catch (e) { return false; }
    }

    async function initDemoItems() {
      if (!isDemoMode() || sessionStorage.getItem('demo.items')) return;
      sessionStorage.setItem('demo.items', JSON.stringify([]));
    }

    async function getItems() {
      const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
      if (!currentUser) return [];
      if (isDemoMode()) {
        return JSON.parse(sessionStorage.getItem('demo.items') || '[]');
      }
      // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰: localStorageã‹ã‚‰å–å¾—ï¼ˆscopeåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
      const allItems = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
      if (currentUser.role === 'system_admin') return allItems;
      if (currentUser.role === 'company_admin') return allItems.filter(i => i.companyCode === currentUser.companyCode);
      return allItems.filter(i => i.officeCode === currentUser.officeCode);
    }

    async function addItem(item) {
      const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
      if (!item.itemId) {
        const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
        const random = Math.random().toString(36).substring(2, 6).toUpperCase();
        item.itemId = `ITEM-${dateStr}-${random}`;
      }
      item.createdAt = item.createdAt || new Date().toISOString();
      item.updatedAt = new Date().toISOString();
      item.companyCode = item.companyCode || currentUser.companyCode;
      item.officeCode = item.officeCode || currentUser.officeCode;
      
      if (isDemoMode()) {
        const items = JSON.parse(sessionStorage.getItem('demo.items') || '[]');
        items.push(item);
        sessionStorage.setItem('demo.items', JSON.stringify(items));
        return item;
      }
      // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰: localStorageã«ä¿å­˜
      const items = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
      items.push(item);
      localStorage.setItem('onetouch.items', JSON.stringify(items));
      return item;
    }

    async function updateItem(item) {
      item.updatedAt = new Date().toISOString();
      if (isDemoMode()) {
        const items = JSON.parse(sessionStorage.getItem('demo.items') || '[]');
        const index = items.findIndex(i => i.itemId === item.itemId);
        if (index !== -1) {
          items[index] = item;
          sessionStorage.setItem('demo.items', JSON.stringify(items));
        }
        return item;
      }
      // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰: localStorageã«ä¿å­˜
      const items = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
      items.push(item);
      localStorage.setItem('onetouch.items', JSON.stringify(items));
      return item;
    }

    async function deleteItem(itemId) {
      if (isDemoMode()) {
        const items = JSON.parse(sessionStorage.getItem('demo.items') || '[]');
        const filtered = items.filter(i => i.itemId !== itemId);
        sessionStorage.setItem('demo.items', JSON.stringify(filtered));
        return true;
      }
      // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰: localStorageã‹ã‚‰å‰Šé™¤
      const items3 = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
      const filtered2 = items3.filter(i => i.itemId !== itemId);
      localStorage.setItem('onetouch.items', JSON.stringify(filtered2));
      return true;
    }

    window.ItemStorage = { isDemoMode, initDemoItems, getItems, addItem, updateItem, deleteItem };
  </script>
  <script src="upload-limits.js"></script>
  <script src="csv-utils.js"></script>
  <script src="document-storage.js"></script>
  <!-- Tesseract.js å‰Šé™¤: OCRå‡¦ç†ã¯ã‚µãƒ¼ãƒå´ GCP Vision API ã§å®Ÿè¡Œ -->
  <style>
    :root{--bg:#fff;--bg2:#f8f9fa;--text:#1a1a1a;--muted:#666;--accent:#1a1a1a;--yellow:#E9A825;--border:#e5e7eb;--ok:#10b981;--err:#ef4444;--warn:#f59e0b;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Noto Sans JP',sans-serif;background:var(--bg2);min-height:100vh;}
    .topnav{display:flex;align-items:center;justify-content:flex-end;padding:6px 16px;background:var(--bg2);border-bottom:1px solid var(--border);gap:8px;}
    .topnav a,.topnav button{color:var(--muted);text-decoration:none;font-size:12px;padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg);cursor:pointer;font-family:inherit;}
    .topnav button.out{color:var(--accent);border-color:rgba(155,35,53,.2);}
    .hdr{background:var(--bg);padding:14px 20px;display:flex;align-items:center;gap:14px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;}
    .back{background:none;border:none;padding:6px;cursor:pointer;border-radius:8px;display:flex;}
    .back:hover{background:var(--bg2);}
    .back svg{width:24px;height:24px;color:var(--text);}
    .hdr h1{font-size:1.1rem;font-weight:600;flex:1;}
    .hdr-user{font-size:0.8rem;color:var(--muted);background:var(--bg2);padding:4px 10px;border-radius:6px;}
    .wrap{max-width:640px;margin:0 auto;padding:20px;}

    .steps-bar{display:flex;gap:4px;margin-bottom:20px;}
    .step-dot{flex:1;height:4px;border-radius:2px;background:var(--border);}
    .step-dot.active{background:var(--yellow);}
    .step-dot.done{background:var(--ok);}

    .drop{background:var(--bg);border:2px dashed var(--border);border-radius:16px;padding:48px 24px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:16px;}
    .drop:hover,.drop.over{border-color:var(--yellow);background:#fffbf0;}
    .drop.off{opacity:.5;pointer-events:none;}
    .drop input{display:none;}
    .drop-icon{width:64px;height:64px;margin:0 auto 16px;background:linear-gradient(135deg,#fff8e6,#fffbf0);border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid var(--yellow);}
    .drop-icon svg{width:32px;height:32px;color:var(--yellow);}
    .drop h3{font-size:1rem;font-weight:600;margin-bottom:6px;}
    .drop p{font-size:0.85rem;color:var(--muted);}
    .ftypes{display:flex;justify-content:center;gap:10px;margin-top:14px;flex-wrap:wrap;}
    .ftype{font-size:0.75rem;color:var(--muted);padding:4px 10px;background:var(--bg2);border-radius:6px;}
    .enc-row{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px;font-size:0.8rem;color:var(--muted);}
    .enc-row select{padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:0.8rem;}

    .fcard{background:var(--bg);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:14px;}
    .fcard.ok{border-color:var(--ok);}
    .fcard.err{border-color:var(--err);background:#fef2f2;}
    .fcard-top{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
    .fcard-icon{font-size:28px;flex-shrink:0;}
    .fcard-info{flex:1;min-width:0;}
    .fcard-name{font-size:0.9rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .fcard-meta{font-size:0.78rem;color:var(--muted);margin-top:2px;}
    .fcard-badge{font-size:0.78rem;padding:3px 10px;border-radius:99px;font-weight:600;flex-shrink:0;}
    .fcard-badge.parsing{background:#fef3c7;color:#d97706;}
    .fcard-badge.ready{background:#dbeafe;color:#2563eb;}
    .fcard-badge.ok{background:#d1fae5;color:#059669;}
    .fcard-badge.err{background:#fee2e2;color:#dc2626;}
    .fcard-stats{display:flex;gap:14px;flex-wrap:wrap;margin:10px 0;font-size:0.82rem;}
    .fcard-stat{display:flex;align-items:center;gap:4px;}
    .fcard-stat .dot{width:8px;height:8px;border-radius:50%;}
    .fcard-btns{display:flex;gap:8px;margin-top:12px;}
    .btn{border:none;border-radius:10px;padding:10px 18px;font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all .15s;}
    .btn-main{background:linear-gradient(135deg,var(--accent),#333);color:#fff;box-shadow:0 4px 12px rgba(155,35,53,.25);}
    .btn-main:hover{transform:translateY(-1px);}
    .btn-sub{background:var(--bg2);color:var(--text);border:1px solid var(--border);}
    .btn-sub:hover{border-color:var(--yellow);}
    .btn-ok{background:var(--ok);color:#fff;}
    .spin{width:14px;height:14px;border:2px solid currentColor;border-top-color:transparent;border-radius:50%;animation:sp .8s linear infinite;display:inline-block;vertical-align:middle;margin-right:4px;}
    @keyframes sp{to{transform:rotate(360deg)}}

    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .mov{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:1000;overflow-y:auto;}
    .mov.open{display:block;}
    .mmod{max-width:720px;margin:20px auto;background:var(--bg);border-radius:16px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);position:relative;}
    .mmod h2{font-size:1.1rem;font-weight:700;margin-bottom:4px;}
    .msub{font-size:0.82rem;color:var(--muted);margin-bottom:16px;}
    .mtabs{display:flex;gap:0;border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:16px;}
    .mtab{flex:1;padding:10px 8px;text-align:center;font-size:0.82rem;font-weight:600;cursor:pointer;background:var(--bg);border:none;font-family:inherit;color:var(--muted);}
    .mtab.active{background:var(--yellow);color:#fff;}
    .mpanel{display:none;}
    .mpanel.show{display:block;}
    .mrow{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.82rem;}
    .mrow:last-child{border-bottom:none;}
    .mcol{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;}
    .marr{color:var(--muted);flex-shrink:0;font-size:0.8rem;}
    .msel select{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:0.82rem;}
    .msel{flex:1.2;}
    .msam{font-size:0.72rem;color:var(--muted);flex:0 0 90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .mb-auto{font-size:0.78rem;padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;font-family:inherit;color:var(--text);}
    .mb-auto:hover{border-color:var(--yellow);}
    .rule{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);font-size:0.85rem;}
    .rule:last-child{border-bottom:none;}
    .rule input[type=checkbox]{width:18px;height:18px;accent-color:var(--yellow);flex-shrink:0;}
    .rule-text{flex:1;}
    .rule-count{font-size:0.75rem;color:var(--muted);flex-shrink:0;min-width:40px;text-align:right;}
    .pvwrap{overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid var(--border);border-radius:10px;max-height:400px;overflow-y:auto;}
    .pvwrap table{border-collapse:collapse;width:100%;min-width:500px;font-size:0.78rem;}
    .pvwrap th{background:var(--bg2);padding:6px 8px;text-align:left;font-weight:600;border-bottom:2px solid var(--border);white-space:nowrap;position:sticky;top:0;z-index:1;}
    .pvwrap td{padding:5px 8px;border-bottom:1px solid #f3f4f6;white-space:nowrap;max-width:150px;overflow:hidden;text-overflow:ellipsis;}
    .pvwrap tr.excluded{opacity:.35;text-decoration:line-through;}
    .pvwrap tr:hover{background:#fffbf0;}
    .pvwrap input[type=checkbox]{width:16px;height:16px;accent-color:var(--yellow);}
    .mfoot{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:16px;padding-top:16px;border-top:2px solid var(--border);flex-wrap:wrap;}
    .mfoot-stats{font-size:0.82rem;color:var(--muted);display:flex;gap:12px;flex-wrap:wrap;}
    .mfoot-stats b{color:var(--text);}
    .mfoot-btns{display:flex;gap:8px;}
    .msave{display:flex;align-items:center;gap:6px;font-size:0.78rem;color:var(--muted);margin-top:8px;}
    .msave input{width:14px;height:14px;}
    .result-card{background:var(--bg);border:2px solid var(--ok);border-radius:14px;padding:24px;text-align:center;margin-top:16px;}
    .result-card h3{font-size:1.1rem;font-weight:700;color:var(--ok);margin-bottom:8px;}
    .result-card .nums{display:flex;gap:16px;justify-content:center;margin:12px 0;font-size:0.85rem;}
    .result-card .nums span{display:flex;align-items:center;gap:4px;}
    .help{margin-top:32px;padding-top:24px;border-top:1px solid var(--border);}
    .help h3{font-size:0.9rem;font-weight:600;margin-bottom:14px;}
    .hgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;}
    .hcard{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;}
    .hcard h4{font-size:0.8rem;font-weight:600;margin-bottom:4px;}
    .hcard p{font-size:0.7rem;color:var(--muted);}

    /* ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
    .hdr-picker-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:1100;overflow-y:auto;}
    .hdr-picker-overlay.open{display:block;}
    .hdr-picker-modal{max-width:860px;margin:20px auto;background:var(--bg);border-radius:16px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);}
    .hdr-picker-modal h2{font-size:1.05rem;font-weight:700;margin-bottom:4px;}
    .hdr-picker-modal .sub{font-size:0.82rem;color:var(--muted);margin-bottom:12px;}
    .hdr-cands{margin-bottom:16px;}
    .hdr-cand{display:flex;align-items:center;gap:10px;padding:10px 12px;border:2px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:all .15s;font-size:0.82rem;}
    .hdr-cand:hover{border-color:var(--yellow);background:#fffbf0;}
    .hdr-cand.selected{border-color:var(--yellow);background:#fffbf0;box-shadow:0 0 0 3px rgba(233,168,37,.15);}
    .hdr-cand-rank{background:var(--yellow);color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75rem;flex-shrink:0;}
    .hdr-cand-cells{flex:1;display:flex;gap:6px;flex-wrap:wrap;min-width:0;}
    .hdr-cand-cell{background:var(--bg2);padding:2px 8px;border-radius:4px;font-size:0.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:120px;}
    .hdr-cand-cell.match{background:#d1fae5;color:#059669;font-weight:600;}
    .hdr-cand-score{font-size:0.72rem;color:var(--muted);flex-shrink:0;min-width:50px;text-align:right;}

    /*  ãƒ”ãƒƒã‚«ãƒ¼ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .pk-toolbar{display:flex;gap:6px;margin:12px 0;flex-wrap:wrap;}
    .pk-mode{padding:7px 14px;border:2px solid var(--border);border-radius:8px;background:var(--bg);font-size:0.78rem;font-weight:600;cursor:pointer;transition:all .15s;font-family:inherit;display:flex;align-items:center;gap:5px;}
    .pk-mode:hover{border-color:var(--yellow);background:#fffbf0;}
    .pk-mode.active{border-color:var(--yellow);background:#fef3c7;box-shadow:0 0 0 2px rgba(233,168,37,.2);}
    .pk-mode .pk-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
    .pk-mode-hint{font-size:0.75rem;color:var(--muted);margin-bottom:8px;padding:8px 12px;background:var(--bg2);border-radius:8px;border-left:3px solid var(--yellow);}

    /*  è¨­å®šã‚µãƒãƒªãƒ¼ */
    .pk-summary{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0;font-size:0.78rem;}
    .pk-sum-item{padding:5px 10px;border-radius:6px;display:flex;align-items:center;gap:5px;}
    .pk-sum-item.set{background:#d1fae5;color:#059669;}
    .pk-sum-item.unset{background:var(--bg2);color:var(--muted);}

    /*  ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µï¼ˆã‚¾ãƒ¼ãƒ³è‰²åˆ†ã‘ï¼‰ */
    .hdr-raw-table{max-height:380px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-bottom:16px;}
    .hdr-raw-table table{border-collapse:collapse;width:100%;font-size:0.75rem;min-width:500px;}
    .hdr-raw-table th{background:var(--bg2);padding:4px 8px;text-align:left;font-weight:600;border-bottom:2px solid var(--border);white-space:nowrap;position:sticky;top:0;z-index:2;}
    .hdr-raw-table td{padding:4px 8px;border-bottom:1px solid #f3f4f6;white-space:nowrap;max-width:140px;overflow:hidden;text-overflow:ellipsis;position:relative;}
    .hdr-raw-table tr{cursor:pointer;transition:background .1s;}
    .hdr-raw-table tr:hover{background:#fffbf0;}
    /* ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ */
    .hdr-raw-table tr.pk-hdr{background:#fef3c7;font-weight:600;}
    .hdr-raw-table tr.pk-hdr td{border-bottom:2px solid var(--yellow);}
    /* ãƒ•ãƒƒã‚¿ãƒ¼è¡Œ */
    .hdr-raw-table tr.pk-ftr{background:#fee2e2;}
    .hdr-raw-table tr.pk-ftr td{border-top:2px solid var(--err);}
    /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚ˆã‚Šä¸‹ã®ã‚¾ãƒ¼ãƒ³ */
    .hdr-raw-table tr.pk-below-ftr{opacity:.35;pointer-events:none;}
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ˆã‚Šä¸Šï¼ˆè²©å£²ä¼šç¤¾ã‚¾ãƒ¼ãƒ³ï¼‰ */
    .hdr-raw-table tr.pk-above{background:#eff6ff;}
    /* ãƒ‡ãƒ¼ã‚¿ã‚¾ãƒ¼ãƒ³ */
    .hdr-raw-table tr.pk-data{}
    /* è²©å£²ä¼šç¤¾ã‚»ãƒ« */
    .hdr-raw-table td.pk-vendor-cell{background:#dbeafe;outline:2px solid #3b82f6;outline-offset:-1px;border-radius:3px;}
    /* åˆ—ãƒ­ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .hdr-raw-table td.pk-col-assigned{position:relative;}
    .pk-col-tag{position:absolute;top:1px;right:2px;font-size:0.6rem;font-weight:700;color:#fff;padding:1px 4px;border-radius:3px;z-index:1;line-height:1.1;}
    .pk-col-tag.name{background:#059669;}
    .pk-col-tag.model{background:#7c3aed;}
    .pk-col-tag.unitPrice{background:#dc2626;}
    .pk-col-tag.qty{background:#2563eb;}
    .pk-col-tag.amount{background:#d97706;}
    .pk-col-tag.maker{background:#0891b2;}
    .pk-col-tag.category{background:#6b7280;}
    .pk-col-tag.notes{background:#9ca3af;}

    /* ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .pk-mode-col .hdr-raw-table tr.pk-hdr td:hover{outline:2px solid var(--accent);outline-offset:-1px;cursor:crosshair;}
    .pk-mode-vendor .hdr-raw-table tr.pk-above td:hover{outline:2px solid #3b82f6;outline-offset:-1px;cursor:crosshair;}

    /*  åˆ—ãƒ­ãƒ¼ãƒ«é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .pk-role-popup{position:fixed;z-index:1200;background:var(--bg);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.18);padding:8px 0;min-width:160px;}
    .pk-role-popup .pk-role-opt{padding:8px 14px;font-size:0.8rem;cursor:pointer;display:flex;align-items:center;gap:8px;font-family:inherit;}
    .pk-role-popup .pk-role-opt:hover{background:var(--bg2);}
    .pk-role-popup .pk-role-opt .pk-r-dot{width:8px;height:8px;border-radius:50%;}
    .pk-role-popup .pk-role-opt.active{font-weight:700;background:#d1fae5;}
    .pk-role-popup .pk-role-opt.clear{color:var(--err);}
    .hdr-picker-foot{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;}
    .hdr-info-badge{display:inline-flex;align-items:center;gap:4px;font-size:0.75rem;padding:4px 10px;border-radius:6px;margin-bottom:12px;}
    .hdr-info-badge.auto{background:#d1fae5;color:#059669;}
    .hdr-info-badge.manual{background:#fef3c7;color:#d97706;}
    .hdr-info-badge.low{background:#fee2e2;color:#dc2626;}

    /* åæ˜ å…ˆãƒãƒƒãƒ”ãƒ³ã‚°ãƒ‘ãƒãƒ« */
    .ref-section{font-size:0.88rem;font-weight:700;margin:14px 0 8px;display:flex;align-items:center;gap:8px;}
    .ref-section::after{content:'';flex:1;height:1px;background:var(--border);}
    .ref-target{border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;background:var(--bg);}
    .ref-target-hdr{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
    .ref-target-hdr h4{font-size:0.88rem;font-weight:700;flex:1;}
    .ref-target-toggle{width:18px;height:18px;accent-color:var(--yellow);}
    .ref-map-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:0.82rem;}
    .ref-map-row:last-child{border-bottom:none;}
    .ref-map-src{flex:0 0 100px;font-weight:600;color:var(--text);font-size:0.8rem;}
    .ref-map-arrow{color:#ccc;flex-shrink:0;font-size:0.78rem;}
    .ref-map-dest{flex:1;}
    .ref-map-dest select{width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:0.82rem;}
    .ref-map-check{flex-shrink:0;}
    .ref-map-check input{width:16px;height:16px;accent-color:var(--yellow);}
    .ref-summary{background:var(--bg2);border-radius:10px;padding:12px;margin-top:12px;font-size:0.82rem;color:var(--muted);}
    .ref-summary b{color:var(--text);}

    /* å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒã‚¸ */
    .req-badge{display:inline-block;font-size:0.65rem;font-weight:700;color:#fff;background:var(--accent);padding:1px 6px;border-radius:4px;margin-left:4px;vertical-align:middle;}
    .mapped-ok{color:var(--ok);font-weight:600;}
    .mapped-ng{color:var(--err);font-weight:600;}
    .req-status{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0;padding:10px 14px;border-radius:10px;font-size:0.82rem;}
    .req-status.complete{background:#d1fae5;border:1px solid var(--ok);}
    .req-status.incomplete{background:#fee2e2;border:1px solid var(--err);}

    /* ä¿¡é ¼åº¦ãƒãƒƒã‚¸ */
    .conf-badge{display:inline-flex;align-items:center;gap:4px;font-size:0.72rem;font-weight:600;padding:3px 8px;border-radius:6px;margin-left:6px;}
    .conf-badge.high{background:#d1fae5;color:#059669;}
    .conf-badge.mid{background:#fef3c7;color:#d97706;}
    .conf-badge.low{background:#fee2e2;color:#dc2626;}
    .fcard-conf{display:flex;align-items:center;gap:6px;margin:8px 0;font-size:0.78rem;color:var(--muted);}
    .fcard-conf .bar{flex:1;max-width:120px;height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
    .fcard-conf .bar-fill{height:100%;border-radius:3px;transition:width .3s;}
    .fcard-method{font-size:0.72rem;color:var(--muted);background:var(--bg2);padding:2px 8px;border-radius:4px;display:inline-block;margin-top:4px;}

    /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ */
    .tpl-bar{display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:10px 14px;background:var(--bg2);border-radius:10px;font-size:0.82rem;}
    .tpl-bar select{flex:1;padding:5px 8px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:0.82rem;}
    .tpl-bar button{font-size:0.78rem;padding:5px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;font-family:inherit;white-space:nowrap;}
    .tpl-bar button:hover{border-color:var(--yellow);}
    .tpl-name-input{padding:5px 8px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:0.82rem;width:160px;}

    @media(max-width:700px){
      .oc-left{flex:1;max-width:100%;}
      .oc-right{display:none;}
    }
  </style>
    <script src="demo-mode.js"></script>
    <script src="unified-header.js"></script>
</head>
<body>
    <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div id="unified-header-mount"></div>

  <div class="wrap">
    <div class="steps-bar">
      <div class="step-dot active" id="s1"></div>
      <div class="step-dot" id="s2"></div>
      <div class="step-dot" id="s3"></div>
      <div class="step-dot" id="s4"></div>
    </div>

    <div class="enc-row">
      <label>æ–‡å­—ã‚³ãƒ¼ãƒ‰:</label>
      <select id="encSel">
        <option value="auto">è‡ªå‹•åˆ¤å®š</option>
        <option value="UTF-8">UTF-8</option>
        <option value="Shift_JIS">Shift_JIS</option>
      </select>
    </div>

    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰åˆ¶é™æƒ…å ± -->
    <div id="uploadLimitsInfo" style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 13px; color: #0369a1;">
      <div style="font-weight: 600; margin-bottom: 4px;"> æœ¬æ—¥ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çŠ¶æ³</div>
      <div id="uploadLimitsText">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="drop" id="dropZone">
      <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.txt,.pdf,.jpg,.jpeg,.png" multiple>
      <div class="drop-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
      <h3>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</h3>
      <p>ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
      <div class="ftypes"><span class="ftype">CSV / TXT</span><span class="ftype">Excel (.xlsx)</span><span class="ftype">PDF</span><span class="ftype">ç”»åƒ (JPG/PNG)</span></div>
    </div>

    <div id="fileList"></div>
    <div id="resultArea"></div>

    <div class="help">
      <h3>Bobæ¡ˆ: 3ãƒ¬ã‚¤ãƒ¤ãƒ¼ å–ã‚Šè¾¼ã¿ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</h3>
      <div class="hgrid" style="grid-template-columns:repeat(3,1fr);margin-bottom:18px;">
        <div class="hcard" style="border-color:var(--ok);"><h4>L1 ç›´æ¥ãƒ‘ãƒ¼ã‚¹</h4><p>Excel/CSV/TXT â†’ OCRä¸è¦ï¼ˆæœ€å®‰ãƒ»æœ€é€Ÿï¼‰ã€‚åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã§ã»ã¼99%</p></div>
        <div class="hcard" style="border-color:var(--warn);"><h4>L2 Vision OCR</h4><p>PDF/ç”»åƒ â†’ ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º â†’ ãƒ€ãƒ¡ãªã‚‰GCP Vision OCR</p></div>
        <div class="hcard" style="border-color:#7c3aed;"><h4>L3 æ§‹é€ åŒ–</h4><p>A) ãƒ«ãƒ¼ãƒ«æŠ½å‡ºï¼ˆç„¡æ–™ï¼‰â†’ B) å¤±æ•—æ™‚ã®ã¿ğŸ¤–AIæ•´å½¢ï¼ˆGeminiï¼‰</p></div>
      </div>
      <h3>å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</h3>
      <div class="hgrid">
        <div class="hcard"><h4>CSV / TXT</h4><p>ã‚«ãƒ³ãƒãƒ»ã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼ˆç›´æ¥ãƒ‘ãƒ¼ã‚¹ï¼‰</p></div>
        <div class="hcard"><h4>Excel</h4><p>.xlsx / .xlsï¼ˆç›´æ¥ãƒ‘ãƒ¼ã‚¹ãƒ»çµåˆã‚»ãƒ«å¯¾å¿œï¼‰</p></div>
        <div class="hcard"><h4>PDF</h4><p>ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º â†’ ãƒ€ãƒ¡ãªã‚‰OCR</p></div>
        <div class="hcard"><h4>ç”»åƒ</h4><p>JPG / PNG â†’ GCP Vision OCR</p></div>
      </div>
      <div style="margin-top:14px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:10px;font-size:0.8rem;color:var(--muted);">
        <b style="color:var(--text);">å¿…é ˆæŠ½å‡º:</b> è²©å£²ä¼šç¤¾ãƒ»å•†å“åãƒ»å‹ç•ªãƒ»å˜ä¾¡<br>
        <b style="color:var(--text);">confidence:</b> +0.35 å•†å“å +0.25 å˜ä¾¡ +0.15 å‹ç•ª +0.15 è²©å£²ä¼šç¤¾ +0.10 æ˜ç´°3è¡Œä»¥ä¸Šï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬é©ç”¨æ™‚+0.20ï¼‰<br>
        <b style="color:var(--text);">AIæ•´å½¢:</b> æ˜ç´°2è¡Œæœªæº€ / å˜ä¾¡æ¬ æ / è²©å£²ä¼šç¤¾ä¸æ˜ / åˆè¨ˆã—ã‹æ‹¾ãˆãªã„ â†’ è‡ªå‹•ç™ºå‹•<br>
        <b style="color:var(--text);">å•†ç”¨åˆ¶å¾¡:</b> ãƒ•ã‚¡ã‚¤ãƒ«10MBåˆ¶é™ãƒ»OCRæœ€å¤§10ãƒšãƒ¼ã‚¸ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ30ç§’ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ä¿å­˜
      </div>
    </div>
  </div>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼&å–è¾¼è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="mov" id="pvModal">
    <div class="mmod">
      <h2 id="pvTitle">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
      <p class="msub" id="pvSub">å–ã‚Šè¾¼ã‚€åˆ—ã¨è¡Œã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>

      <div class="mtabs">
        <button class="mtab active" onclick="showPanel('colMap')">â‘  åˆ—ã®å‰²å½“</button>
        <button class="mtab" onclick="showPanel('vendor')">â‘¡ è²©å£²ä¼šç¤¾</button>
        <button class="mtab" onclick="showPanel('rules')">â‘¢ é™¤å¤–ãƒ«ãƒ¼ãƒ«</button>
        <button class="mtab" onclick="showPanel('rows')">â‘£ è¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        <button class="mtab" onclick="showPanel('reflect')">â‘¤ åæ˜ å…ˆ</button>
      </div>

      <!-- ãƒ‘ãƒãƒ«1: åˆ—ãƒãƒƒãƒ”ãƒ³ã‚° -->
      <div class="mpanel show" id="panelColMap">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:6px;">
          <div id="colMapReqStatus" style="font-size:0.78rem;"></div>
          <button class="mb-auto" onclick="autoDetect()"> è‡ªå‹•æ¨å®š</button>
        </div>
        <div id="mapRows"></div>
        <label class="msave"><input type="checkbox" id="mapSave" checked>ã“ã®è¨­å®šã‚’æ¬¡å›ã‚‚ä½¿ã†</label>
      </div>

      <!-- ãƒ‘ãƒãƒ«2: è²©å£²ä¼šç¤¾æƒ…å ± -->
      <div class="mpanel" id="panelVendor">
        <p style="font-size:0.82rem;color:var(--muted);margin-bottom:12px;">æ›¸é¡ã‹ã‚‰è‡ªå‹•æ¤œå‡ºã—ãŸè²©å£²ä¼šç¤¾æƒ…å ±ã§ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚</p>
        <div id="vendorFields"></div>
      </div>

      <!-- ãƒ‘ãƒãƒ«3: é™¤å¤–ãƒ«ãƒ¼ãƒ« -->
      <div class="mpanel" id="panelRules">
        <div id="rulesArea"></div>
      </div>

      <!-- ãƒ‘ãƒãƒ«4: è¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div class="mpanel" id="panelRows">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <span style="font-size:0.8rem;color:var(--muted);">ãƒã‚§ãƒƒã‚¯ONï¼å–ã‚Šè¾¼ã‚€è¡Œ</span>
          <div style="display:flex;gap:6px;">
            <button class="mb-auto" onclick="checkAll(true)">å…¨é¸æŠ</button>
            <button class="mb-auto" onclick="checkAll(false)">å…¨è§£é™¤</button>
          </div>
        </div>
        <div class="pvwrap" id="pvTable"></div>
      </div>

      <!-- ãƒ‘ãƒãƒ«5: åæ˜ å…ˆãƒãƒƒãƒ”ãƒ³ã‚° -->
      <div class="mpanel" id="panelReflect">
        <p style="font-size:0.82rem;color:var(--muted);margin-bottom:12px;">æŠ½å‡ºã—ãŸæ­£è¦ãƒ‡ãƒ¼ã‚¿ã‚’ã€Œã©ã®ç”»é¢ãƒ»ã©ã®é …ç›®ã€ã«åæ˜ ã™ã‚‹ã‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>

        <div class="req-status incomplete" id="reqStatusBar">
          <span>å¿…é ˆé …ç›®: </span>
          <span id="reqStatusItems">ç¢ºèªä¸­â€¦</span>
        </div>

        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠãƒãƒ¼ -->
        <div class="tpl-bar" id="tplBar">
          <span style="font-weight:600;white-space:nowrap;"> ãƒ†ãƒ³ãƒ—ãƒ¬:</span>
          <select id="tplSelect" onchange="onTplSelect()">
            <option value="">ï¼ˆæ‰‹å‹•è¨­å®šï¼‰</option>
          </select>
          <button onclick="saveCurrentAsTemplate()">ğŸ’¾ ä¿å­˜</button>
          <button onclick="deleteTplCurrent()" id="tplDelBtn" style="display:none;color:var(--err);"></button>
        </div>
        <div id="tplAutoApplied" style="display:none;font-size:0.78rem;color:var(--ok);margin-bottom:8px;padding:6px 10px;background:#d1fae5;border-radius:6px;">
           è²©å£²ä¼šç¤¾ã«ä¸€è‡´ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è‡ªå‹•é©ç”¨ã—ã¾ã—ãŸ
        </div>

        <div class="ref-section">åæ˜ å…ˆã®ç”»é¢</div>
        <div id="reflectTargets"></div>

        <div class="ref-summary" id="reflectSummary">
          åæ˜ å…ˆãŒæœªè¨­å®šã§ã™ã€‚ä¸Šã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§ç”»é¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
        </div>

        <label class="msave" style="margin-top:10px;"><input type="checkbox" id="reflectSave" checked>ã“ã®åæ˜ è¨­å®šã‚’æ¬¡å›ã‚‚ä½¿ã†</label>
      </div>

      <div class="mfoot">
        <div class="mfoot-stats" id="pvStats">
          æ¤œå‡º: <b>0</b> è¡Œ ï½œ é™¤å¤–: <b>0</b> è¡Œ ï½œ å–è¾¼: <b>0</b> è¡Œ
        </div>
        <div class="mfoot-btns">
          <button class="btn btn-sub" onclick="closePreview()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn-main" id="btnImport" onclick="doImport()">å–ã‚Šè¾¼ã‚€ï¼ˆ0ä»¶ï¼‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« â†’  ãƒ‡ãƒ¼ã‚¿ç¯„å›²ï¼†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æŒ‡å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="hdr-picker-overlay" id="hdrPickerOverlay">
    <div class="hdr-picker-modal">
      <h2> èª­ã¿å–ã‚Šç¯„å›²ã®è¨­å®š</h2>
      <p class="sub">è¡¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œãƒ»ãƒ•ãƒƒã‚¿ãƒ¼è¡Œãƒ»å„åˆ—ã®å½¹å‰²ãƒ»è²©å£²ä¼šç¤¾ã®ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯ã§æŒ‡å®šã§ãã¾ã™ã€‚</p>
      <div id="hdrPickerBadge"></div>

      <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
      <div class="pk-toolbar" id="pkToolbar">
        <button class="pk-mode active" data-pk-mode="header" onclick="setPkMode('header')">
          <span class="pk-dot" style="background:var(--yellow);"></span>â‘  ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
        </button>
        <button class="pk-mode" data-pk-mode="footer" onclick="setPkMode('footer')">
          <span class="pk-dot" style="background:var(--err);"></span>â‘¡ ãƒ•ãƒƒã‚¿ãƒ¼è¡Œ
        </button>
        <button class="pk-mode" data-pk-mode="col" onclick="setPkMode('col')">
          <span class="pk-dot" style="background:#7c3aed;"></span>â‘¢ åˆ—ã®å½¹å‰²
        </button>
        <button class="pk-mode" data-pk-mode="vendor" onclick="setPkMode('vendor')">
          <span class="pk-dot" style="background:#3b82f6;"></span>â‘£ è²©å£²ä¼šç¤¾
        </button>
      </div>

      <!-- ãƒ¢ãƒ¼ãƒ‰åˆ¥ãƒ’ãƒ³ãƒˆ -->
      <div class="pk-mode-hint" id="pkModeHint">
        è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆåˆ—åãŒä¸¦ã‚“ã§ã„ã‚‹è¡Œï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
      </div>

      <!-- è¨­å®šã‚µãƒãƒªãƒ¼ -->
      <div class="pk-summary" id="pkSummary"></div>

      <!-- å€™è£œï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
      <div id="hdrCandSection">
        <div class="ref-section">å€™è£œï¼ˆã‚¹ã‚³ã‚¢é †ï¼‰</div>
        <div id="hdrCandidates" class="hdr-cands"></div>
      </div>

      <!-- å…¨è¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <div class="ref-section">å…¨è¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ <span style="font-size:0.72rem;color:var(--muted);font-weight:400;">ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¨­å®šï¼‰</span></div>
      <div class="hdr-raw-table" id="hdrRawTable"></div>

      <!-- åˆ—ãƒ­ãƒ¼ãƒ«é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆéè¡¨ç¤ºã§é…ç½®ï¼‰ -->
      <div class="pk-role-popup" id="pkRolePopup" style="display:none;"></div>

      <div class="hdr-picker-foot">
        <button class="btn btn-sub" onclick="closeHdrPicker(true)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-main" id="btnHdrConfirm" onclick="confirmHdrPicker()">âœ“ ã“ã®è¨­å®šã§ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- OCRå‡¦ç†ã¯ã‚µãƒ¼ãƒå´ï¼ˆGCP Vision APIï¼‰ã§å®Ÿè¡Œã€‚çµæœã¯confidenceã‚«ãƒ¼ãƒ‰ã§è¡¨ç¤º -->

  <script>
    // ========================================================================
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    // ========================================================================
    const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
    if (!currentUser) {
      window.location.href = 'login.html';
    }

    // ========================================================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
    // ========================================================================
    var currentFile=null;
    var rowFlags=[];
    var vendorInfo={name:'',address:'',tel:'',contact:'',email:''};
    var EXCLUDE_WORDS=['åˆè¨ˆ','å°è¨ˆ','ç·è¨ˆ','æ¶ˆè²»ç¨','ç¨è¾¼','ç¨æŠœ','å€¤å¼•','å‰²å¼•','é€æ–™','æŒ¯è¾¼','ãŠæ”¯æ‰•','æ³¨é‡ˆ','å‚™è€ƒ','è¦‹ç©æ›¸','ç´å“æ›¸','è«‹æ±‚æ›¸'];

    // ========================================================================
    //  Bobæ¡ˆ: ã‚µãƒ¼ãƒAPIè¨­å®šï¼ˆGCP Vision OCR é€£æºï¼‰
    // ========================================================================
    //  ã“ã“ã«Cloud Runã®URLã‚’è¨­å®š 
    // ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ: var API_BASE='https://import-api-xxxxx-an.a.run.app/api';
    // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º: var API_BASE='http://localhost:8080/api';
    var API_BASE='/api'; // åŒä¸€ã‚ªãƒªã‚¸ãƒ³ or ãƒ—ãƒ­ã‚­ã‚·çµŒç”±
    var SERVER_AVAILABLE=false; // ã‚µãƒ¼ãƒæ¥ç¶šçŠ¶æ…‹
    var AI_AVAILABLE=false;     //  Vertex AI (Gemini) åˆ©ç”¨å¯èƒ½ã‹

    // ã‚µãƒ¼ãƒæ¥ç¶šãƒã‚§ãƒƒã‚¯ï¼ˆèµ·å‹•æ™‚ï¼‰
    async function checkServerAPI(){
      try{
        var resp=await fetch(API_BASE+'/health',{method:'GET',signal:AbortSignal.timeout(3000)});
        if(resp.ok){
          SERVER_AVAILABLE=true;
          var data=await resp.json().catch(function(){return {};});
          AI_AVAILABLE=!!(data.vertexAi);
          console.log('[API] ã‚µãƒ¼ãƒæ¥ç¶šOK'+(AI_AVAILABLE?' | AIæ•´å½¢: ON':' | AIæ•´å½¢: OFF'));
          return true;
        }
      }catch(e){console.log('[API] ã‚µãƒ¼ãƒæœªæ¥ç¶š â†’ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œ');}
      SERVER_AVAILABLE=false;
      AI_AVAILABLE=false;
      return false;
    }

    // ã‚µãƒ¼ãƒæŠ½å‡ºAPIå‘¼ã³å‡ºã—ï¼ˆBobæ¡ˆ: POST /api/import/extractï¼‰
    async function callExtractAPI(file){
      if(!SERVER_AVAILABLE) return null;
      try{
        var form=new FormData();
        form.append('file',file);
        form.append('facilityId',demoGetFromLocalStorage(ONE.KEYS.facilityId)||'');
        var resp=await fetch(API_BASE+'/import/extract',{method:'POST',body:form,signal:AbortSignal.timeout(30000)});
        if(!resp.ok) throw new Error('API status '+resp.status);
        var data=await resp.json();
        //  ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰AIæ•´å½¢ã®åˆ©ç”¨å¯å¦ã‚’æ›´æ–°
        if(data.evidence&&data.evidence.aiAvailable!==undefined) AI_AVAILABLE=data.evidence.aiAvailable;
        return data;
      }catch(e){
        console.warn('[API] æŠ½å‡ºã‚¨ãƒ©ãƒ¼:',e.message);
        return null;
      }
    }

    // ã‚µãƒ¼ãƒé«˜ç²¾åº¦å†æŠ½å‡ºï¼ˆAIæ•´å½¢ å¼·åˆ¶ONï¼‰
    async function callExtractAPIHighPrecision(file){
      if(!SERVER_AVAILABLE) return null;
      try{
        var form=new FormData();
        form.append('file',file);
        form.append('facilityId',demoGetFromLocalStorage(ONE.KEYS.facilityId)||'');
        form.append('mode','force_ai'); //  ãƒ¬ã‚¤ãƒ¤ãƒ¼3B: AIæ•´å½¢ã‚’å¼·åˆ¶ON
        var resp=await fetch(API_BASE+'/import/extract',{method:'POST',body:form,signal:AbortSignal.timeout(60000)});
        if(!resp.ok) throw new Error('API status '+resp.status);
        return await resp.json();
      }catch(e){
        console.warn('[API] AIæ•´å½¢ã‚¨ãƒ©ãƒ¼:',e.message);
        return null;
      }
    }

    // ========================================================================
    //  Bobæ¡ˆ: confidence â†’ UIå‹•ä½œåˆ†å²
    // ========================================================================
    function getConfidenceLevel(conf){
      if(conf>=0.85)return 'high';
      if(conf>=0.60)return 'mid';
      return 'low';
    }
    function getConfidenceLabel(conf){
      var level=getConfidenceLevel(conf);
      if(level==='high')return ' é«˜ä¿¡é ¼ï¼ˆ'+Math.round(conf*100)+'%ï¼‰';
      if(level==='mid')return ' è¦ç¢ºèªï¼ˆ'+Math.round(conf*100)+'%ï¼‰';
      return ' ä½ä¿¡é ¼ï¼ˆ'+Math.round(conf*100)+'%ï¼‰';
    }
    function getConfidenceColor(conf){
      var level=getConfidenceLevel(conf);
      if(level==='high')return 'var(--ok)';
      if(level==='mid')return 'var(--warn)';
      return 'var(--err)';
    }

    // ========================================================================
    //  Bobæ¡ˆ: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ï¼ˆè²©å£²ä¼šç¤¾åˆ¥ãƒãƒƒãƒ”ãƒ³ã‚°ä¿å­˜ï¼‰
    // ========================================================================
    var allTemplates=[];

    function loadAllTemplates(){
      try{
        var fid=demoGetFromLocalStorage(ONE.KEYS.facilityId)||'default';
        var s=demoGetFromLocalStorage('tpl.'+fid);
        allTemplates=s?JSON.parse(s):[];
      }catch(e){allTemplates=[];}
    }
    function saveAllTemplates(){
      try{
        var fid=demoGetFromLocalStorage(ONE.KEYS.facilityId)||'default';
        demoSaveToLocalStorage('tpl.'+fid,JSON.stringify(allTemplates));
      }catch(e){}
    }
    function findTemplateByVendor(vendorName){
      if(!vendorName)return null;
      var vn=vendorName.replace(/[\sã€€]/g,'').toLowerCase();
      for(var i=0;i<allTemplates.length;i++){
        var tn=(allTemplates[i].vendorPattern||'').replace(/[\sã€€]/g,'').toLowerCase();
        if(tn&&(vn.indexOf(tn)>=0||tn.indexOf(vn)>=0)) return allTemplates[i];
      }
      return null;
    }
    function saveCurrentAsTemplate(tplName){
      if(!tplName){
        tplName=prompt('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: invoxç³»ã€æ¥½ã€…æ˜ç´°ç³»ï¼‰:','');
        if(!tplName)return;
      }
      onReflectMapChange(); // æœ€æ–°ã®çŠ¶æ…‹ã‚’åé›†
      var vi=getVendorFromUI();
      var colMap=getMapByHeader();
      var tpl={
        name:tplName,
        vendorPattern:vi.name||'',
        createdAt:new Date().toISOString(),
        colMapping:colMap,
        reflectConfig:JSON.parse(JSON.stringify(reflectConfig)),
      };
      // åŒåãƒ†ãƒ³ãƒ—ãƒ¬ãŒã‚ã‚Œã°ä¸Šæ›¸ã
      var found=false;
      for(var i=0;i<allTemplates.length;i++){
        if(allTemplates[i].name===tplName){allTemplates[i]=tpl;found=true;break;}
      }
      if(!found)allTemplates.push(tpl);
      saveAllTemplates();
      alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ'+tplName+'ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
    }
    function applyTemplate(tpl){
      if(!tpl)return;
      // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’é©ç”¨
      if(tpl.colMapping&&currentFile&&currentFile.parsed){
        var sels=document.querySelectorAll('#mapRows select');
        sels.forEach(function(s){s.value='';});
        var headers=currentFile.parsed.headers;
        for(var hdr in tpl.colMapping){
          var idx=headers.indexOf(hdr);
          if(idx>=0){
            var sel=document.querySelector('#mapRows select[data-col="'+idx+'"]');
            if(sel)sel.value=tpl.colMapping[hdr];
          }
        }
        onMapChange();
      }
      // åæ˜ å…ˆãƒãƒƒãƒ”ãƒ³ã‚°ã‚’é©ç”¨
      if(tpl.reflectConfig){
        reflectConfig=JSON.parse(JSON.stringify(tpl.reflectConfig));
      }
    }
    function deleteTemplate(name){
      allTemplates=allTemplates.filter(function(t){return t.name!==name;});
      saveAllTemplates();
    }

    var FIELDS=[
      {key:'itemId',label:'å•†å“No.',req:false,p:['å•†å“No','å•†å“ãƒŠãƒ³ãƒãƒ¼','å•†å“ç•ªå·','å•†å“no','itemId','item_id','å“ç•ª','No','NO','no']},
      {key:'name',label:'å•†å“å å¿…é ˆ',req:true,p:['å•†å“å','å“å','åç§°','item','name','å“ç›®','product','æ‘˜è¦','å†…å®¹','æ˜ç´°']},
      {key:'assignedPartnerName',label:'æ‹…å½“æ¥­è€… å¿…é ˆ',req:true,p:['æ‹…å½“æ¥­è€…','æ¥­è€…','æ¥­è€…å','å–å¼•å…ˆ','å¤–æ³¨å…ˆ','è²©å£²ä¼šç¤¾','partner','vendor','supplier']},
      {key:'qty',label:'æ•°é‡',req:false,p:['æ•°é‡','å€‹æ•°','qty','quantity','å…¥æ•°','æœ¬æ•°','æ•°']},
      {key:'unitPrice',label:'å˜ä¾¡',req:false,p:['å˜ä¾¡','å®šä¾¡','unit','price','unitprice']},
      {key:'amount',label:'é‡‘é¡',req:false,p:['é‡‘é¡','åˆè¨ˆ','amount','total','å°è¨ˆ','ç¨è¾¼','ç¨æŠœ']},
      {key:'maker',label:'ãƒ¡ãƒ¼ã‚«ãƒ¼',req:false,p:['ãƒ¡ãƒ¼ã‚«ãƒ¼','è£½é€ å…ƒ','maker','manufacturer','ãƒ–ãƒ©ãƒ³ãƒ‰','ãƒ¡ãƒ¼ã‚«']},
      {key:'model',label:'å‹ç•ª',req:false,p:['å‹ç•ª','å“ç•ª','model','code','jan','sku','å•†å“ã‚³ãƒ¼ãƒ‰','å‹å¼','è¦æ ¼']},
      {key:'category',label:'ã‚«ãƒ†ã‚´ãƒª',req:false,p:['ã‚«ãƒ†ã‚´ãƒª','åˆ†é¡','category','ç¨®åˆ¥','åŒºåˆ†']},
      {key:'notes',label:'å‚™è€ƒ',req:false,p:['å‚™è€ƒ','æ‘˜è¦','note','notes','remark','remarks','ã‚³ãƒ¡ãƒ³ãƒˆ','æ³¨è¨˜']},
    ];

    var RULES=[
      {id:'empty',label:'å•†å“åãŒç©ºã®è¡Œã‚’é™¤å¤–',on:true},
      {id:'keywords',label:'åˆè¨ˆãƒ»å°è¨ˆãƒ»ç¨ãƒ»å€¤å¼•ãƒ»é€æ–™ ç­‰ã‚’å«ã‚€è¡Œã‚’é™¤å¤–',on:true},
      {id:'noNumbers',label:'æ•°é‡ã‚‚é‡‘é¡ã‚‚ç„¡ã„è¡Œã‚’é™¤å¤–ï¼ˆè¦‹å‡ºã—ãƒ»æ³¨é‡ˆï¼‰',on:true},
      {id:'short',label:'å•†å“åãŒ2æ–‡å­—ä»¥ä¸‹ã®è¡Œã‚’é™¤å¤–',on:false},
    ];

    // ãƒ¡ãƒ¼ã‚«ãƒ¼è¾æ›¸
    var MAKERS=['æ—¥ç«‹','HITACHI','æ±èŠ','TOSHIBA','ä¸‰è±','ä¸‰è±é›»æ©Ÿ','MITSUBISHI','ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯','Panasonic',
      'SHARP','ã‚·ãƒ£ãƒ¼ãƒ—','ãƒ€ã‚¤ã‚­ãƒ³','DAIKIN','å¯Œå£«é€š','NEC','SONY','ã‚½ãƒ‹ãƒ¼','è±¡å°','ã‚¿ã‚¤ã‚¬ãƒ¼','ã‚¢ã‚¤ãƒªã‚¹ã‚ªãƒ¼ãƒ¤ãƒ',
      'ã‚¢ã‚¤ãƒªã‚¹','ãƒã‚­ã‚¿','ã‚³ã‚¤ã‚ºãƒŸ','ã‚¨ãƒ¬ã‚³ãƒ ','ãƒŠã‚«ãƒãƒ¤ã‚·','ã‚¢ã‚¯ã‚¢','AQUA','ãƒ”ãƒ¼ã‚³ãƒƒã‚¯','ãƒ–ãƒ©ã‚¶ãƒ¼','ã‚­ãƒ¤ãƒãƒ³',
      'Canon','ãƒªãƒ³ãƒŠã‚¤','ãƒãƒ¼ãƒªãƒ„','æ—¥æœ¬ã‚¢ãƒ³ãƒ†ãƒŠ','ãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ãƒ«','ASUS','ãƒ•ã‚£ãƒªãƒƒãƒ—ã‚¹','ã‚­ãƒ³ã‚°ã‚¸ãƒ ','ã‚»ã‚¤ã‚³ãƒ¼',
      'ã‚«ã‚·ã‚ª','CASIO','ãƒãƒƒãƒ•ã‚¡ãƒ­ãƒ¼','BUFFALO','ã‚¨ãƒ—ã‚½ãƒ³','EPSON','LG','Samsung','ã‚µãƒ ã‚¹ãƒ³','Dell','HP',
      'Lenovo','Apple','BALMUDA','ãƒãƒ«ãƒŸãƒ¥ãƒ¼ãƒ€','ãƒ„ã‚¤ãƒ³ãƒãƒ¼ãƒ‰','TWINBIRD','å±±å–„','YAMAZEN'];

    // ========================================================================
    //  é«˜ç²¾åº¦ãƒ‘ãƒ¼ã‚·ãƒ³ã‚°è£œåŠ©é–¢æ•°ï¼ˆæ–°ç‰ˆãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    // ========================================================================
    function norm(s){
      return String(s||"").replace(/ï¼-ï½/g,function(c){return String.fromCharCode(c.charCodeAt(0)-0xFEE0);})
        .replace(/[ã€€]/g," ")
        .replace(/[â€â€‘â€’â€“â€”â€•ãƒ¼ï½°]/g,"-")
        .replace(/[ï¿¥Â¥]/g,"Â¥")
        .replace(/\s+/g," ")
        .trim();
    }
    function numLike(s){
      var t=String(s||"").replace(/[^\d.\-]/g,"");
      if(!t)return null;
      var v=Number(t);
      return Number.isFinite(v)?v:null;
    }
    function isProbablyTotalRow(name){
      var t=norm(name);
      return /^(åˆè¨ˆ|å°è¨ˆ|ç·è¨ˆ|æ¶ˆè²»ç¨|ç¨|é€æ–™|å€¤å¼•|å€¤å¼•ã|å‰²å¼•|ãŠå€¤å¼•|ç«¯æ•°|èª¿æ•´|æŒ¯è¾¼|å†…è¨³|è«‹æ±‚é¡)$/i.test(t) ||
        /åˆè¨ˆ|å°è¨ˆ|ç·è¨ˆ|æ¶ˆè²»ç¨|ç¨è¾¼|ç¨æŠœ|é€æ–™|å€¤å¼•|å‰²å¼•/.test(t);
    }

    var HEADER_SYNONYMS = {
      name:  [/^(å•†å“å|å“å|åç§°|æ‘˜è¦|æ˜ç´°|å†…å®¹|å†…è¨³|è£½å“å|å“ç›®)$/i, /(å•†å“|å“å|åç§°|æ‘˜è¦|æ˜ç´°|å†…å®¹|å†…è¨³|è£½å“|å“ç›®)/i],
      model: [/^(å‹ç•ª|å“ç•ª|å“ç›®ã‚³ãƒ¼ãƒ‰|å•†å“ã‚³ãƒ¼ãƒ‰|ï½ºï½°ï¾„ï¾|ã‚³ãƒ¼ãƒ‰|è¦æ ¼|JAN|SKU)$/i, /(å‹ç•ª|å“ç•ª|ã‚³ãƒ¼ãƒ‰|è¦æ ¼|JAN|SKU)/i],
      qty:   [/^(æ•°é‡|å€‹æ•°|æ•°|Qty)$/i, /(æ•°é‡|å€‹æ•°|Qty)/i],
      unit:  [/^(å˜ä¾¡|unit price)$/i, /(å˜ä¾¡)/i],
      amount:[/^(é‡‘é¡|ä¾¡æ ¼|åˆè¨ˆ|å°è¨ˆ|é‡‘é¡\(.+\)|ç·é¡|è«‹æ±‚é¡|Amount)$/i, /(é‡‘é¡|ä¾¡æ ¼|åˆè¨ˆ|å°è¨ˆ|ç·é¡|è«‹æ±‚é¡|Amount)/i],
    };

    function scoreHeaderRow(row){
      var score=0;
      //  ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒƒãƒæ™‚ã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨é™¤å»ï¼ˆã€Œå†…ã€€å®¹ã€â†’ã€Œå†…å®¹ã€å¯¾å¿œï¼‰
      var cells=(row||[]).map(function(c){return norm(c).replace(/\s+/g,'');});
      for(var i=0;i<cells.length;i++){
        var c=cells[i];
        if(!c)continue;
        if(HEADER_SYNONYMS.name[0].test(c)||HEADER_SYNONYMS.name[1].test(c)) score+=2;
        if(HEADER_SYNONYMS.model[0].test(c)||HEADER_SYNONYMS.model[1].test(c)) score+=2;
        if(HEADER_SYNONYMS.qty[0].test(c)||HEADER_SYNONYMS.qty[1].test(c)) score+=1;
        if(HEADER_SYNONYMS.unit[0].test(c)||HEADER_SYNONYMS.unit[1].test(c)) score+=1;
        if(HEADER_SYNONYMS.amount[0].test(c)||HEADER_SYNONYMS.amount[1].test(c)) score+=2;
      }
      return score;
    }

    function pickHeaderRow(rows, maxScan){
      maxScan=maxScan||40;
      var best={idx:-1, score:0};
      var lim=Math.min(rows.length, maxScan);
      for(var i=0;i<lim;i++){
        var sc=scoreHeaderRow(rows[i]||[]);
        if(sc>best.score) best={idx:i, score:sc};
      }
      if(best.score>=3) return best;
      return {idx:-1, score:best.score};
    }

    function mapColumnsNew(headers, dataRows){
      //  ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨é™¤å»ã—ã¦ãƒãƒƒãƒãƒ³ã‚°ï¼ˆã€Œå†…ã€€å®¹ã€â†’ã€Œå†…å®¹ã€å¯¾å¿œï¼‰
      var h=headers.map(function(x){return norm(x).replace(/\s+/g,'');});
      var map={name:-1, model:-1, amount:-1, qty:-1, unit:-1};
      function findIndex(regexes){
        for(var i=0;i<h.length;i++){
          var c=h[i]; if(!c)continue;
          if(regexes[0].test(c)||regexes[1].test(c)) return i;
        }
        return -1;
      }
      map.name=findIndex(HEADER_SYNONYMS.name);
      map.model=findIndex(HEADER_SYNONYMS.model);
      map.qty=findIndex(HEADER_SYNONYMS.qty);
      map.unit=findIndex(HEADER_SYNONYMS.unit);
      map.amount=findIndex(HEADER_SYNONYMS.amount);

      //  nameåˆ—ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯: çµåˆã‚»ãƒ«ã§å®Ÿãƒ‡ãƒ¼ã‚¿ãŒåˆ¥åˆ—ã«ã‚ã‚‹å ´åˆã®è£œæ­£
      if(map.name>=0 && dataRows && dataRows.length>0){
        var sampleSize=Math.min(dataRows.length, 20);
        var nameNonEmpty=0;
        for(var r=0;r<sampleSize;r++){
          var v=String(dataRows[r][map.name]||'').trim();
          if(v && !v.startsWith('â—†')) nameNonEmpty++;
        }
        // nameåˆ—ãŒ50%æœªæº€ã—ã‹åŸ‹ã¾ã£ã¦ã„ãªã„ â†’ éš£æ¥åˆ—ã§æœ€ã‚‚ãƒ†ã‚­ã‚¹ãƒˆãŒå¤šã„åˆ—ã‚’æ¢ã™
        if(nameNonEmpty < sampleSize * 0.5){
          var bestCol=-1, bestCount=0;
          // nameåˆ—ã®Â±3åˆ—ã‚’æ¢ç´¢
          var scanStart=Math.max(0, map.name-1);
          var scanEnd=Math.min(headers.length-1, map.name+5);
          for(var ci=scanStart;ci<=scanEnd;ci++){
            if(ci===map.name || ci===map.qty || ci===map.unit || ci===map.amount || ci===map.model) continue;
            var count=0;
            for(var ri=0;ri<sampleSize;ri++){
              var v2=String(dataRows[ri][ci]||'').trim();
              if(v2 && v2.length>2 && !v2.startsWith('â—†') && !/^\d+$/.test(v2)) count++;
            }
            if(count>bestCount){bestCount=count;bestCol=ci;}
          }
          if(bestCol>=0 && bestCount>nameNonEmpty){
            console.log('[mapColumns] name col corrected: '+map.name+' â†’ '+bestCol+' ('+nameNonEmpty+' vs '+bestCount+' filled)');
            // å…ƒã®nameåˆ—ã‚’makeråˆ—ã¨ã—ã¦è¨˜éŒ²ï¼ˆãƒ¡ãƒ¼ã‚«ãƒ¼æƒ…å ±ï¼‰
            map.maker=map.name;
            map.name=bestCol;
          }
        }
      }

      //  modelåˆ—æœªæ¤œå‡ºæ™‚: nameåˆ—ã®éš£ã«ã‚³ãƒ¼ãƒ‰ç³»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å‹ç•ªã¨ã¿ãªã™
      if(map.model===-1 && map.name>=0 && dataRows && dataRows.length>0){
        var sampleSize2=Math.min(dataRows.length, 15);
        for(var ci2=0;ci2<headers.length;ci2++){
          if(ci2===map.name||ci2===map.qty||ci2===map.unit||ci2===map.amount) continue;
          var codeCount=0;
          for(var ri2=0;ri2<sampleSize2;ri2++){
            var v3=String(dataRows[ri2][ci2]||'').trim();
            if(v3 && /^[A-Za-z0-9\-_.]{3,}$/.test(v3)) codeCount++;
          }
          if(codeCount>=sampleSize2*0.3){
            map.model=ci2;
            console.log('[mapColumns] model col detected from data: col '+ci2);
            break;
          }
        }
      }

      if(map.amount===-1){
        var best={idx:-1,hits:0};
        for(var i=0;i<h.length;i++){
          var hits=0;
          var kws=["é‡‘","é¡","Â¥","å††","åˆè¨ˆ","å°è¨ˆ","total","amount"];
          for(var k=0;k<kws.length;k++){
            if(h[i].toLowerCase().indexOf(kws[k].toLowerCase())>=0)hits++;
          }
          if(hits>best.hits) best={idx:i,hits:hits};
        }
        if(best.idx!==-1) map.amount=best.idx;
      }
      return map;
    }

    function detectDelimiter(line){
      var candidates=[",","\t",";"];
      var best={d:",",c:0};
      for(var i=0;i<candidates.length;i++){
        var cnt=line.split(candidates[i]).length-1;
        if(cnt>best.c) best={d:candidates[i],c:cnt};
      }
      return best.d;
    }

    function guessDocType(t){
      var s=String(t||"");
      if(/è¦‹\s*ç©\s*æ›¸|è¦‹ç©æ›¸/.test(s)) return "è¦‹ç©æ›¸";
      if(/è«‹\s*æ±‚\s*æ›¸|è«‹æ±‚æ›¸/.test(s)) return "è«‹æ±‚æ›¸";
      if(/ç´\s*å“\s*æ›¸|ç´å“æ›¸/.test(s)) return "ç´å“æ›¸";
      if(/ç™º\s*æ³¨\s*æ›¸|ç™ºæ³¨æ›¸/.test(s)) return "ç™ºæ³¨æ›¸";
      if(/æ˜\s*ç´°\s*æ›¸|æ˜ç´°æ›¸/.test(s)) return "æ˜ç´°æ›¸";
      return "æ›¸é¡";
    }

    function mergeVendor(a,b){
      return {name:a.name||b.name||"",address:a.address||b.address||"",tel:a.tel||b.tel||""};
    }

    // ========================================================================
    //  PDF ãƒ†ã‚­ã‚¹ãƒˆè§£æï¼ˆæ–°ç‰ˆãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    // ========================================================================
    function groupPdfIntoLines(items){
      var sorted=items.slice().sort(function(a,b){
        if(a.page!==b.page)return a.page-b.page;
        if(a.y!==b.y)return b.y-a.y;
        return a.x-b.x;
      });
      var lines=[], cur=null, yTol=4;
      for(var i=0;i<sorted.length;i++){
        var it=sorted[i];
        if(!cur||it.page!==cur.page||Math.abs(it.y-cur.y)>yTol){
          if(cur){cur.cells.sort(function(a,b){return a.x-b.x;});cur.text=cur.cells.map(function(c){return c.text;}).join(" ");lines.push(cur);}
          cur={page:it.page,y:it.y,cells:[it],text:""};
        }else{cur.cells.push(it);}
      }
      if(cur){cur.cells.sort(function(a,b){return a.x-b.x;});cur.text=cur.cells.map(function(c){return c.text;}).join(" ");lines.push(cur);}
      return lines.filter(function(l,idx){
        if(idx===0)return true;
        var prev=lines[idx-1];
        if(l.page===prev.page&&l.text===prev.text&&Math.abs(l.y-prev.y)<=2)return false;
        return true;
      });
    }

    function computeColumnBounds(headerCells){
      var bounds=[];
      for(var i=0;i<headerCells.length;i++){
        var left=headerCells[i].x;
        var right=(i<headerCells.length-1)?Math.round((headerCells[i].x+headerCells[i+1].x)/2):999999;
        bounds.push({left:left,right:right});
      }
      return bounds;
    }

    function splitLineByBounds(cells,bounds){
      var cols=[];
      for(var i=0;i<bounds.length;i++) cols.push([]);
      for(var c=0;c<cells.length;c++){
        var cell=cells[c], idx=-1;
        for(var b=0;b<bounds.length;b++){
          if(cell.x>=bounds[b].left&&cell.x<bounds[b].right){idx=b;break;}
        }
        if(idx===-1)idx=0;
        cols[idx].push(cell.text);
      }
      return cols.map(function(a){return norm(a.join(" "));});
    }

    function normalizeRows(headers, map, rows){
      var out=[];
      for(var r=0;r<rows.length;r++){
        var row=rows[r];
        var name=norm(row[map.name]||"");
        if(!name)continue;
        if(isProbablyTotalRow(name))continue;
        var model=norm(row[map.model]||"");
        var amountRaw=row[map.amount]||"";
        var amount=numLike(amountRaw);
        if(amount==null){
          var best=null;
          for(var c=0;c<row.length;c++){
            var v=numLike(row[c]);
            if(v!=null&&(best==null||v>best))best=v;
          }
          amount=(best==null)?0:best;
        }
        if(!model){
          var m=name.match(/[A-Z0-9]{2,}[A-Z0-9\-\/]{3,}/i);
          if(m)model=m[0];
          var jan=name.match(/\b(49\d{11,12})\b/);
          if(jan)model="JAN:"+jan[1];
        }
        var headerish=scoreHeaderRow([name,model,String(amountRaw||"")])>=3;
        if(headerish)continue;
        out.push({name:name,model:model,amount:Number.isFinite(amount)?Math.round(amount):0});
      }
      return out;
    }

    async function parsePDFTextDirect(file){
      pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      var buf=await file.arrayBuffer();
      var pdf=await pdfjsLib.getDocument({data:buf}).promise;
      var items=[], pagesText=[];
      for(var p=1;p<=pdf.numPages;p++){
        var page=await pdf.getPage(p);
        var tc=await page.getTextContent();
        var pageItems=tc.items.filter(function(it){return it.str&&it.str.trim();}).map(function(it){
          return {text:norm(it.str),x:Math.round(it.transform[4]),y:Math.round(it.transform[5]),w:Math.round(it.width||0),page:p};
        });
        items=items.concat(pageItems);
        pagesText.push(pageItems.map(function(x){return x.text;}).join(" "));
      }
      var lines=groupPdfIntoLines(items);
      var topLines=lines.filter(function(l){return l.page===1;}).slice(0,30).map(function(l){return l.text;}).join("\n");
      var vendor=extractVendorFromTextNew(topLines);
      var lineTokens=lines.map(function(l){return l.cells.map(function(c){return c.text;});});
      var pick=pickHeaderRow(lineTokens,80);
      if(pick.idx===-1){
        return {vendor:vendor,items:[],rawText:pagesText.join("\n"),lines:lines,headers:[],dataRows:[],headerIdx:-1,pdfParsed:true};
      }
      var headerLine=lines[pick.idx];
      var headers=headerLine.cells.map(function(c){return c.text;});
      var colMap=mapColumnsNew(headers);
      var bounds=computeColumnBounds(headerLine.cells);
      var tableRows=[];
      for(var i=pick.idx+1;i<lines.length;i++){
        var ln=lines[i];
        if(ln.cells.length>=2){var sc=scoreHeaderRow(ln.cells.map(function(c){return c.text;}));if(sc>=3)break;}
        var text=ln.text;
        if(!text||text.length<2)continue;
        if(/^(åˆè¨ˆ|å°è¨ˆ|ç·è¨ˆ|æ¶ˆè²»ç¨|ç¨|é€æ–™|å€¤å¼•)/.test(text))continue;
        var row=splitLineByBounds(ln.cells,bounds);
        if(row.every(function(x){return !norm(x);}))continue;
        tableRows.push(row);
      }
      var normalized=normalizeRows(headers,colMap,tableRows);
      return {vendor:mergeVendor(vendor,extractVendorFromTextNew(pagesText.slice(0,1).join("\n"))),items:normalized,rawText:pagesText.join("\n"),headers:headers,dataRows:tableRows,headerIdx:pick.idx,pdfParsed:true};
    }

    // ========================================================================
    // åˆæœŸåŒ–
    // ========================================================================
    document.addEventListener('DOMContentLoaded',function(){
      setupDrop();
      checkServerAPI(); //  ã‚µãƒ¼ãƒæ¥ç¶šãƒã‚§ãƒƒã‚¯
      loadAllTemplates(); //  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­è¾¼
      updateUploadLimitsDisplay(); //  ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰åˆ¶é™è¡¨ç¤º
    });

    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰åˆ¶é™æƒ…å ±ã‚’è¡¨ç¤º
    function updateUploadLimitsDisplay() {
      try {
        const info = UploadLimits.getUploadLimitsInfo();
        const text = `æœ¬æ—¥: ${info.uploadedToday} / ${info.maxUploadPerDay}å› ï¼ˆæ®‹ã‚Š ${info.remainingToday}å›ï¼‰ï½œ 1å›ã‚ãŸã‚Š: ${info.maxFilesPerUpload}ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§ ï½œ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${info.maxFileSizeMB}MBã¾ã§`;
        document.getElementById('uploadLimitsText').textContent = text;
      } catch (e) {
        console.error('[UploadLimits] è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', e);
        document.getElementById('uploadLimitsText').textContent = 'åˆ¶é™æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
      }
    }

    function setupDrop(){
      var dz=document.getElementById('dropZone'),fi=document.getElementById('fileInput');
      function stop(e){e.preventDefault();e.stopPropagation();}
      ['dragenter','dragover','dragleave','drop'].forEach(function(ev){dz.addEventListener(ev,stop,{passive:false});});
      dz.addEventListener('click',function(){fi.click();});
      dz.addEventListener('dragenter',function(){dz.classList.add('over');});
      dz.addEventListener('dragleave',function(){dz.classList.remove('over');});
      dz.addEventListener('drop',function(e){dz.classList.remove('over');var f=e.dataTransfer&&e.dataTransfer.files;if(f&&f.length>0){for(var i=0;i<f.length;i++)handleFile(f[i]);}});
      fi.addEventListener('change',function(e){if(e.target.files&&e.target.files.length>0){for(var i=0;i<e.target.files.length;i++)handleFile(e.target.files[i]);}fi.value='';});
    }

    // ========================================================================
    // ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ãƒ«ãƒ¼ã‚¿ãƒ¼
    // ========================================================================
    var OCR_EXTS=['jpg','jpeg','png','gif','webp'];  //  PDFã¯åˆ¥å‡¦ç†
    
    // ========================================================================
    //  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ ï¼‰
    // ========================================================================
    function generateFileId() {
      const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
      const random = Math.random().toString(36).substring(2, 6).toUpperCase();
      return `DOC-${dateStr}-${random}`;
    }
    
    function parseNumber(text) {
      if (!text) return 0;
      const normalized = String(text).replace(/[^\d.\-]/g, '');
      const num = parseFloat(normalized);
      return isNaN(num) ? 0 : num;
    }

    async function handleFile(file){
      // ========================================================================
      //  ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆä¿®æ­£ç‰ˆï¼‰
      // ========================================================================
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
      const sizeCheck = UploadLimits.checkFileSize(file);
      if (!sizeCheck.valid) {
        alert(sizeCheck.reason);
        return;
      }
      
      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å›æ•°ãƒã‚§ãƒƒã‚¯
      const uploadCheck = UploadLimits.canUpload(1);
      if (!uploadCheck.canUpload) {
        alert(uploadCheck.reason);
        return;
      }
      
      var ext=file.name.split('.').pop().toLowerCase();
      var isImage=OCR_EXTS.indexOf(ext)>=0;
      var isPDF=(ext==='pdf');
      if(!isImage&&!isPDF&&!['csv','xlsx','xls','txt'].includes(ext)){alert(file.name+' ã¯éå¯¾å¿œå½¢å¼ã§ã™');return;}

      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™
      UploadLimits.incrementUploadCount();

      var fid=generateFileId();
      currentFile={fileObj:file,fileName:file.name,ext:ext,fileId:fid,parsed:null,_confidence:null,_evidence:null};
      
      // ========================================================================
      //  Documentä¿å­˜ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
      // ========================================================================
      try {
        const doc = {
          docId: fid,
          companyCode: currentUser.companyCode,
          officeCode: currentUser.officeCode,
          fileName: file.name,
          fileType: file.type,
          fileSize: file.size,
          uploadedBy: currentUser.userId,
          status: 'pending'
        };
        await DocumentStorage.addDocument(doc);
        console.log('[Document] ä¿å­˜å®Œäº†:', doc.docId);
      } catch (e) {
        console.error('[Document] ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
      }

      // ==================================================================
      //  PDF/ç”»åƒ â†’ ã‚µãƒ¼ãƒAPIçµ±åˆå‡¦ç†ï¼ˆGCP Vision OCR + AIæ§‹é€ åŒ–ï¼‰
      // ==================================================================
      if(isPDF||isImage){
        if(SERVER_AVAILABLE){
          //  ã‚µãƒ¼ãƒAPIã§ä¸€æ‹¬å‡¦ç†ï¼ˆL1â†’L2â†’L3 å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰
          showCard(fid,file.name,file.size,'parsing',null,'â˜ï¸ ã‚µãƒ¼ãƒè§£æä¸­â€¦');
          setStep(2);
          var apiResult=await callExtractAPI(file);
          if(apiResult&&apiResult.items&&apiResult.items.length>0){
            currentFile._confidence=apiResult.confidence||0;
            currentFile._evidence=apiResult.evidence||{method:'server'};
            vendorInfo={
              name:(apiResult.vendor&&apiResult.vendor.name)||'',
              address:(apiResult.vendor&&apiResult.vendor.address)||'',
              tel:(apiResult.vendor&&apiResult.vendor.tel)||'',
              contact:'',email:''
            };
            var synHeaders=['å•†å“å','å‹ç•ª','å˜ä¾¡'];
            var synRows=apiResult.items.map(function(it){
              return [it.product_name||it.name||'',it.model||'',String(it.unit_price||it.unitPrice||'')];
            });
            currentFile.parsed={headers:synHeaders,rows:synRows};
            var excluded=countExcluded(currentFile.parsed);
            var candidate=synRows.length-excluded;
            showCard(fid,file.name,file.size,'ready',{
              total:synRows.length,excluded:excluded,candidate:candidate,cols:synHeaders.length
            });
            var confLevel=getConfidenceLevel(apiResult.confidence||0);
            if(confLevel==='high') openPreview();
            return;
          }
          // ã‚µãƒ¼ãƒAPIå¤±æ•— â†’ PDFã®ã¿ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if(isPDF){
            console.log('[API] ã‚µãƒ¼ãƒæŠ½å‡ºå¤±æ•— â†’ ãƒ­ãƒ¼ã‚«ãƒ«PDFãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã¸');
          }else{
            // ç”»åƒã¯ã‚µãƒ¼ãƒOCRå¿…é ˆ â†’ ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            showCard(fid,file.name,file.size,'error',null,'ã‚µãƒ¼ãƒã§ã®ç”»åƒèª­å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã™ã‚‹ã‹ã€CSV/Excelã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            return;
          }
        }else if(isImage){
          //  ç”»åƒã¯ã‚µãƒ¼ãƒæ¥ç¶šå¿…é ˆ
          showCard(fid,file.name,file.size,'error',null,'ç”»åƒã®èª­å–ã‚Šã«ã¯ã‚µãƒ¼ãƒæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã™ã‚‹ã‹ã€CSV/Excelã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
          setStep(2);
          return;
        }

        //  PDFãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã®ã¿ï¼ˆOCRãªã—ï¼‰
        if(isPDF){
          showCard(fid,file.name,file.size,'parsing',null,' PDFãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºä¸­â€¦');
          setStep(2);
          try{
            var pdfResult=await parsePDFTextDirect(file);
            if(pdfResult.items&&pdfResult.items.length>0){
              var headers=pdfResult.headers||[];
              var dataRows=pdfResult.dataRows||[];
              vendorInfo=pdfResult.vendor||{name:'',address:'',tel:'',contact:'',email:''};
              if(!vendorInfo.contact)vendorInfo.contact='';
              if(!vendorInfo.email)vendorInfo.email='';
              if(headers.length>0&&dataRows.length>0){
                currentFile.parsed={headers:headers,rows:dataRows};
              }else{
                var synHeaders2=['å•†å“å','å‹ç•ª','é‡‘é¡'];
                var synRows2=pdfResult.items.map(function(it){return [it.name,it.model,String(it.amount||'')];});
                currentFile.parsed={headers:synHeaders2,rows:synRows2};
              }
              currentFile._headerIdx=pdfResult.headerIdx||0;
              currentFile._aboveText=pdfResult.rawText||'';
              currentFile._pdfItems=pdfResult.items;
              currentFile._confidence=estimateLocalConfidence(currentFile.parsed,vendorInfo);
              currentFile._evidence={method:'local_pdf',notes:[]};
              var excluded2=countExcluded(currentFile.parsed);
              var candidate2=currentFile.parsed.rows.length-excluded2;
              showCard(fid,file.name,file.size,'ready',{
                total:currentFile.parsed.rows.length, excluded:excluded2, candidate:candidate2, cols:currentFile.parsed.headers.length
              });
              return;
            }
          }catch(pdfErr){
            console.warn('[PDF Text] extraction failed:', pdfErr);
          }
          // ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã‚‚å¤±æ•— â†’ ã‚¹ã‚­ãƒ£ãƒ³PDFãªã®ã§ã‚µãƒ¼ãƒãŒå¿…è¦
          showCard(fid,file.name,file.size,'error',null,
            SERVER_AVAILABLE
              ? 'PDFã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ğŸ¤– AIæ•´å½¢ã‚’è©¦ã™ã‹ã€CSV/Excelã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚'
              : 'ã“ã®PDFã¯ã‚¹ã‚­ãƒ£ãƒ³ç”»åƒã®ãŸã‚ã€ã‚µãƒ¼ãƒæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          );
          return;
        }
        return; // ã“ã“ã«ã¯åˆ°é”ã—ãªã„ã¯ãš
      }

      // CSV/Excel â†’ ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œè‡ªå‹•æ¤œå‡ºä»˜ããƒ•ãƒ­ãƒ¼
      showCard(fid,file.name,file.size,'parsing');
      setStep(2);

      try{
        var raw;
        if(ext==='csv'||ext==='txt'){
          raw=await parseCSVRaw(file);
        }else{
          raw=await parseExcelRaw(file);
        }

        //  ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚³ã‚¢ã§è‡ªå‹•æ¤œå‡º
        var detected=detectHeaderRow(raw);
        var headerIdx=detected.headerIdx;
        var autoScore=detected.score;

        //  ä½ã‚¹ã‚³ã‚¢ï¼ˆ<5ï¼‰ã¾ãŸã¯ Excelå¸³ç¥¨å‹ã®å ´åˆ â†’ ãƒ‡ãƒ¼ã‚¿ç¯„å›²è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        if(autoScore<5||(ext!=='csv'&&ext!=='txt'&&autoScore<7)){
          showCard(fid,file.name,file.size,'ready',{total:0,excluded:0,candidate:0,cols:0});
          var pickedIdx=await showHdrPicker(raw, headerIdx, autoScore);
          if(pickedIdx>=0){
            headerIdx=pickedIdx;
            //  pkStateå…¨ä½“ã‚’åæ˜ ï¼ˆãƒ•ãƒƒã‚¿ãƒ¼ãƒ»åˆ—ãƒ­ãƒ¼ãƒ«ãƒ»è²©å£²ä¼šç¤¾ã‚»ãƒ«ï¼‰
            var applied=applyPkStateToData(raw, headerIdx);
            vendorInfo=extractVendorInfo(applied.vendorText);
            currentFile.parsed={headers:applied.headers,rows:applied.dataRows};
            currentFile._headerIdx=headerIdx;
            currentFile._aboveText=applied.vendorText;
            currentFile._rawRows=raw;
            currentFile._pkColRoles=applied.colRoles;
            currentFile._confidence=estimateLocalConfidence(currentFile.parsed,vendorInfo);
            currentFile._evidence={method:'local_excel',notes:[]};
            var excludedPk=countExcluded(currentFile.parsed);
            var candidatePk=applied.dataRows.length-excludedPk;
            showCard(fid,file.name,file.size,'ready',{
              total:applied.dataRows.length,excluded:excludedPk,candidate:candidatePk,cols:applied.headers.length
            });
            return;
          }else{
            dismissCard(fid);
            return;
          }
        }

        var headersCSV=raw[headerIdx].map(function(h){return String(h).trim();});
        var dataRowsCSV=[];
        for(var i=headerIdx+1;i<raw.length;i++){
          if(raw[i].some(function(c){return String(c||'').trim();})){
            dataRowsCSV.push(raw[i]);
          }
        }

        var aboveText='';
        for(var a=0;a<headerIdx;a++){
          aboveText+=raw[a].map(function(c){return String(c||'');}).join(' ')+'\n';
        }
        vendorInfo=extractVendorInfo(aboveText);

        currentFile.parsed={headers:headersCSV,rows:dataRowsCSV};
        currentFile._headerIdx=headerIdx;
        currentFile._aboveText=aboveText;
        currentFile._rawRows=raw;
        //  ãƒ­ãƒ¼ã‚«ãƒ«æŠ½å‡ºã®ä¿¡é ¼åº¦ã‚’æ¨å®š
        currentFile._confidence=estimateLocalConfidence(currentFile.parsed,vendorInfo);
        currentFile._evidence={method:'local_excel',notes:[]};
        var excludedCSV=countExcluded(currentFile.parsed);
        var candidateCSV=dataRowsCSV.length-excludedCSV;

        showCard(fid,file.name,file.size,'ready',{
          total:dataRowsCSV.length, excluded:excludedCSV, candidate:candidateCSV, cols:headersCSV.length
        });

      }catch(err){
        console.error('Parse error:',err);
        showCard(fid,file.name,file.size,'error',null,err.message);
      }
    }

    //  ãƒ­ãƒ¼ã‚«ãƒ«æŠ½å‡ºã®ä¿¡é ¼åº¦æ¨å®šï¼ˆä»•æ§˜æ›¸æº–æ‹  confidenceç®—å‡ºï¼‰
    // +0.35 å•†å“åå–å¾— / +0.25 å˜ä¾¡å–å¾— / +0.15 å‹ç•ªå–å¾— / +0.15 è²©å£²ä¼šç¤¾å–å¾— / +0.10 æ˜ç´°3è¡Œä»¥ä¸Š
    function estimateLocalConfidence(parsed,vi){
      if(!parsed||!parsed.rows)return 0;
      var conf=0;
      var colMap=mapColumnsNew(parsed.headers,parsed.rows);
      // å•†å“åå–å¾— (+0.35)
      if(colMap.name>=0){
        var named=parsed.rows.filter(function(r){return r[colMap.name]&&r[colMap.name].trim();}).length;
        if(named>0)conf+=(parsed.rows.length>0&&named/parsed.rows.length>=0.5)?0.35:0.15;
      }
      // å˜ä¾¡å–å¾— (+0.25)
      var priceCol=(colMap.unit>=0)?colMap.unit:(colMap.amount>=0?colMap.amount:-1);
      if(priceCol>=0){
        var priced=parsed.rows.filter(function(r){return r[priceCol]&&/\d/.test(r[priceCol]);}).length;
        if(priced>0)conf+=(parsed.rows.length>0&&priced/parsed.rows.length>=0.5)?0.25:0.10;
      }
      // å‹ç•ªå–å¾— (+0.15)
      if(colMap.model>=0){
        var modeled=parsed.rows.filter(function(r){return r[colMap.model]&&r[colMap.model].trim();}).length;
        if(modeled>0)conf+=(parsed.rows.length>0&&modeled/parsed.rows.length>=0.3)?0.15:0.05;
      }
      // è²©å£²ä¼šç¤¾ (+0.15)
      if(vi&&vi.name)conf+=0.15;
      // æ˜ç´°3è¡Œä»¥ä¸Š (+0.10)
      if(parsed.rows.length>=3)conf+=0.10;
      return Math.min(conf,1.0);
    }

    // ========================================================================
    // CSV/Excel â†’ å…¨è¡Œã‚’2Dé…åˆ—ã§å–å¾—ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ä»®å®šã—ãªã„ï¼‰
    // ========================================================================
    function readText(f,enc){return new Promise(function(ok,ng){var r=new FileReader();r.onerror=function(){ng(r.error);};r.onload=function(){ok(r.result);};r.readAsText(f,enc||'UTF-8');});}
    function readBuf(f){return new Promise(function(ok,ng){var r=new FileReader();r.onerror=function(){ng(r.error);};r.onload=function(){ok(r.result);};r.readAsArrayBuffer(f);});}

    async function parseCSVRaw(f){
      var encSel=document.getElementById('encSel').value;
      var enc=(encSel==='auto')?'UTF-8':encSel;
      var t=await readText(f,enc);
      if(encSel==='auto'&&/[ï¿½]/.test(t.substring(0,500))){
        try{t=await readText(f,'Shift_JIS');}catch(e){}
      }
      var ls=t.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(function(l){return l.trim();});
      if(ls.length<2)throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆè¡Œæ•°ä¸è¶³ï¼‰');
      //  è‡ªå‹•åŒºåˆ‡ã‚Šæ–‡å­—æ¤œå‡º
      var sample=ls.find(function(l){return l.trim().length>0;})||"";
      var delim=detectDelimiter(sample);
      return ls.map(function(l){
        if(window.ONE&&typeof ONE.parseCSVLine==='function') return ONE.parseCSVLine(l,delim);
        return l.split(delim);
      });
    }

    async function parseExcelRaw(f){
      var buf=await readBuf(f);
      var wb=XLSX.read(new Uint8Array(buf),{type:'array'});
      //  æœ€å¤§6ã‚·ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦æœ€é©ãªãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æŒã¤ã‚·ãƒ¼ãƒˆã‚’é¸æŠ
      var bestSheet=wb.SheetNames[0], bestScore=0, bestRows=null;
      var sheetLimit=Math.min(wb.SheetNames.length, 6);
      for(var s=0;s<sheetLimit;s++){
        var shName=wb.SheetNames[s];
        var ws=wb.Sheets[shName];
        var range=XLSX.utils.decode_range(ws["!ref"]||"A1:A1");
        var rows=[];
        for(var r=range.s.r;r<=range.e.r;r++){
          var row=[], hasAny=false;
          for(var c=range.s.c;c<=range.e.c;c++){
            var addr=XLSX.utils.encode_cell({r:r,c:c});
            var cell=ws[addr];
            var v=cell?(cell.w!=null?cell.w:(cell.v!=null?cell.v:"")):"";
            var sv=String(v||"").trim();
            if(sv) hasAny=true;
            row.push(sv);
          }
          if(hasAny) rows.push(row);
        }
        var pick=pickHeaderRow(rows, 45);
        if(pick.score>bestScore){
          bestScore=pick.score;
          bestSheet=shName;
          bestRows=rows;
        }
        if(!bestRows) bestRows=rows;
      }
      if(!bestRows||bestRows.length<2)throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      console.log('[ExcelParse] bestSheet='+bestSheet+', score='+bestScore);
      return bestRows;
    }

    // ========================================================================
    //  ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œè‡ªå‹•æ¤œå‡ºï¼ˆé«˜ç²¾åº¦ã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹ï¼‰
    // ========================================================================
    function detectHeaderRow(rawRows){
      var pick=pickHeaderRow(rawRows, 45);
      if(pick.idx!==-1){
        console.log('[HeaderDetect] pickHeaderRow: row='+pick.idx+', score='+pick.score);
        return {headerIdx:pick.idx, score:pick.score};
      }
      // fallback: æ—§ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆHDR_WORDS + ãƒœãƒ¼ãƒŠã‚¹/ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼‰
      var HDR_WORDS=[
        {words:['å•†å“å','å“å','åç§°','å“ç›®','æ‘˜è¦','å†…å®¹','æ˜ç´°','å•†å“'],score:3},
        {words:['å‹ç•ª','å“ç•ª','å•†å“ã‚³ãƒ¼ãƒ‰','å‹å¼','è¦æ ¼'],score:2},
        {words:['æ•°é‡','å€‹æ•°','å…¥æ•°','æœ¬æ•°'],score:2},
        {words:['å˜ä¾¡','å®šä¾¡'],score:2},
        {words:['é‡‘é¡','åˆè¨ˆé‡‘é¡','ç¨è¾¼é‡‘é¡','ç¨æŠœé‡‘é¡'],score:3},
        {words:['ãƒ¡ãƒ¼ã‚«ãƒ¼','è£½é€ å…ƒ','ãƒ–ãƒ©ãƒ³ãƒ‰'],score:1},
        {words:['ã‚«ãƒ†ã‚´ãƒª','åˆ†é¡','ç¨®åˆ¥'],score:1},
      ];
      var bestIdx=0, bestScore=0;
      var limit=Math.min(rawRows.length, 30);
      for(var i=0;i<limit;i++){
        var row=rawRows[i]; if(!row||row.length<2)continue;
        var rowText=row.map(function(c){return String(c||'').trim().toLowerCase().replace(/[\sã€€]/g,'');});
        var score=0, matched={};
        for(var h=0;h<HDR_WORDS.length;h++){
          var group=HDR_WORDS[h], found=false;
          for(var w=0;w<group.words.length&&!found;w++){
            var kw=group.words[w].toLowerCase();
            for(var c=0;c<rowText.length&&!found;c++){
              if(rowText[c]&&rowText[c].indexOf(kw)>=0){score+=group.score;matched[h]=true;found=true;}
            }
          }
        }
        if(matched[0]&&(matched[4]||matched[3]))score+=3;
        var numCount=0;
        rowText.forEach(function(t){if(/^\d[\d,.]+$/.test(t))numCount++;});
        if(numCount>row.length*0.5)score-=5;
        var emptyCount=rowText.filter(function(t){return !t;}).length;
        if(emptyCount>row.length*0.5)score-=3;
        if(score>bestScore){bestScore=score;bestIdx=i;}
      }
      if(bestScore<2)bestIdx=0;
      console.log('[HeaderDetect] fallback: row='+bestIdx+', score='+bestScore);
      return {headerIdx:bestIdx, score:bestScore};
    }

    // ========================================================================
    //  è²©å£²ä¼šç¤¾æƒ…å ±ã®æŠ½å‡ºï¼ˆé«˜ç²¾åº¦ç‰ˆ - æ–°ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    // ========================================================================
    function extractVendorFromTextNew(text){
      var t=norm(text);
      var out={name:"",address:"",tel:"",contact:"",email:""};
      if(!t)return out;

      // TEL
      var telMatch=t.match(/(?:TEL|Tel|é›»è©±|Phone|ï¼´ï¼¥ï¼¬)[:\s]*((?:0\d{1,4}[-\s]?\d{1,4}[-\s]?\d{3,4})|(?:0\d{9,10}))/i)||t.match(/(0\d{1,4}[-\s]?\d{1,4}[-\s]?\d{3,4})/);
      if(telMatch) out.tel=telMatch[1]?telMatch[1].replace(/\s+/g,""):telMatch[0].replace(/\s+/g,"");

      // Postal + address
      var postal=t.match(/ã€’\s?\d{3}-\d{4}/);
      if(postal){
        var pi=t.indexOf(postal[0]);
        out.address=norm(t.slice(pi,pi+120));
      }else{
        var am=t.match(/(æ±äº¬éƒ½|åŒ—æµ·é“|(?:äº¬éƒ½|å¤§é˜ª)åºœ|.{2,3}çœŒ).{0,60}(?:å¸‚|åŒº|ç”º|æ‘).{0,80}/);
        if(am) out.address=norm(am[0]);
      }

      // Company name
      var lines=t.split(/\n|ã€€|  /).map(norm).filter(Boolean);
      var bestName="";
      for(var i=0;i<lines.length;i++){
        if(/(æ ªå¼ä¼šç¤¾|åˆåŒä¼šç¤¾|æœ‰é™ä¼šç¤¾|ä¸€èˆ¬ç¤¾å›£æ³•äºº|ç‰¹å®šéå–¶åˆ©æ´»å‹•æ³•äºº|NPOæ³•äºº)/.test(lines[i])){
          if(lines[i].length>bestName.length) bestName=lines[i];
        }
      }
      if(!bestName){
        for(var j=0;j<lines.length;j++){
          if(/å¾¡ä¸­|æ§˜/.test(lines[j])&&!/å¾¡ç¤¾|è²´ç¤¾|æ‹…å½“/.test(lines[j])){
            var cleaned=lines[j].replace(/(å¾¡ä¸­|æ§˜).*/,"").trim();
            if(cleaned&&cleaned.length>bestName.length) bestName=cleaned;
          }
        }
      }
      if(!bestName){
        for(var k=0;k<lines.length;k++){
          if(lines[k].length>=6&&!/^\d+$/.test(lines[k])&&!/(è¦‹ç©æ›¸|è«‹æ±‚æ›¸|ç´å“æ›¸|æ˜ç´°æ›¸|ç™ºæ³¨æ›¸|No\.|ç•ªå·|æ—¥ä»˜|ã€’|TEL|é›»è©±)/.test(lines[k])){
            bestName=lines[k]; break;
          }
        }
      }
      out.name=bestName.replace(/^(è²©å£²å…ƒ|ç™ºè¡Œå…ƒ|ç™ºè¡Œè€…|å¾¡è«‹æ±‚å…ˆ|ç´å…¥å…ˆ)[:\s]*/,"").trim();
      out.address=out.address.replace(/^(ä½æ‰€|æ‰€åœ¨åœ°)[:\s]*/,"").trim();
      out.tel=out.tel.replace(/^TEL[:\s]*/i,"").trim();

      // ãƒ¡ãƒ¼ãƒ«
      var emMatch=text.match(/[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}/);
      if(emMatch) out.email=emMatch[0];
      // æ‹…å½“è€…
      var tanMatch=text.match(/æ‹…å½“[:ï¼š\s]*([^\s,ã€ã€‚\n]{2,10})/);
      if(tanMatch) out.contact=tanMatch[1];

      return out;
    }

    function extractVendorInfo(text){
      return extractVendorFromTextNew(text);
    }

    function isAddressLine(line){
      if(!line)return false;
      if(/ã€’\d{3}[\-ãƒ¼]\d{4}/.test(line))return true;
      if(/(?:æ±äº¬éƒ½|åŒ—æµ·é“|(?:äº¬éƒ½|å¤§é˜ª)åºœ|.{2,3}çœŒ)/.test(line)&&/[å¸‚åŒºç”ºæ‘éƒ¡]/.test(line))return true;
      return false;
    }

    // ========================================================================
    // é™¤å¤–åˆ¤å®š
    // ========================================================================
    function shouldExclude(row,map){
      var nameIdx=(map&&map.name!==undefined)?map.name:null;
      var qtyIdx=(map&&map.qty!==undefined)?map.qty:null;
      var priceIdx=(map&&map.unitPrice!==undefined)?map.unitPrice:null;
      var amtIdx=(map&&map.amount!==undefined)?map.amount:null;

      var ni=(nameIdx!==null)?nameIdx:0;
      var name=String(row[ni]||'').trim();

      //  ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆâ—†é£Ÿå™¨ã€â—†å¨æˆ¿å‚™å“ ç­‰ï¼‰ã‚’é™¤å¤–
      var rowText=row.map(function(c){return String(c||'').trim();}).join('');
      if(/^â—†/.test(rowText.trim())) return 'keywords';

      if(RULES[0].on&&!name)return 'empty';
      if(RULES[1].on&&name){
        //  é«˜ç²¾åº¦: isProbablyTotalRow ã‚‚ä½¿ç”¨
        if(isProbablyTotalRow(name))return 'keywords';
        for(var i=0;i<EXCLUDE_WORDS.length;i++){
          if(name.indexOf(EXCLUDE_WORDS[i])>=0)return 'keywords';
        }
      }
      if(RULES[2].on){
        var hasNum=false;
        [qtyIdx,priceIdx,amtIdx].forEach(function(idx){
          if(idx!==null&&idx<row.length&&String(row[idx]||'').replace(/[,\så††Â¥]/g,'').match(/\d/))hasNum=true;
        });
        if(nameIdx===null){
          for(var j=1;j<row.length;j++){
            if(String(row[j]||'').replace(/[,\så††Â¥]/g,'').match(/\d/))hasNum=true;
          }
        }
        if(!hasNum&&name.length<=5)return 'noNumbers';
      }
      if(RULES[3].on&&name.length<=2)return 'short';
      return null;
    }

    function countExcluded(parsed){
      var c=0;
      //  å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã‚«ãƒ©ãƒ ãƒãƒƒãƒ—ã‚’ä½¿ã£ã¦åˆ¤å®š
      var colMap=mapColumnsNew(parsed.headers, parsed.rows);
      var map={};
      if(colMap.name>=0) map.name=colMap.name;
      if(colMap.qty>=0) map.qty=colMap.qty;
      if(colMap.unit>=0) map.unitPrice=colMap.unit;
      if(colMap.amount>=0) map.amount=colMap.amount;
      parsed.rows.forEach(function(r){if(shouldExclude(r,map))c++;});
      return c;
    }

    // ========================================================================
    // UI: ã‚¹ãƒ†ãƒƒãƒ—ãƒ»ã‚«ãƒ¼ãƒ‰
    // ========================================================================
    function setStep(n){
      for(var i=1;i<=4;i++){
        var el=document.getElementById('s'+i);
        if(el) el.className='step-dot'+(i<n?' done':(i===n?' active':''));
      }
    }

    function showCard(fid,name,size,status,stats,errorMsg){
      var list=document.getElementById('fileList');
      var c=document.getElementById('fc-'+fid);
      if(!c){c=document.createElement('div');c.id='fc-'+fid;list.appendChild(c);}
      var sz=size<1048576?(size/1024).toFixed(1)+' KB':(size/1048576).toFixed(1)+' MB';
      var icon=status==='error'?'':'';
      var badge='',body='',btns='';
      var cls='fcard';

      switch(status){
        case'parsing':
          var parseMsg=errorMsg||'è§£æä¸­â€¦';
          badge='<span class="fcard-badge parsing"><span class="spin"></span>'+esc(parseMsg)+'</span>';
          break;
        case'ready':
          badge='<span class="fcard-badge ready">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯</span>';
          //  ä¿¡é ¼åº¦ãƒãƒƒã‚¸
          var conf=currentFile&&currentFile._confidence;
          var confHtml='';
          if(conf!==null&&conf!==undefined){
            var confLevel=getConfidenceLevel(conf);
            var confColor=getConfidenceColor(conf);
            confHtml='<div class="fcard-conf">'
              +'<span>ä¿¡é ¼åº¦:</span>'
              +'<div class="bar"><div class="bar-fill" style="width:'+Math.round(conf*100)+'%;background:'+confColor+';"></div></div>'
              +'<span class="conf-badge '+confLevel+'">'+getConfidenceLabel(conf)+'</span>'
              +'</div>';
          }
          //  æŠ½å‡ºæ–¹æ³•ãƒãƒƒã‚¸
          var methodHtml='';
          if(currentFile&&currentFile._evidence&&currentFile._evidence.method){
            var methodLabels={
              local_pdf:' ãƒ­ãƒ¼ã‚«ãƒ«PDF',local_excel:' ãƒ­ãƒ¼ã‚«ãƒ«Excel',server:'â˜ï¸ ã‚µãƒ¼ãƒAPI',
              ocr:' OCR',local:' ãƒ­ãƒ¼ã‚«ãƒ«',pdf_text:' PDFãƒ†ã‚­ã‚¹ãƒˆ',
              'excel':' Excel',csv:' CSV',txt:' TXT',
              'ai_fix':'ğŸ¤– AIæ•´å½¢',
              'excel+ai':' Excel + ğŸ¤–AI','txt+ai':' TXT + ğŸ¤–AI',
              'pdf_text+ai':' PDF + ğŸ¤–AI','ocr+ai':' OCR + ğŸ¤–AI',
              rules:' ãƒ«ãƒ¼ãƒ«æŠ½å‡º',ai:'ğŸ¤– AIæ•´å½¢',
            };
            methodHtml='<span class="fcard-method">'+(methodLabels[currentFile._evidence.method]||currentFile._evidence.method)+'</span>';
            //  ãƒ†ãƒ³ãƒ—ãƒ¬é©ç”¨ãƒãƒƒã‚¸
            if(currentFile._evidence.template_used){
              methodHtml+=' <span class="fcard-method" style="background:#dbeafe;color:#1e40af;"> ãƒ†ãƒ³ãƒ—ãƒ¬é©ç”¨æ¸ˆ</span>';
            }
          }
          body='<div class="fcard-stats">'
            +'<span class="fcard-stat"><span class="dot" style="background:var(--text)"></span>æ¤œå‡º: <b>'+stats.total+'</b>è¡Œ</span>'
            +'<span class="fcard-stat"><span class="dot" style="background:var(--warn)"></span>è‡ªå‹•é™¤å¤–: <b>'+stats.excluded+'</b>è¡Œ</span>'
            +'<span class="fcard-stat"><span class="dot" style="background:var(--ok)"></span>å–è¾¼å€™è£œ: <b>'+stats.candidate+'</b>è¡Œ</span>'
            +'</div>'+confHtml+methodHtml;
          btns='<div class="fcard-btns"><button class="btn btn-main" onclick="openPreview()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦å–ã‚Šè¾¼ã‚€</button>'
            +(currentFile&&currentFile._rawRows?'<button class="btn btn-sub" onclick="reopenHdrPicker()"> èª­å–ã‚Šç¯„å›²ã‚’è¨­å®š</button>':'');
          //  AIæ•´å½¢ãƒœã‚¿ãƒ³: ã‚µãƒ¼ãƒæ¥ç¶šã‚ã‚Šï¼‹AIæœ‰åŠ¹ï¼‹(ä½ä¿¡é ¼ or ä¸­ä¿¡é ¼)
          if(SERVER_AVAILABLE&&AI_AVAILABLE&&conf!==null&&conf<0.85){
            btns+='<button class="btn btn-sub" onclick="retryWithAI()" style="border-color:#7c3aed;color:#7c3aed;">ğŸ¤– AIæ•´å½¢</button>';
          }
          // ã‚µãƒ¼ãƒæ¥ç¶šã‚ã‚Šï¼‹AIç„¡åŠ¹ï¼‹ä½ä¿¡é ¼ â†’ é«˜ç²¾åº¦OCRã ã‘å†è©¦è¡Œ
          else if(SERVER_AVAILABLE&&!AI_AVAILABLE&&conf!==null&&conf<0.60){
            btns+='<button class="btn btn-sub" onclick="retryHighPrecision()" style="border-color:var(--accent);color:var(--accent);">ğŸ”¬ é«˜ç²¾åº¦OCR</button>';
          }
          btns+='</div>';
          break;
        case'importing':
          badge='<span class="fcard-badge parsing"><span class="spin"></span>å–ã‚Šè¾¼ã¿ä¸­â€¦</span>';
          break;
        case'done':
          cls='fcard ok';icon='';
          badge='<span class="fcard-badge ok">å–è¾¼å®Œäº†</span>';
          body='<div class="fcard-stats">'
            +'<span class="fcard-stat">å–è¾¼: <b>'+stats.imported+'</b>ä»¶</span>'
            +'<span class="fcard-stat">é™¤å¤–: <b>'+stats.excluded+'</b>ä»¶</span>'
            +'</div>';
          if(stats.docId)btns='<div class="fcard-btns"><a class="btn btn-ok" href="confirm-items.html?docId='+stats.docId+'" style="text-decoration:none;color:#fff;">ç¢ºèªç”»é¢ã¸ â†’</a></div>';
          break;
        case'error':
          cls='fcard err';icon='';
          badge='<span class="fcard-badge err">ã‚¨ãƒ©ãƒ¼</span>';
          body='<div style="font-size:0.82rem;color:var(--err);margin-top:6px;">'+esc(errorMsg||'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ')+'</div>';
          btns='<div class="fcard-btns"><button class="btn btn-sub" onclick="dismissCard(\''+fid+'\')">âœ• é–‰ã˜ã‚‹</button>';
          //  ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚AIæ•´å½¢å†è©¦è¡Œå¯èƒ½
          if(SERVER_AVAILABLE&&AI_AVAILABLE){
            btns+='<button class="btn btn-sub" onclick="retryWithAI()" style="border-color:#7c3aed;color:#7c3aed;">ğŸ¤– AIæ•´å½¢ã§å†è©¦è¡Œ</button>';
          }else if(SERVER_AVAILABLE){
            btns+='<button class="btn btn-sub" onclick="retryHighPrecision()" style="border-color:var(--accent);color:var(--accent);">ğŸ”¬ é«˜ç²¾åº¦OCRã§å†è©¦è¡Œ</button>';
          }
          btns+='</div>';
          break;
      }
      c.className=cls;
      c.innerHTML='<div class="fcard-top"><div class="fcard-icon">'+icon+'</div><div class="fcard-info"><div class="fcard-name">'+esc(name)+'</div><div class="fcard-meta">'+sz+'</div></div>'+badge+'</div>'+body+btns;
    }

    //  Bobæ¡ˆ ãƒ¬ã‚¤ãƒ¤ãƒ¼3B: AIæ•´å½¢ã§å†è©¦è¡Œ
    async function retryWithAI(){
      if(!currentFile||!currentFile.fileObj)return;
      var fid=currentFile.fileId;
      showCard(fid,currentFile.fileName,currentFile.fileObj.size,'parsing',null,'ğŸ¤– AIæ•´å½¢ä¸­â€¦ï¼ˆGeminiæ§‹é€ åŒ–ï¼‰');
      var apiResult=await callExtractAPIHighPrecision(currentFile.fileObj);
      if(apiResult&&apiResult.items&&apiResult.items.length>0){
        currentFile._confidence=apiResult.confidence||0;
        currentFile._evidence=apiResult.evidence||{method:'ai'};
        // AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰aiAvailableãƒ•ãƒ©ã‚°ã‚‚æ›´æ–°
        if(apiResult.evidence&&apiResult.evidence.aiAvailable!==undefined) AI_AVAILABLE=apiResult.evidence.aiAvailable;
        vendorInfo={
          name:(apiResult.vendor&&apiResult.vendor.name)||'',
          address:(apiResult.vendor&&apiResult.vendor.address)||'',
          tel:(apiResult.vendor&&apiResult.vendor.tel)||'',
          contact:'',email:''
        };
        var synHeaders=['å•†å“å','å‹ç•ª','å˜ä¾¡'];
        var synRows=apiResult.items.map(function(it){
          return [it.product_name||it.name||'',it.model||'',String(it.unit_price||it.unitPrice||'')];
        });
        currentFile.parsed={headers:synHeaders,rows:synRows};
        currentFile._rawRows=null; // ã‚µãƒ¼ãƒçµæœã¯rawRowsãªã—
        var excluded=countExcluded(currentFile.parsed);
        var candidate=synRows.length-excluded;
        showCard(fid,currentFile.fileName,currentFile.fileObj.size,'ready',{
          total:synRows.length,excluded:excluded,candidate:candidate,cols:synHeaders.length
        });
        // é«˜ä¿¡é ¼ãªã‚‰è‡ªå‹•ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        if(getConfidenceLevel(apiResult.confidence||0)==='high'){
          openPreview();
        }
      }else{
        showCard(fid,currentFile.fileName,currentFile.fileObj.size,'error',null,'AIæ•´å½¢ã§ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚CSV/Excelã§ã®å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚');
      }
    }

    //  é«˜ç²¾åº¦OCRå†è©¦è¡Œï¼ˆAIæ•´å½¢ãªã—ãƒ»Vision OCR DOCUMENT_TEXT_DETECTIONã®ã¿ï¼‰
    async function retryHighPrecision(){
      if(!currentFile||!currentFile.fileObj)return;
      var fid=currentFile.fileId;
      showCard(fid,currentFile.fileName,currentFile.fileObj.size,'parsing',null,'ğŸ”¬ é«˜ç²¾åº¦OCRä¸­â€¦');
      var apiResult=await callExtractAPIHighPrecision(currentFile.fileObj);
      if(apiResult&&apiResult.items&&apiResult.items.length>0){
        currentFile._confidence=apiResult.confidence||0;
        currentFile._evidence=apiResult.evidence||{method:'ocr'};
        vendorInfo={
          name:(apiResult.vendor&&apiResult.vendor.name)||'',
          address:(apiResult.vendor&&apiResult.vendor.address)||'',
          tel:(apiResult.vendor&&apiResult.vendor.tel)||'',
          contact:'',email:''
        };
        var synHeaders=['å•†å“å','å‹ç•ª','å˜ä¾¡'];
        var synRows=apiResult.items.map(function(it){
          return [it.product_name||it.name||'',it.model||'',String(it.unit_price||it.unitPrice||'')];
        });
        currentFile.parsed={headers:synHeaders,rows:synRows};
        var excluded=countExcluded(currentFile.parsed);
        var candidate=synRows.length-excluded;
        showCard(fid,currentFile.fileName,currentFile.fileObj.size,'ready',{
          total:synRows.length,excluded:excluded,candidate:candidate,cols:synHeaders.length
        });
      }else{
        showCard(fid,currentFile.fileName,currentFile.fileObj.size,'error',null,'é«˜ç²¾åº¦OCRã§ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚CSV/Excelã§ã®å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚');
      }
    }

    function dismissCard(fid){
      var c=document.getElementById('fc-'+fid);
      if(c)c.remove();
      currentFile=null;
      setStep(1);
    }

    // ========================================================================
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«
    // ========================================================================
    function openPreview(){
      if(!currentFile||!currentFile.parsed)return;
      setStep(3);
      var p=currentFile.parsed;
      document.getElementById('pvTitle').textContent=esc(currentFile.fileName)+' ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';

      //  ä¿¡é ¼åº¦æƒ…å ±ã‚’ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã«è¡¨ç¤º
      var confText='';
      if(currentFile._confidence!==null&&currentFile._confidence!==undefined){
        confText=' ï½œ ä¿¡é ¼åº¦: '+Math.round(currentFile._confidence*100)+'%';
      }
      document.getElementById('pvSub').textContent=p.headers.length+'åˆ— Ã— '+p.rows.length+'è¡Œã‚’æ¤œå‡ºã€‚'+confText;

      buildColMap(p.headers,p.rows);
      buildVendorPanel();
      buildRules();
      applyRulesAndBuildTable();

      //  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•é©ç”¨ã‚’éš ã—ã¦ãŠã
      var autoEl=document.getElementById('tplAutoApplied');
      if(autoEl)autoEl.style.display='none';

      //  confidenceåˆ¤å®š â†’ åˆæœŸè¡¨ç¤ºã‚¿ãƒ–ã®è‡ªå‹•åˆ†å²
      var conf=currentFile._confidence;
      if(conf!==null&&conf!==undefined){
        var confLevel=getConfidenceLevel(conf);
        if(confLevel==='high'){
          // é«˜ä¿¡é ¼ â†’ è¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆç¢ºèªâ†’ç¢ºå®šï¼‰
          showPanel('rows');
        }else if(confLevel==='mid'){
          // è¦ç¢ºèª â†’ åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¿ãƒ–
          showPanel('colMap');
        }else{
          // ä½ä¿¡é ¼ â†’ åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¿ãƒ–ï¼ˆæ‰‹å‹•è£œæ­£ãŒå¿…è¦ï¼‰
          showPanel('colMap');
        }
      }else{
        showPanel('colMap');
      }

      document.getElementById('pvModal').classList.add('open');

      //  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•é©ç”¨ï¼ˆè²©å£²ä¼šç¤¾ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆï¼‰
      setTimeout(function(){
        tryAutoApplyTemplate();
      },300);
    }

    function closePreview(){
      document.getElementById('pvModal').classList.remove('open');
    }

    function showPanel(id){
      ['colMap','vendor','rules','rows','reflect'].forEach(function(p){
        var elId='panel'+p.charAt(0).toUpperCase()+p.slice(1);
        var el=document.getElementById(elId);
        if(el)el.className='mpanel'+(p===id?' show':'');
      });
      document.querySelectorAll('.mtab').forEach(function(t,i){
        t.className='mtab'+(['colMap','vendor','rules','rows','reflect'][i]===id?' active':'');
      });
      if(id==='rows')applyRulesAndBuildTable();
      if(id==='reflect')buildReflectPanel();
    }

    // ========================================================================
    // ã‚¿ãƒ–1: åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°
    // ========================================================================
    function buildColMap(headers,rows){
      var saved=loadMap(headers);
      //  ãƒ”ãƒƒã‚«ãƒ¼ã§åˆ—ãƒ­ãƒ¼ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’å„ªå…ˆ
      var pkRoles=currentFile&&currentFile._pkColRoles||null;

      var h='';
      for(var i=0;i<headers.length;i++){
        var sam=rows.length>0?String(rows[0][i]||''):'';
        // å„ªå…ˆé †: pkRoles > saved > ç©º
        var sv='';
        if(pkRoles&&pkRoles[i]) sv=pkRoles[i];
        else if(saved) sv=saved[headers[i]]||'';

        h+='<div class="mrow">';
        h+='<div class="mcol" title="'+esc(headers[i])+'">'+esc(headers[i])+'</div>';
        h+='<span class="marr">â†’</span>';
        h+='<div class="msel"><select data-col="'+i+'" onchange="onMapChange()">';
        h+='<option value="">ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰</option>';
        for(var j=0;j<FIELDS.length;j++){
          var f=FIELDS[j],sel=(sv===f.key)?' selected':'';
          h+='<option value="'+f.key+'"'+sel+'>'+f.label+'</option>';
        }
        h+='</select></div>';
        h+='<div class="msam" title="'+esc(sam)+'">ä¾‹: '+esc(sam)+'</div>';
        h+='</div>';
      }
      document.getElementById('mapRows').innerHTML=h;
      if(pkRoles&&Object.keys(pkRoles).length>0){
        // ãƒ”ãƒƒã‚«ãƒ¼ã§è¨­å®šæ¸ˆã¿ãªã‚‰autoDetectã¯ä¸è¦ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã ã‘æ›´æ–°
        onMapChange();
      }else if(!saved){
        autoDetect();
      }else{
        onMapChange();
      }
    }

    function autoDetect(){
      var sels=document.querySelectorAll('#mapRows select');
      sels.forEach(function(s){s.value='';});
      var used={};

      //  é«˜ç²¾åº¦: mapColumnsNew ã‚’ä½¿ã£ã¦ä¸»è¦åˆ—ã‚’è‡ªå‹•æ¤œå‡º
      var colMapNew=mapColumnsNew(currentFile.parsed.headers, currentFile.parsed.rows);
      var newFieldMap={name:'name',model:'model',amount:'amount',qty:'qty',unit:'unitPrice',maker:'maker'};
      for(var mk in colMapNew){
        if(colMapNew[mk]>=0&&newFieldMap[mk]){
          var fldKey=newFieldMap[mk];
          var targetSel=document.querySelector('#mapRows select[data-col="'+colMapNew[mk]+'"]');
          if(targetSel&&!used[fldKey]){
            targetSel.value=fldKey;
            used[fldKey]=true;
          }
        }
      }

      // æ®‹ã‚Šã®FIELDSã§æœªãƒãƒƒãƒ”ãƒ³ã‚°åˆ—ã‚’è£œå®Œ
      sels.forEach(function(sel){
        if(sel.value) return; // æ—¢ã«ãƒãƒƒãƒ”ãƒ³ã‚°æ¸ˆã¿
        var ci=parseInt(sel.getAttribute('data-col'));
        var cn=currentFile.parsed.headers[ci].toLowerCase().replace(/[\sã€€]/g,'');
        for(var i=0;i<FIELDS.length;i++){
          var f=FIELDS[i];if(used[f.key])continue;
          for(var p=0;p<f.p.length;p++){
            if(cn.indexOf(f.p[p].toLowerCase())>=0){sel.value=f.key;used[f.key]=true;break;}
          }
          if(used[f.key])break;
        }
      });

      //  é‡‘é¡åˆ—ã®è£œåŠ©æ¨å®š: ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„å ´åˆã€æ•°å€¤åˆ—ã‚’é‡‘é¡å€™è£œã«ã™ã‚‹
      if(!used['amount']&&!used['unitPrice']&&currentFile.parsed.rows.length>0){
        var rows=currentFile.parsed.rows;
        var headers=currentFile.parsed.headers;
        var bestCol=-1, bestScore=0;
        for(var c=0;c<headers.length;c++){
          var colScore=0;
          for(var r=0;r<Math.min(rows.length,10);r++){
            var val=String(rows[r][c]||'');
            if(/[Â¥ï¿¥]/.test(val))colScore+=3;
            else if(/^[\d,]+$/.test(val.trim())&&parseInt(val.replace(/,/g,''))>=100)colScore+=2;
            else if(/^\d/.test(val.trim()))colScore+=1;
          }
          if(colScore>bestScore&&!isColUsed(sels,c)){bestScore=colScore;bestCol=c;}
        }
        if(bestCol>=0&&bestScore>=5){
          var sel=document.querySelector('#mapRows select[data-col="'+bestCol+'"]');
          if(sel){sel.value='amount';used['amount']=true;}
        }
      }

      onMapChange();
    }

    function isColUsed(sels,colIdx){
      var used=false;
      sels.forEach(function(s){if(parseInt(s.getAttribute('data-col'))===colIdx&&s.value)used=true;});
      return used;
    }

    function getMap(){
      var m={};
      document.querySelectorAll('#mapRows select').forEach(function(s){
        var ci=parseInt(s.getAttribute('data-col')),fld=s.value;
        if(fld)m[fld]=ci;
      });
      return m;
    }
    function getMapByHeader(){
      var m={};
      document.querySelectorAll('#mapRows select').forEach(function(s){
        var ci=parseInt(s.getAttribute('data-col')),fld=s.value;
        if(fld)m[currentFile.parsed.headers[ci]]=fld;
      });
      return m;
    }
    function onMapChange(){
      applyRulesAndBuildTable();
      //  å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®çŠ¶æ…‹è¡¨ç¤º
      var map=getMap();
      var reqs=[
        {key:'name',label:'å•†å“å'},
        {key:'model',label:'å‹ç•ª'},
        {key:'unitPrice',label:'å˜ä¾¡'},
      ];
      var el=document.getElementById('colMapReqStatus');
      if(el){
        el.innerHTML=reqs.map(function(r){
          var ok=map[r.key]!==undefined;
          return '<span style="margin-right:8px;">'+(ok?'':'')+' '+r.label+'</span>';
        }).join('');
      }
    }

    // ========================================================================
    // ã‚¿ãƒ–2: è²©å£²ä¼šç¤¾
    // ========================================================================
    function buildVendorPanel(){
      var vf=[
        {key:'name',label:'ç¤¾å',auto:true},
        {key:'address',label:'ä½æ‰€',auto:true},
        {key:'tel',label:'TEL',auto:true},
        {key:'contact',label:'æ‹…å½“è€…',auto:false},
        {key:'email',label:'ãƒ¡ãƒ¼ãƒ«',auto:false},
      ];
      var h='';
      vf.forEach(function(f){
        var val=vendorInfo[f.key]||'';
        var badge=f.auto&&val?'<span style="font-size:0.7rem;color:var(--ok);margin-left:6px;">è‡ªå‹•æ¤œå‡º</span>':'';
        if(f.auto&&!val)badge='<span style="font-size:0.7rem;color:var(--muted);margin-left:6px;">æœªæ¤œå‡º</span>';
        h+='<div class="oc-row">';
        h+='<div class="oc-field">'+esc(f.label)+badge+'</div>';
        h+='<div class="oc-val"><input type="text" id="vi_'+f.key+'" value="'+esc(val)+'" placeholder="'+(f.auto?'è‡ªå‹•æ¤œå‡º':'æ‰‹å…¥åŠ›')+'"></div>';
        h+='</div>';
      });
      document.getElementById('vendorFields').innerHTML=h;
    }

    function getVendorFromUI(){
      return {
        name:(document.getElementById('vi_name')||{}).value||'',
        address:(document.getElementById('vi_address')||{}).value||'',
        tel:(document.getElementById('vi_tel')||{}).value||'',
        contact:(document.getElementById('vi_contact')||{}).value||'',
        email:(document.getElementById('vi_email')||{}).value||'',
      };
    }

    // ========================================================================
    // ã‚¿ãƒ–3: é™¤å¤–ãƒ«ãƒ¼ãƒ«
    // ========================================================================
    function buildRules(){
      var h='';
      RULES.forEach(function(r,i){
        h+='<div class="rule">';
        h+='<input type="checkbox" id="rule_'+r.id+'" '+(r.on?'checked':'')+' onchange="RULES['+i+'].on=this.checked;applyRulesAndBuildTable();">';
        h+='<div class="rule-text">'+esc(r.label)+'</div>';
        h+='<div class="rule-count" id="rc_'+r.id+'">-</div>';
        h+='</div>';
      });
      document.getElementById('rulesArea').innerHTML=h;
    }

    // ========================================================================
    // ã‚¿ãƒ–4: è¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ + çµ±è¨ˆ
    // ========================================================================
    function applyRulesAndBuildTable(){
      if(!currentFile||!currentFile.parsed)return;
      var p=currentFile.parsed, map=getMap(), rows=p.rows;
      rowFlags=[];
      var ruleCounts={empty:0,keywords:0,noNumbers:0,short:0};
      rows.forEach(function(r){
        var reason=shouldExclude(r,map);
        if(reason){rowFlags.push(false);if(ruleCounts[reason]!==undefined)ruleCounts[reason]++;}
        else{rowFlags.push(true);}
      });
      RULES.forEach(function(r){
        var el=document.getElementById('rc_'+r.id);
        if(el)el.textContent=ruleCounts[r.id]+'è¡Œ';
      });
      var af=FIELDS.filter(function(f){return map[f.key]!==undefined;});
      var included=rowFlags.filter(function(f){return f;}).length;
      var h='<table><thead><tr><th style="width:36px;">âœ“</th><th style="width:30px;">#</th>';
      if(af.length>0){
        af.forEach(function(f){h+='<th>'+f.label.replace('ï¼ˆå¿…é ˆï¼‰','').replace(' å¿…é ˆ','')+'</th>';});
      }else{
        p.headers.forEach(function(hd){h+='<th>'+esc(hd)+'</th>';});
      }
      h+='</tr></thead><tbody>';
      rows.forEach(function(row,idx){
        var on=rowFlags[idx];
        h+='<tr class="'+(on?'':'excluded')+'">';
        h+='<td><input type="checkbox" '+(on?'checked':'')+' onchange="rowFlags['+idx+']=this.checked;updStats();this.parentElement.parentElement.className=this.checked?\'\':\'excluded\';"></td>';
        h+='<td style="color:var(--muted);">'+(idx+1)+'</td>';
        if(af.length>0){
          af.forEach(function(f){h+='<td>'+esc(String(row[map[f.key]]||''))+'</td>';});
        }else{
          row.forEach(function(c){h+='<td>'+esc(String(c||''))+'</td>';});
        }
        h+='</tr>';
      });
      h+='</tbody></table>';
      document.getElementById('pvTable').innerHTML=h;
      updStats();
    }

    function checkAll(on){rowFlags=rowFlags.map(function(){return on;});applyRulesAndBuildTable();}

    function updStats(){
      if(!currentFile||!currentFile.parsed)return;
      var total=currentFile.parsed.rows.length;
      var included=rowFlags.filter(function(f){return f;}).length;
      var excluded=total-included;
      document.getElementById('pvStats').innerHTML='æ¤œå‡º: <b>'+total+'</b>è¡Œ ï½œ é™¤å¤–: <b>'+excluded+'</b>è¡Œ ï½œ å–è¾¼: <b>'+included+'</b>è¡Œ';
      document.getElementById('btnImport').textContent='å–ã‚Šè¾¼ã‚€ï¼ˆ'+included+'ä»¶ï¼‰';
      document.getElementById('btnImport').disabled=(included===0);
    }

    // ========================================================================
    // ç¢ºå®šå–ã‚Šè¾¼ã¿ï¼ˆDBä¿å­˜ï¼‰
    // ========================================================================
    async function doImport(){
      var map=getMap();
      if(map.name===undefined){alert('ã€Œå•†å“åã€åˆ—ãŒå¿…è¦ã§ã™ã€‚â‘ åˆ—ã®å‰²å½“ã§å•†å“åã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');showPanel('colMap');return;}

      //  è­¦å‘Šï¼ˆæ‹…å½“æ¥­è€…ãŒç„¡ã„å ´åˆï¼‰
      var missingReq=[];
      if(map.assignedPartnerName===undefined)missingReq.push('æ‹…å½“æ¥­è€…');
      if(missingReq.length>0){
        var ok=confirm('ä»¥ä¸‹ã®é …ç›®ãŒæœªè¨­å®šã§ã™:\nãƒ»'+missingReq.join('\nãƒ»')+'\n\næ‹…å½“æ¥­è€…ãŒæœªè¨­å®šã®å•†å“ã¯é€šå ±æ™‚ã«è‡ªå‹•å‰²å½“ã§ãã¾ã›ã‚“ã€‚\nã“ã®ã¾ã¾å–ã‚Šè¾¼ã¿ã¾ã™ã‹ï¼Ÿ');
        if(!ok)return;
      }

      var p=currentFile.parsed;
      var selectedRows=p.rows.filter(function(r,i){return rowFlags[i];});
      if(selectedRows.length===0){alert('å–ã‚Šè¾¼ã‚€è¡ŒãŒ0ä»¶ã§ã™ã€‚');return;}

      if(document.getElementById('mapSave').checked)saveMap(getMapByHeader());

      //  åæ˜ å…ˆè¨­å®šã‚’ä¿å­˜
      if(document.getElementById('reflectSave')&&document.getElementById('reflectSave').checked){
        onReflectMapChange();
        saveReflectConfig();
      }
      var refConfig=getReflectConfig();

      // è²©å£²ä¼šç¤¾æƒ…å ±ã‚’å–å¾—
      vi=getVendorFromUI();

      closePreview();
      showCard(currentFile.fileId,currentFile.fileName,currentFile.fileObj.size,'importing');
      setStep(4);

      try{
        var hash=await hashFile(currentFile.fileObj);
        
        // ========================================================================
        //  æ–°ã‚·ã‚¹ãƒ†ãƒ : Documentä¿å­˜ï¼ˆæ—¢å­˜ã®docã‚’æ›´æ–°ï¼‰
        // ========================================================================
        const existingDocs = await DocumentStorage.getDocuments(currentUser.officeCode);
        const existingDoc = existingDocs.find(d => d.docId === currentFile.fileId);
        
        if (existingDoc) {
          existingDoc.status = 'processed';
          existingDoc.vendor = vi;
          existingDoc.confidence = currentFile._confidence || 0;
          existingDoc.evidence = currentFile._evidence || {};
          await DocumentStorage.updateDocument(existingDoc);
        }

        var items=selectedRows.map(function(row,idx){
          var name=String(row[map.name]||'').trim();
          if(!name)return null;
          var raw={};p.headers.forEach(function(h,i){raw[h]=row[i];});

          var model=map.model!==undefined?String(row[map.model]||'').trim():'';
          if(!model){
            var mp=extractModelFromName(name);
            if(mp.model){model=mp.model;name=mp.name;}
          }

          var maker=map.maker!==undefined?String(row[map.maker]||'').trim():'';
          if(!maker)maker=extractMakerName(name);

          // æ‹…å½“æ¥­è€…ã®ãƒãƒƒãƒãƒ³ã‚°
          var partnerName=map.assignedPartnerName!==undefined?String(row[map.assignedPartnerName]||'').trim():'';
          var partnerId='';
          if(partnerName){
            var partners=[];
            try{partners=JSON.parse(sessionStorage.getItem('partners')||'[]');}catch(e){}
            try{var pl=JSON.parse(localStorage.getItem('partners')||'[]');pl.forEach(function(p){if(!partners.find(function(m){return m.id===p.id;}))partners.push(p);});}catch(e){}
            var matched=partners.find(function(p){
              return (p.name&&p.name===partnerName)||(p.companyName&&p.companyName===partnerName);
            });
            if(matched)partnerId=matched.id;
          }

          // å•†å“ãƒŠãƒ³ãƒãƒ¼ï¼ˆExcelã«è¨˜è¼‰ãŒã‚ã‚Œã°ä½¿ç”¨ï¼‰
          var itemId = map.itemId!==undefined?String(row[map.itemId]||'').trim():'';

          return {
            itemId: itemId,
            lineId: null,
            docId: currentFile.fileId,
            lineNumber: idx + 1,
            name: name,
            maker: maker,
            model: model,
            quantity: map.qty!==undefined?parseNumber(row[map.qty]):1,
            price: map.unitPrice!==undefined?parseNumber(row[map.unitPrice]):0,
            unit: 'å€‹',
            category: map.category!==undefined?String(row[map.category]||'').trim():'',
            assignedPartnerId: partnerId,
            assignedPartnerName: partnerName,
            status: 'pending'
          };
        }).filter(function(x){return x!==null;});

        // ========================================================================
        //  å•†å“ãƒŠãƒ³ãƒãƒ¼ã«ã‚ˆã‚‹æ–°è¦/ä¸Šæ›¸ãåˆ¤å®š
        // ========================================================================
        var existingItems = [];
        try { existingItems = JSON.parse(sessionStorage.getItem('items') || '[]'); } catch(e) {}
        try { var il = JSON.parse(localStorage.getItem('items') || '[]'); il.forEach(function(i){ if(!existingItems.find(function(m){return m.itemId===i.itemId;})) existingItems.push(i); }); } catch(e) {}

        var newItems = [];
        var updateItems = [];
        var unknownItems = [];

        items.forEach(function(item) {
          if (!item.itemId) {
            // å•†å“ãƒŠãƒ³ãƒãƒ¼ãªã— â†’ æ–°è¦
            newItems.push(item);
          } else {
            var existing = existingItems.find(function(e) { return e.itemId === item.itemId; });
            if (existing) {
              // æ—¢å­˜ â†’ ä¸Šæ›¸ãæ›´æ–°ï¼ˆç©ºæ¬„ã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç¶­æŒï¼‰
              var merged = Object.assign({}, existing);
              if (item.name) merged.name = item.name;
              if (item.maker) merged.maker = item.maker;
              if (item.model) merged.model = item.model;
              if (item.price) merged.price = item.price;
              if (item.quantity) merged.stock = item.quantity;
              if (item.category) merged.category = item.category;
              if (item.assignedPartnerId) merged.assignedPartnerId = item.assignedPartnerId;
              if (item.assignedPartnerName) merged.assignedPartnerName = item.assignedPartnerName;
              merged.updatedAt = new Date().toISOString();
              updateItems.push(merged);
            } else {
              // å­˜åœ¨ã—ãªã„ãƒŠãƒ³ãƒãƒ¼ â†’ è­¦å‘Šä»˜ãæ–°è¦
              unknownItems.push(item);
            }
          }
        });

        // ä¸Šæ›¸ãç¢ºèª
        if (updateItems.length > 0 || unknownItems.length > 0) {
          var msg = '';
          if (updateItems.length > 0) msg += 'ä¸Šæ›¸ãæ›´æ–°: ' + updateItems.length + 'ä»¶\n';
          if (unknownItems.length > 0) msg += 'ä¸æ˜ãªãƒŠãƒ³ãƒãƒ¼ï¼ˆæ–°è¦ç™»éŒ²ï¼‰: ' + unknownItems.length + 'ä»¶\n';
          msg += 'æ–°è¦ç™»éŒ²: ' + newItems.length + 'ä»¶\n\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ';
          if (!confirm(msg)) return;
        }

        // ä¸Šæ›¸ãæ›´æ–°ã‚’é©ç”¨
        updateItems.forEach(function(updated) {
          var idx = existingItems.findIndex(function(e) { return e.itemId === updated.itemId; });
          if (idx !== -1) existingItems[idx] = updated;
        });

        // ä¸æ˜ãƒŠãƒ³ãƒãƒ¼ã¯æ–°è¦æ‰±ã„
        newItems = newItems.concat(unknownItems);

        // ä¿å­˜
        if (updateItems.length > 0) {
          sessionStorage.setItem('items', JSON.stringify(existingItems));
          localStorage.setItem('items', JSON.stringify(existingItems));
        }

        console.log('[Import] æ–°è¦:' + newItems.length + 'ä»¶, æ›´æ–°:' + updateItems.length + 'ä»¶');

        // ========================================================================
        //  æ–°ã‚·ã‚¹ãƒ†ãƒ : LineItemsä¿å­˜ï¼ˆæ–°è¦åˆ†ã®ã¿ï¼‰
        // ========================================================================
        if (newItems.length > 0) {
          await DocumentStorage.addLineItems(newItems);
        }
        
        console.log('[LineItems] ä¿å­˜å®Œäº†:', newItems.length, 'ä»¶');

        var totalProcessed = newItems.length + updateItems.length;
        var excluded=p.rows.length-totalProcessed;
        showCard(currentFile.fileId,currentFile.fileName,currentFile.fileObj.size,'done',{
          imported:totalProcessed,excluded:excluded,updated:updateItems.length,docId:currentFile.fileId
        });
        try{ONE.logEvent('import_success',{fileName:currentFile.fileName,count:items.length,confidence:currentFile._confidence||0,method:(currentFile._evidence&&currentFile._evidence.method)||'local'});}catch(e){}
        // ç›£æŸ»ãƒ­ã‚°
        try{
          var auditLogs=JSON.parse(demoGetFromLocalStorage('audit.logs')||'[]');
          auditLogs.push({timestamp:new Date().toISOString(),type:'import_success',screen:'import',user:currentUser?.name||'',userId:currentUser?.userId||currentUser?.id||'',companyCode:currentUser?.companyCode||'',details:JSON.stringify({fileName:currentFile.fileName,count:items.length})});
          demoSaveToLocalStorage('audit.logs',JSON.stringify(auditLogs));
        }catch(e){}

        //  ãƒ†ãƒ³ãƒ—ãƒ¬ä¿å­˜ã®ææ¡ˆï¼ˆè²©å£²ä¼šç¤¾ãŒã‚ã‚Šãƒ†ãƒ³ãƒ—ãƒ¬æœªç™»éŒ²ãªã‚‰ï¼‰
        if(vi.name&&!findTemplateByVendor(vi.name)){
          setTimeout(function(){
            if(confirm('ã€Œ'+vi.name+'ã€ç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\næ¬¡å›åŒã˜è²©å£²ä¼šç¤¾ã®æ›¸é¡ã‚’å–ã‚Šè¾¼ã‚€ã¨ãã€åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã¨åæ˜ å…ˆãŒè‡ªå‹•é©ç”¨ã•ã‚Œã¾ã™ã€‚')){
              saveCurrentAsTemplate(vi.name+'ãƒ†ãƒ³ãƒ—ãƒ¬');
            }
          },500);
        }

      }catch(err){
        console.error('Import error:',err);
        showCard(currentFile.fileId,currentFile.fileName,currentFile.fileObj.size,'error',null,err.message);
        try{ONE.logEvent('import_error',{fileName:currentFile.fileName,error:err.message});}catch(e){}
      }
    }

    // ========================================================================
    //  ãƒ‡ãƒ¼ã‚¿ç¯„å›²ï¼†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æŒ‡å®šãƒ”ãƒƒã‚«ãƒ¼ï¼ˆæ‹¡å¼µç‰ˆï¼‰
    // ========================================================================
    var hdrPickerRawRows=null;
    var hdrPickerResolve=null;

    //  ãƒ”ãƒƒã‚«ãƒ¼çŠ¶æ…‹
    var pkState={
      mode:'header',        // 'header'|'footer'|'col'|'vendor'
      headerIdx:0,          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
      footerIdx:-1,         // ãƒ•ãƒƒã‚¿ãƒ¼è¡Œï¼ˆ-1=æœªè¨­å®š=æœ€çµ‚è¡Œã¾ã§ï¼‰
      colRoles:{},          // {colIdx: 'name'|'assignedPartnerName'|'model'|'unitPrice'|'qty'|'amount'|'maker'|'category'|'notes'}
      vendorCells:[],       // [{row,col}] è²©å£²ä¼šç¤¾ã‚»ãƒ«
    };

    var PK_ROLES=[
      {key:'name',    label:'å•†å“å ',color:'#059669',req:true},
      {key:'assignedPartnerName',label:'æ‹…å½“æ¥­è€… ',color:'#ea580c',req:true},
      {key:'model',   label:'å‹ç•ª',    color:'#7c3aed',req:false},
      {key:'unitPrice',label:'å˜ä¾¡',   color:'#dc2626',req:false},
      {key:'qty',     label:'æ•°é‡',    color:'#2563eb',req:false},
      {key:'amount',  label:'é‡‘é¡',    color:'#d97706',req:false},
      {key:'maker',   label:'ãƒ¡ãƒ¼ã‚«ãƒ¼',color:'#0891b2',req:false},
      {key:'category',label:'ã‚«ãƒ†ã‚´ãƒª',color:'#6b7280',req:false},
      {key:'notes',   label:'å‚™è€ƒ',    color:'#9ca3af',req:false},
    ];

    var PK_MODE_HINTS={
      header:'è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆåˆ—åãŒä¸¦ã‚“ã§ã„ã‚‹è¡Œï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚',
      footer:'è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ãƒƒã‚¿ãƒ¼è¡Œï¼ˆãƒ‡ãƒ¼ã‚¿ã®æœ€çµ‚è¡Œï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ãƒ•ãƒƒã‚¿ãƒ¼ã‚ˆã‚Šä¸‹ã¯å–ã‚Šè¾¼ã¿ã¾ã›ã‚“ã€‚',
      col:'ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãã®åˆ—ã®å½¹å‰²ï¼ˆå•†å“åãƒ»å‹ç•ªãƒ»å˜ä¾¡ãªã©ï¼‰ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚',
      vendor:'ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ˆã‚Šä¸Šã®é ˜åŸŸã§ã€è²©å£²ä¼šç¤¾ã®æƒ…å ±ãŒæ›¸ã‹ã‚ŒãŸã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚',
    };

    function findHeaderCandidates(rawRows, maxScan){
      maxScan=maxScan||45;
      var results=[];
      var lim=Math.min(rawRows.length, maxScan);
      for(var i=0;i<lim;i++){
        var sc=scoreHeaderRow(rawRows[i]||[]);
        if(sc>=2) results.push({idx:i, score:sc, row:rawRows[i]});
      }
      results.sort(function(a,b){return b.score-a.score;});
      return results.slice(0,5);
    }

    function isHeaderKeyword(cell){
      var t=norm(cell).replace(/\s+/g,'');
      if(!t)return false;
      for(var k in HEADER_SYNONYMS){
        if(HEADER_SYNONYMS[k][0].test(t)||HEADER_SYNONYMS[k][1].test(t))return true;
      }
      return false;
    }

    //  ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    function setPkMode(mode){
      pkState.mode=mode;
      // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ãƒœã‚¿ãƒ³
      document.querySelectorAll('.pk-mode').forEach(function(b){
        b.classList.toggle('active',b.getAttribute('data-pk-mode')===mode);
      });
      // ãƒ’ãƒ³ãƒˆ
      document.getElementById('pkModeHint').textContent=PK_MODE_HINTS[mode]||'';
      // å€™è£œã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
      var candSec=document.getElementById('hdrCandSection');
      if(candSec)candSec.style.display=(mode==='header')?'':'none';
      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ¢ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹
      var overlay=document.getElementById('hdrPickerOverlay');
      overlay.className='hdr-picker-overlay open pk-mode-'+mode;
      // ãƒ­ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—éè¡¨ç¤º
      closePkRolePopup();
    }

    //  ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼ˆã‚¾ãƒ¼ãƒ³è‰²åˆ†ã‘ä»˜ãï¼‰
    function renderPkTable(){
      var rawRows=hdrPickerRawRows;
      if(!rawRows)return;
      var maxCols=0;
      var showRows=Math.min(rawRows.length, 80);
      for(var r=0;r<showRows;r++){
        if(rawRows[r]&&rawRows[r].length>maxCols) maxCols=rawRows[r].length;
      }

      var hIdx=pkState.headerIdx;
      var fIdx=pkState.footerIdx;

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚«ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«ã‚¿ã‚°
      var colTags={};
      for(var ci in pkState.colRoles){
        var rk=pkState.colRoles[ci];
        var rl=PK_ROLES.find(function(r){return r.key===rk;});
        if(rl) colTags[ci]='<span class="pk-col-tag '+rk+'" style="background:'+rl.color+'">'+rl.label.replace(' ','')+'</span>';
      }

      // è²©å£²ä¼šç¤¾ã‚»ãƒ« â†’ Set
      var vendorSet={};
      pkState.vendorCells.forEach(function(vc){
        vendorSet[vc.row+'_'+vc.col]=true;
      });

      var th='<table><thead><tr><th style="width:36px;">#</th>';
      for(var c=0;c<maxCols;c++) th+='<th>åˆ—'+(c+1)+'</th>';
      th+='</tr></thead><tbody>';

      for(var ri=0;ri<showRows;ri++){
        // ã‚¾ãƒ¼ãƒ³ã‚¯ãƒ©ã‚¹
        var cls='';
        if(ri===hIdx) cls='pk-hdr';
        else if(fIdx>=0&&ri===fIdx) cls='pk-ftr';
        else if(fIdx>=0&&ri>fIdx) cls='pk-below-ftr';
        else if(ri<hIdx) cls='pk-above';
        else cls='pk-data';

        th+='<tr class="'+cls+'" data-raw-idx="'+ri+'" onclick="onPkRowClick('+ri+',event)">';
        th+='<td style="color:var(--muted);font-size:0.7rem;">'+(ri+1)+'</td>';
        for(var ci2=0;ci2<maxCols;ci2++){
          var val=rawRows[ri]&&rawRows[ri][ci2]?String(rawRows[ri][ci2]).trim():'';
          var tdCls='';
          var extra='';
          // è²©å£²ä¼šç¤¾ã‚»ãƒ«
          if(vendorSet[ri+'_'+ci2]) tdCls='pk-vendor-cell';
          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚«ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«ã‚¿ã‚°
          if(ri===hIdx&&colTags[ci2]){
            tdCls+=' pk-col-assigned';
            extra=colTags[ci2];
          }
          th+='<td class="'+tdCls+'" data-col="'+ci2+'" title="'+esc(val)+'" onclick="onPkCellClick('+ri+','+ci2+',event)">'+extra+esc(val)+'</td>';
        }
        th+='</tr>';
      }
      th+='</tbody></table>';
      document.getElementById('hdrRawTable').innerHTML=th;

      // ã‚µãƒãƒªãƒ¼æ›´æ–°
      updatePkSummary();
    }

    //  ã‚µãƒãƒªãƒ¼
    function updatePkSummary(){
      var h='';
      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
      h+='<div class="pk-sum-item set"> ãƒ˜ãƒƒãƒ€ãƒ¼: è¡Œ'+(pkState.headerIdx+1)+'</div>';
      // ãƒ•ãƒƒã‚¿ãƒ¼è¡Œ
      if(pkState.footerIdx>=0){
        h+='<div class="pk-sum-item set">ğŸ”š ãƒ•ãƒƒã‚¿ãƒ¼: è¡Œ'+(pkState.footerIdx+1)+'</div>';
      }else{
        h+='<div class="pk-sum-item unset">ğŸ”š ãƒ•ãƒƒã‚¿ãƒ¼: æœªè¨­å®šï¼ˆæœ€çµ‚è¡Œã¾ã§ï¼‰</div>';
      }
      // åˆ—ãƒ­ãƒ¼ãƒ«
      var assigned=Object.keys(pkState.colRoles).length;
      var reqOk=PK_ROLES.filter(function(r){return r.req;}).every(function(r){
        for(var k in pkState.colRoles){if(pkState.colRoles[k]===r.key)return true;}return false;
      });
      if(assigned>0){
        h+='<div class="pk-sum-item '+(reqOk?'set':'unset')+'"> åˆ—æŒ‡å®š: '+assigned+'åˆ—'+(reqOk?' ':'')+'</div>';
      }else{
        h+='<div class="pk-sum-item unset"> åˆ—æŒ‡å®š: æœªè¨­å®š</div>';
      }
      // è²©å£²ä¼šç¤¾
      if(pkState.vendorCells.length>0){
        var vTexts=pkState.vendorCells.map(function(vc){
          return String((hdrPickerRawRows[vc.row]||[])[vc.col]||'').trim();
        }).filter(Boolean);
        h+='<div class="pk-sum-item set"> è²©å£²ä¼šç¤¾: '+esc(vTexts.join(' / ').slice(0,30))+'</div>';
      }else{
        h+='<div class="pk-sum-item unset"> è²©å£²ä¼šç¤¾: æœªè¨­å®š</div>';
      }
      document.getElementById('pkSummary').innerHTML=h;
    }

    //  è¡Œã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
    function onPkRowClick(rowIdx, ev){
      if(pkState.mode==='header'){
        pkState.headerIdx=rowIdx;
        // ãƒ•ãƒƒã‚¿ãƒ¼ãŒãƒ˜ãƒƒãƒ€ãƒ¼ã‚ˆã‚Šä¸Šãªã‚‰è§£é™¤
        if(pkState.footerIdx>=0&&pkState.footerIdx<=rowIdx)pkState.footerIdx=-1;
        // åˆ—ãƒ­ãƒ¼ãƒ«: ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå¤‰ã‚ã£ãŸã‚‰è‡ªå‹•æ¨å®šã‚’å†å®Ÿè¡Œ
        autoAssignColRoles();
        renderPkTable();
        // å€™è£œã‚«ãƒ¼ãƒ‰ã‚‚é€£å‹•
        document.querySelectorAll('.hdr-cand').forEach(function(el){
          el.classList.toggle('selected',parseInt(el.getAttribute('data-hdr-idx'))===rowIdx);
        });
      }else if(pkState.mode==='footer'){
        if(rowIdx<=pkState.headerIdx){
          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œä»¥å‰ã¯ãƒ•ãƒƒã‚¿ãƒ¼ã«ã§ããªã„
          return;
        }
        if(pkState.footerIdx===rowIdx){
          // åŒã˜è¡Œã‚’ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ â†’ è§£é™¤
          pkState.footerIdx=-1;
        }else{
          pkState.footerIdx=rowIdx;
        }
        renderPkTable();
      }
      // col/vendor ãƒ¢ãƒ¼ãƒ‰ã®è¡Œã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–ï¼ˆã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å‡¦ç†ï¼‰
    }

    //  ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
    function onPkCellClick(rowIdx, colIdx, ev){
      if(pkState.mode==='col'){
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚»ãƒ«ã®ã¿
        if(rowIdx!==pkState.headerIdx)return;
        ev.stopPropagation();
        showPkRolePopup(colIdx, ev);
      }else if(pkState.mode==='vendor'){
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ˆã‚Šä¸Šã®ã‚»ãƒ«ã®ã¿
        if(rowIdx>=pkState.headerIdx)return;
        ev.stopPropagation();
        var val=String((hdrPickerRawRows[rowIdx]||[])[colIdx]||'').trim();
        if(!val)return;
        // ãƒˆã‚°ãƒ«
        var exists=pkState.vendorCells.findIndex(function(vc){return vc.row===rowIdx&&vc.col===colIdx;});
        if(exists>=0){
          pkState.vendorCells.splice(exists,1);
        }else{
          pkState.vendorCells.push({row:rowIdx,col:colIdx});
        }
        renderPkTable();
      }
      // header/footer ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚’æ­¢ã‚ãªã„ â†’ tr ã® onPkRowClick ã«å§”è­²
    }

    //  åˆ—ãƒ­ãƒ¼ãƒ«å‰²å½“ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
    function showPkRolePopup(colIdx, ev){
      var popup=document.getElementById('pkRolePopup');
      var currentRole=pkState.colRoles[colIdx]||'';

      var h='';
      PK_ROLES.forEach(function(r){
        var isActive=(currentRole===r.key);
        // ä»–ã®åˆ—ã§ä½¿ã‚ã‚Œã¦ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        var usedByOther=false;
        for(var k in pkState.colRoles){
          if(parseInt(k)!==colIdx&&pkState.colRoles[k]===r.key){usedByOther=true;break;}
        }
        var cls='pk-role-opt'+(isActive?' active':'');
        var suffix=r.req?' å¿…é ˆ':'';
        var usedNote=usedByOther?' ï¼ˆåˆ—'+(parseInt(Object.keys(pkState.colRoles).find(function(k2){return pkState.colRoles[k2]===r.key;}))+1)+'ã§ä½¿ç”¨ä¸­ï¼‰':'';
        h+='<div class="'+cls+'" onclick="assignPkRole('+colIdx+',\''+r.key+'\')">';
        h+='<span class="pk-r-dot" style="background:'+r.color+';"></span>';
        h+=esc(r.label+suffix+usedNote);
        h+='</div>';
      });
      // è§£é™¤
      if(currentRole){
        h+='<div class="pk-role-opt clear" onclick="assignPkRole('+colIdx+',\'\')">âœ• è§£é™¤</div>';
      }
      popup.innerHTML=h;

      // ä½ç½®
      var rect=ev.target.getBoundingClientRect();
      popup.style.left=Math.min(rect.left, window.innerWidth-180)+'px';
      popup.style.top=Math.min(rect.bottom+4, window.innerHeight-250)+'px';
      popup.style.display='block';

      // å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      setTimeout(function(){
        document.addEventListener('click',closePkRolePopupOnce,{once:true});
      },10);
    }

    function closePkRolePopup(){
      var p=document.getElementById('pkRolePopup');
      if(p)p.style.display='none';
    }
    function closePkRolePopupOnce(ev){
      var p=document.getElementById('pkRolePopup');
      if(p&&!p.contains(ev.target)){p.style.display='none';}
    }

    function assignPkRole(colIdx, roleKey){
      if(roleKey){
        // ä»–ã®åˆ—ã‹ã‚‰åŒã˜ãƒ­ãƒ¼ãƒ«ã‚’å¤–ã™
        for(var k in pkState.colRoles){
          if(pkState.colRoles[k]===roleKey) delete pkState.colRoles[k];
        }
        pkState.colRoles[colIdx]=roleKey;
      }else{
        delete pkState.colRoles[colIdx];
      }
      closePkRolePopup();
      renderPkTable();
    }

    //  åˆ—ãƒ­ãƒ¼ãƒ«è‡ªå‹•æ¨å®šï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æ–‡å­—åˆ—ã‹ã‚‰FIELDSè¾æ›¸ã§ãƒãƒƒãƒï¼‰
    function autoAssignColRoles(){
      pkState.colRoles={};
      var hRow=hdrPickerRawRows[pkState.headerIdx]||[];
      FIELDS.forEach(function(field){
        for(var ci=0;ci<hRow.length;ci++){
          if(pkState.colRoles[ci])continue; // æ—¢ã«å‰²å½“æ¸ˆã¿
          var val=String(hRow[ci]||'').trim().replace(/\s+/g,'');
          if(!val)continue;
          var matched=field.p.some(function(pat){
            return val.toLowerCase().indexOf(pat.toLowerCase())>=0;
          });
          if(matched){
            pkState.colRoles[ci]=field.key;
            break;
          }
        }
      });
    }

    //  showHdrPickerï¼ˆæ‹¡å¼µç‰ˆï¼‰
    function showHdrPicker(rawRows, autoIdx, autoScore){
      hdrPickerRawRows=rawRows;
      pkState.headerIdx=autoIdx>=0?autoIdx:0;
      pkState.footerIdx=-1;
      pkState.colRoles={};
      pkState.vendorCells=[];
      pkState.mode='header';

      // åˆ—ãƒ­ãƒ¼ãƒ«ã‚’è‡ªå‹•æ¨å®š
      autoAssignColRoles();

      // ãƒãƒƒã‚¸
      var badgeEl=document.getElementById('hdrPickerBadge');
      if(autoScore>=5){
        badgeEl.innerHTML='<div class="hdr-info-badge auto"> é«˜ç²¾åº¦ã§è‡ªå‹•æ¤œå‡ºã—ã¾ã—ãŸï¼ˆã‚¹ã‚³ã‚¢: '+autoScore+'ï¼‰</div>';
      }else if(autoScore>=3){
        badgeEl.innerHTML='<div class="hdr-info-badge manual"> è‡ªå‹•æ¤œå‡ºã—ã¾ã—ãŸãŒç¢ºä¿¡åº¦ãŒä½ã‚ã§ã™ï¼ˆã‚¹ã‚³ã‚¢: '+autoScore+'ï¼‰ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
      }else{
        badgeEl.innerHTML='<div class="hdr-info-badge low"> ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è‡ªå‹•æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚</div>';
      }

      // å€™è£œã‚«ãƒ¼ãƒ‰
      var candidates=findHeaderCandidates(rawRows);
      var ch='';
      if(candidates.length>0){
        candidates.forEach(function(c,rank){
          var sel=(c.idx===pkState.headerIdx)?'selected':'';
          ch+='<div class="hdr-cand '+sel+'" onclick="selectHdrCandidate('+c.idx+')" data-hdr-idx="'+c.idx+'">';
          ch+='<div class="hdr-cand-rank">'+(rank+1)+'</div>';
          ch+='<div class="hdr-cand-cells">';
          (c.row||[]).forEach(function(cell){
            var cv=String(cell||'').trim();
            if(!cv)return;
            var isKw=isHeaderKeyword(cv);
            ch+='<span class="hdr-cand-cell'+(isKw?' match':'')+'">'+esc(cv)+'</span>';
          });
          ch+='</div>';
          ch+='<div class="hdr-cand-score">è¡Œ'+(c.idx+1)+' / '+c.score+'pt</div>';
          ch+='</div>';
        });
      }else{
        ch='<p style="font-size:0.82rem;color:var(--muted);padding:8px;">å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';
      }
      document.getElementById('hdrCandidates').innerHTML=ch;

      // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
      setPkMode('header');

      // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
      renderPkTable();

      document.getElementById('hdrPickerOverlay').classList.add('open');
      return new Promise(function(resolve){hdrPickerResolve=resolve;});
    }

    function selectHdrCandidate(idx){
      pkState.headerIdx=idx;
      if(pkState.footerIdx>=0&&pkState.footerIdx<=idx)pkState.footerIdx=-1;
      autoAssignColRoles();
      renderPkTable();
      document.querySelectorAll('.hdr-cand').forEach(function(el){
        el.classList.toggle('selected',parseInt(el.getAttribute('data-hdr-idx'))===idx);
      });
      var selRow=document.querySelector('#hdrRawTable tr[data-raw-idx="'+idx+'"]');
      if(selRow) selRow.scrollIntoView({behavior:'smooth',block:'center'});
    }

    function selectHdrRow(idx){
      selectHdrCandidate(idx);
    }

    function confirmHdrPicker(){
      if(pkState.headerIdx<0){alert('ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');return;}
      document.getElementById('hdrPickerOverlay').classList.remove('open');
      closePkRolePopup();
      //  pkStateå…¨ä½“ã‚’è¿”ã™ï¼ˆå‘¼ã³å‡ºã—å´ã§åˆ©ç”¨ï¼‰
      if(hdrPickerResolve)hdrPickerResolve(pkState.headerIdx);
      hdrPickerResolve=null;
    }

    function closeHdrPicker(cancel){
      document.getElementById('hdrPickerOverlay').classList.remove('open');
      closePkRolePopup();
      if(cancel&&hdrPickerResolve)hdrPickerResolve(-1);
      hdrPickerResolve=null;
    }

    //  pkState â†’ åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ»è²©å£²ä¼šç¤¾ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼ã‚’å®Ÿãƒ‡ãƒ¼ã‚¿ã«åæ˜ 
    function applyPkStateToData(raw, headerIdx){
      var hIdx=pkState.headerIdx;
      var fIdx=pkState.footerIdx;

      var headers=raw[hIdx].map(function(h){return String(h).trim();});
      var dataRows=[];
      var endIdx=(fIdx>=0)?fIdx:raw.length;
      for(var i=hIdx+1;i<endIdx;i++){
        if(raw[i]&&raw[i].some(function(c){return String(c||'').trim();})){
          dataRows.push(raw[i]);
        }
      }

      // è²©å£²ä¼šç¤¾ã‚»ãƒ«ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰
      var vendorText='';
      if(pkState.vendorCells.length>0){
        pkState.vendorCells.forEach(function(vc){
          var val=String((raw[vc.row]||[])[vc.col]||'').trim();
          if(val) vendorText+=val+'\n';
        });
      }else{
        // å¾“æ¥: ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ˆã‚Šä¸Šå…¨ä½“
        for(var a=0;a<hIdx;a++){
          vendorText+=raw[a].map(function(c){return String(c||'');}).join(' ')+'\n';
        }
      }

      return {
        headers:headers,
        dataRows:dataRows,
        vendorText:vendorText,
        colRoles:pkState.colRoles,
        footerIdx:fIdx,
      };
    }

    async function reopenHdrPicker(){
      if(!currentFile||!currentFile._rawRows)return;
      var raw=currentFile._rawRows;
      var detected=detectHeaderRow(raw);
      var pickedIdx=await showHdrPicker(raw, detected.headerIdx, detected.score);
      if(pickedIdx<0)return;

      //  pkStateå…¨ä½“ã‚’åæ˜ 
      var applied=applyPkStateToData(raw, pickedIdx);
      vendorInfo=extractVendorInfo(applied.vendorText);
      currentFile.parsed={headers:applied.headers,rows:applied.dataRows};
      currentFile._headerIdx=pickedIdx;
      currentFile._aboveText=applied.vendorText;
      currentFile._pkColRoles=applied.colRoles; // åˆ—ãƒ­ãƒ¼ãƒ«ã‚‚ä¿å­˜

      var excluded=countExcluded(currentFile.parsed);
      var candidate=applied.dataRows.length-excluded;
      showCard(currentFile.fileId,currentFile.fileName,currentFile.fileObj.size,'ready',{
        total:applied.dataRows.length,excluded:excluded,candidate:candidate,cols:applied.headers.length
      });
    }

    // ========================================================================
    //  åæ˜ å…ˆãƒãƒƒãƒ”ãƒ³ã‚°
    // ========================================================================
    var REFLECT_TARGETS=[
      {id:'report',label:'é€šå ±ç”»é¢',icon:'',fields:[
        {dest:'title',destLabel:'ã‚¿ã‚¤ãƒˆãƒ«'},
        {dest:'body',destLabel:'æœ¬æ–‡'},
        {dest:'amount',destLabel:'é‡‘é¡æ¬„'},
        {dest:'contact',destLabel:'é€£çµ¡å…ˆ'},
        {dest:'category',destLabel:'ã‚«ãƒ†ã‚´ãƒª'},
      ]},
      {id:'ledger',label:'å‹•ç”£å°å¸³',icon:'',fields:[
        {dest:'assetName',destLabel:'è³‡ç”£å'},
        {dest:'modelNo',destLabel:'å‹ç•ª'},
        {dest:'maker',destLabel:'ãƒ¡ãƒ¼ã‚«ãƒ¼'},
        {dest:'purchasePrice',destLabel:'å–å¾—ä¾¡æ ¼'},
        {dest:'vendor',destLabel:'å–å¾—å…ˆï¼ˆè²©å£²ä¼šç¤¾ï¼‰'},
        {dest:'quantity',destLabel:'æ•°é‡'},
      ]},
      {id:'order',label:'ç™ºæ³¨ä¾é ¼',icon:'',fields:[
        {dest:'orderItem',destLabel:'ç™ºæ³¨å“ç›®'},
        {dest:'orderModel',destLabel:'å‹ç•ª'},
        {dest:'orderQty',destLabel:'æ•°é‡'},
        {dest:'orderPrice',destLabel:'å˜ä¾¡'},
        {dest:'orderVendor',destLabel:'ç™ºæ³¨å…ˆ'},
      ]},
      {id:'custom',label:'ã‚«ã‚¹ã‚¿ãƒ ç”»é¢',icon:'',fields:[
        {dest:'field1',destLabel:'è‡ªç”±é …ç›®1'},
        {dest:'field2',destLabel:'è‡ªç”±é …ç›®2'},
        {dest:'field3',destLabel:'è‡ªç”±é …ç›®3'},
        {dest:'field4',destLabel:'è‡ªç”±é …ç›®4'},
      ]},
    ];

    var REFLECT_SOURCES=[
      {key:'name',label:'å•†å“å',req:true},
      {key:'model',label:'å‹ç•ª',req:true},
      {key:'unitPrice',label:'å˜ä¾¡',req:true},
      {key:'vendor',label:'è²©å£²ä¼šç¤¾',req:true},
      {key:'qty',label:'æ•°é‡',req:false},
      {key:'amount',label:'é‡‘é¡',req:false},
      {key:'maker',label:'ãƒ¡ãƒ¼ã‚«ãƒ¼',req:false},
      {key:'category',label:'ã‚«ãƒ†ã‚´ãƒª',req:false},
      {key:'vendorTel',label:'è²©å£²ä¼šç¤¾TEL',req:false},
      {key:'vendorAddress',label:'è²©å£²ä¼šç¤¾ä½æ‰€',req:false},
    ];

    var reflectConfig={};

    function buildReflectPanel(){
      // å¿…é ˆé …ç›®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
      var map=getMap();
      var vi=getVendorFromUI();
      var reqChecks=[
        {label:'å•†å“å',ok:map.name!==undefined},
        {label:'å‹ç•ª',ok:map.model!==undefined},
        {label:'å˜ä¾¡',ok:map.unitPrice!==undefined},
        {label:'è²©å£²ä¼šç¤¾',ok:!!(vi.name)},
      ];
      var allOk=reqChecks.every(function(r){return r.ok;});
      var statusEl=document.getElementById('reqStatusBar');
      statusEl.className='req-status '+(allOk?'complete':'incomplete');
      var itemsH=reqChecks.map(function(r){
        return '<span class="'+(r.ok?'mapped-ok':'mapped-ng')+'">'+(r.ok?'':'')+' '+r.label+'</span>';
      }).join(' ');
      document.getElementById('reqStatusItems').innerHTML=itemsH;

      //  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠè‚¢ã‚’æ›´æ–°
      buildTplSelect();

      // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæœªé©ç”¨æ™‚ï¼‰
      if(!reflectConfig||Object.keys(reflectConfig).length===0){
        var saved=loadReflectConfig();
        if(saved)reflectConfig=saved;
      }

      // åæ˜ å…ˆã‚«ãƒ¼ãƒ‰
      var h='';
      REFLECT_TARGETS.forEach(function(target){
        var cfg=reflectConfig[target.id]||{enabled:false,mapping:{}};
        h+='<div class="ref-target" id="refTarget_'+target.id+'">';
        h+='<div class="ref-target-hdr">';
        h+='<input type="checkbox" class="ref-target-toggle" id="refToggle_'+target.id+'" '+(cfg.enabled?'checked':'')+' onchange="onReflectToggle(\''+target.id+'\',this.checked)">';
        h+='<h4>'+target.icon+' '+esc(target.label)+'</h4>';
        h+='</div>';
        h+='<div id="refFields_'+target.id+'" style="'+(cfg.enabled?'':'display:none;')+'">';
        target.fields.forEach(function(fld){
          var curVal=cfg.mapping&&cfg.mapping[fld.dest]||'';
          h+='<div class="ref-map-row">';
          h+='<div class="ref-map-src">'+esc(fld.destLabel)+'</div>';
          h+='<span class="ref-map-arrow">â†</span>';
          h+='<div class="ref-map-dest">';
          h+='<select data-target="'+target.id+'" data-dest="'+fld.dest+'" onchange="onReflectMapChange()">';
          h+='<option value="">ï¼ˆãªã—ï¼‰</option>';
          REFLECT_SOURCES.forEach(function(src){
            var badge=src.req?' ':'';
            h+='<option value="'+src.key+'"'+(curVal===src.key?' selected':'')+'>'+src.label+badge+'</option>';
          });
          h+='</select></div>';
          h+='</div>';
        });
        h+='</div>';
        h+='</div>';
      });
      document.getElementById('reflectTargets').innerHTML=h;
      updateReflectSummary();
    }

    //  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠUI
    function buildTplSelect(){
      var sel=document.getElementById('tplSelect');
      if(!sel)return;
      sel.innerHTML='<option value="">ï¼ˆæ‰‹å‹•è¨­å®šï¼‰</option>';
      allTemplates.forEach(function(tpl,idx){
        var opt=document.createElement('option');
        opt.value=String(idx);
        opt.textContent=tpl.name+(tpl.vendorPattern?' ('+tpl.vendorPattern+')':'');
        sel.appendChild(opt);
      });
    }

    function onTplSelect(){
      var sel=document.getElementById('tplSelect');
      var idx=parseInt(sel.value);
      var delBtn=document.getElementById('tplDelBtn');
      if(isNaN(idx)||idx<0||idx>=allTemplates.length){
        if(delBtn)delBtn.style.display='none';
        return;
      }
      if(delBtn)delBtn.style.display='';
      var tpl=allTemplates[idx];
      applyTemplate(tpl);
      // åæ˜ å…ˆãƒ‘ãƒãƒ«ã‚’å†æ§‹ç¯‰
      buildReflectPanel();
    }

    function deleteTplCurrent(){
      var sel=document.getElementById('tplSelect');
      var idx=parseInt(sel.value);
      if(isNaN(idx)||idx<0)return;
      var name=allTemplates[idx].name;
      if(!confirm('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ'+name+'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
      deleteTemplate(name);
      sel.value='';
      document.getElementById('tplDelBtn').style.display='none';
      buildTplSelect();
    }

    //  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•é©ç”¨ï¼ˆè²©å£²ä¼šç¤¾ãƒãƒƒãƒæ™‚ï¼‰
    function tryAutoApplyTemplate(){
      var vi=getVendorFromUI();
      if(!vi.name)return false;
      var tpl=findTemplateByVendor(vi.name);
      if(!tpl)return false;
      applyTemplate(tpl);
      document.getElementById('tplAutoApplied').style.display='';
      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã‚’åˆã‚ã›ã‚‹
      var sel=document.getElementById('tplSelect');
      if(sel){
        for(var i=0;i<allTemplates.length;i++){
          if(allTemplates[i].name===tpl.name){sel.value=String(i);break;}
        }
      }
      return true;
    }

    function onReflectToggle(targetId,enabled){
      if(!reflectConfig[targetId])reflectConfig[targetId]={enabled:false,mapping:{}};
      reflectConfig[targetId].enabled=enabled;
      var fieldsEl=document.getElementById('refFields_'+targetId);
      if(fieldsEl)fieldsEl.style.display=enabled?'':'none';
      updateReflectSummary();
    }

    function onReflectMapChange(){
      // å…¨ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’åé›†
      document.querySelectorAll('#panelReflect select[data-target]').forEach(function(sel){
        var tid=sel.getAttribute('data-target');
        var dest=sel.getAttribute('data-dest');
        if(!reflectConfig[tid])reflectConfig[tid]={enabled:false,mapping:{}};
        if(!reflectConfig[tid].mapping)reflectConfig[tid].mapping={};
        reflectConfig[tid].mapping[dest]=sel.value;
      });
      updateReflectSummary();
    }

    function updateReflectSummary(){
      var enabled=[];
      var totalMaps=0;
      REFLECT_TARGETS.forEach(function(t){
        var cfg=reflectConfig[t.id];
        if(cfg&&cfg.enabled){
          enabled.push(t.label);
          if(cfg.mapping){
            for(var k in cfg.mapping){if(cfg.mapping[k])totalMaps++;}
          }
        }
      });
      var el=document.getElementById('reflectSummary');
      if(enabled.length===0){
        el.innerHTML='åæ˜ å…ˆãŒæœªè¨­å®šã§ã™ã€‚ä¸Šã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§ç”»é¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
      }else{
        el.innerHTML='<b>'+enabled.length+'</b> ç”»é¢ï¼ˆ'+enabled.join('ã€')+'ï¼‰ã« <b>'+totalMaps+'</b> é …ç›®ã‚’åæ˜ ã—ã¾ã™ã€‚';
      }
    }

    function getReflectConfig(){
      return reflectConfig;
    }

    function saveReflectConfig(){
      try{
        var fid=demoGetFromLocalStorage(ONE.KEYS.facilityId)||'default';
        demoSaveToLocalStorage('reflect.'+fid,JSON.stringify(reflectConfig));
      }catch(e){}
    }
    function loadReflectConfig(){
      try{
        var fid=demoGetFromLocalStorage(ONE.KEYS.facilityId)||'default';
        var s=demoGetFromLocalStorage('reflect.'+fid);
        return s?JSON.parse(s):null;
      }catch(e){return null;}
    }

    // ========================================================================
    //  å‹ç•ªãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼è£œåŠ©æŠ½å‡ºï¼ˆæ—¢å­˜ã‚’ä¿æŒï¼‰
    // ========================================================================
    function extractModelFromName(name){
      // è‹±æ•°å­—+ãƒã‚¤ãƒ•ãƒ³ã§3æ–‡å­—ä»¥ä¸Šã€æ•°å­—ã‚’å«ã‚€ â†’ å‹ç•ª
      var parts=name.split(/[\sã€€]+/);
      var modelParts=[],nameParts=[];
      parts.forEach(function(p){
        if(/^[A-Za-z0-9\-\/\.\(\)]+$/.test(p)&&p.length>=3&&/\d/.test(p)){
          modelParts.push(p);
        }else{
          nameParts.push(p);
        }
      });
      if(modelParts.length>0&&nameParts.length>0){
        return {name:nameParts.join(' '),model:modelParts.join(' ')};
      }
      // JAN: ãƒ‘ã‚¿ãƒ¼ãƒ³
      var jan=name.match(/(?:JAN|EAN|UPC)[:ï¼š\s]*([\d\-]{8,14})/i);
      if(jan)return {name:name.replace(jan[0],'').trim(),model:jan[1]};
      return {name:name,model:''};
    }

    function extractMakerName(name){
      for(var i=0;i<MAKERS.length;i++){
        if(name.indexOf(MAKERS[i])>=0)return MAKERS[i];
      }
      var bm=name.match(/^([A-Za-zã‚¡-ãƒ¶ãƒ¼]{2,8})\s/);
      if(bm)return bm[1];
      return '';
    }

    async function hashFile(f){
      try{var b=await f.arrayBuffer();var h=await crypto.subtle.digest('SHA-256',b);return Array.from(new Uint8Array(h)).map(function(x){return x.toString(16).padStart(2,'0');}).join('').slice(0,16);}catch(e){return ONE.randId('H');}
    }

    // ãƒãƒƒãƒ”ãƒ³ã‚°ä¿å­˜/èª­è¾¼
    function mapKey(){
      var fid=demoGetFromLocalStorage(ONE.KEYS.facilityId)||'default';
      var hh=currentFile.parsed.headers.join('|').toLowerCase();
      return 'mapping.'+fid+'.'+sHash(hh);
    }
    function sHash(s){var h=0;for(var i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return Math.abs(h).toString(36);}
    function saveMap(hm){try{demoSaveToLocalStorage(mapKey(),JSON.stringify(hm));}catch(e){}}
    function loadMap(headers){
      try{
        var saved=demoGetFromLocalStorage(mapKey());
        if(!saved)return null;
        var s=JSON.parse(saved);
        var ok=Object.keys(s).every(function(h){return headers.indexOf(h)>=0;});
        return ok?s:null;
      }catch(e){return null;}
    }

    function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}


    // ========================================================================
    //  ãƒ­ãƒ¼ã‚«ãƒ«OCRå‰Šé™¤æ¸ˆã¿ â€” OCRå‡¦ç†ã¯ã‚µãƒ¼ãƒå´ GCP Vision API ã§å®Ÿè¡Œ
    // Tesseract.js å®Œå…¨é™¤å»ã€‚PDF/ç”»åƒã¯ /api/import/extract ã§ä¸€æ‹¬å‡¦ç†ã€‚
    // handleFile() â†’ callExtractAPI() â†’ ã‚µãƒ¼ãƒ(L1ç›´æ¥ãƒ‘ãƒ¼ã‚¹/L2 OCR/L3æ§‹é€ åŒ–)
    // ========================================================================

  </script>

    <script>
    // çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼åˆæœŸåŒ–
    UnifiedHeader.init({
        icon: '',
        title: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆ',
        backButton: true
    });
    </script>
</body>
</html>
