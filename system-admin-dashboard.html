<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | ãƒ¯ãƒ³ã‚¿ãƒƒãƒç®¡ç†</title>
    <script src="demo-mode.js"></script>
    <script src="unified-header.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 24px; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰ */
        .header {
            background: #fff; border-radius: 14px; padding: 24px 28px; margin-bottom: 24px;
            border: 1px solid #e8e8e8; box-shadow: 0 1px 3px rgba(0,0,0,0.03);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-badge {
            background: #1a1a1a; color: #fff; padding: 10px 20px; border-radius: 10px;
            font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 8px;
        }
        .header-title h1 { font-size: 22px; color: #1a1a1a; margin-bottom: 2px; font-weight: 700; }
        .header-title p { font-size: 13px; color: #888; }
        .header-right { display: flex; gap: 10px; align-items: center; }
        .btn-back {
            background: #f5f5f5; color: #666; border: none; padding: 10px 20px; border-radius: 8px;
            cursor: pointer; font-weight: 600; transition: all 0.2s; text-decoration: none;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-back:hover { background: #eee; }
        .btn-logout { background: #1a1a1a; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-logout:hover { background: #333; }

        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card {
            background: #fff; border-radius: 14px; padding: 24px;
            border: 1px solid #e8e8e8; box-shadow: 0 1px 3px rgba(0,0,0,0.03); transition: all 0.2s;
        }
        .stat-card:hover { border-color: #ccc; }
        .stat-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .stat-card-icon { width: 28px; height: 28px; color: #888; }
        .stat-card-label { font-size: 13px; color: #888; font-weight: 600; }
        .stat-card-value { font-size: 32px; font-weight: 700; color: #1a1a1a; margin-bottom: 6px; }
        .stat-card-detail { font-size: 12px; color: #aaa; }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .section {
            background: #fff; border-radius: 14px; padding: 28px; margin-bottom: 20px;
            border: 1px solid #e8e8e8; box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 14px; border-bottom: 1px solid #eee; }
        .section-title { font-size: 17px; font-weight: 700; color: #1a1a1a; display: flex; align-items: center; gap: 10px; }
        .section-icon { width: 20px; height: 20px; color: #888; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #fafafa; }
        th { text-align: left; padding: 10px 14px; font-weight: 600; color: #888; font-size: 12px; border-bottom: 1px solid #eee; }
        td { padding: 14px; border-bottom: 1px solid #f5f5f5; color: #1a1a1a; font-size: 13px; }
        tr:hover { background: #fafafa; }

        .status-badge { display: inline-block; padding: 3px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; }
        .status-active { background: #ecfdf5; color: #065f46; }
        .status-inactive { background: #fef2f2; color: #991b1b; }
        .btn-toggle { padding: 6px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s; }
        .btn-enable { background: #1a1a1a; color: #fff; }
        .btn-enable:hover { background: #333; }
        .btn-disable { background: #dc2626; color: #fff; }
        .btn-disable:hover { background: #b91c1c; }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .export-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-label { font-size: 13px; font-weight: 600; color: #1a1a1a; }
        .form-select, .form-input { padding: 10px 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; background: #fff; }
        .form-select:focus, .form-input:focus { outline: none; border-color: #999; box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        .btn-export { background: #1a1a1a; color: #fff; border: none; padding: 12px 28px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; }
        .btn-export:hover { background: #333; }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
        .ranking-list { display: flex; flex-direction: column; gap: 10px; }
        .ranking-item { display: flex; align-items: center; gap: 14px; padding: 14px; background: #fafafa; border-radius: 10px; border: 1px solid #f0f0f0; }
        .ranking-item:hover { background: #f5f5f5; }
        .ranking-number { font-size: 20px; font-weight: 700; color: #1a1a1a; min-width: 36px; text-align: center; }
        .ranking-info { flex: 1; }
        .ranking-name { font-weight: 600; color: #1a1a1a; margin-bottom: 2px; font-size: 14px; }
        .ranking-detail { font-size: 12px; color: #888; }
        .ranking-value { font-size: 18px; font-weight: 700; color: #1a1a1a; }

        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 16px; }
            .header-left { flex-direction: column; width: 100%; }
            .header-right { width: 100%; justify-content: space-between; }
            .stats-grid { grid-template-columns: 1fr; }
            .export-form { grid-template-columns: 1fr; }
        }
    </style>
    <meta name="theme-color" content="#1a1a1a">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
</head>
<body>
    <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div id="unified-header-mount"></div>
    <div class="container">
        <!-- å…¨ä½“çµ±è¨ˆ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-label">ç·ä¼šç¤¾æ•°</div>
                    <div class="stat-card-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="9" y1="6" x2="9" y2="6.01"/><line x1="15" y1="6" x2="15" y2="6.01"/><line x1="9" y1="10" x2="9" y2="10.01"/><line x1="15" y1="10" x2="15" y2="10.01"/><line x1="9" y1="14" x2="15" y2="14"/></svg></div>
                </div>
                <div class="stat-card-value" id="totalCompanies">0</div>
                <div class="stat-card-detail">ç™»éŒ²æ¸ˆã¿ä¼æ¥­</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-label">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</div>
                    <div class="stat-card-icon">ğŸ‘¥</div>
                </div>
                <div class="stat-card-value" id="totalUsers">0</div>
                <div class="stat-card-detail">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-label">ç·é€šå ±æ•°</div>
                    <div class="stat-card-icon">ğŸ“¢</div>
                </div>
                <div class="stat-card-value" id="totalReports">0</div>
                <div class="stat-card-detail">ç´¯è¨ˆé€šå ±ä»¶æ•°</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-label">ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡</div>
                    <div class="stat-card-icon">ğŸ’¾</div>
                </div>
                <div class="stat-card-value" id="totalStorage">0</div>
                <div class="stat-card-detail">KB / 10MB</div>
            </div>
        </div>

        <!-- ä¼šç¤¾åˆ¥ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon"></span>
                    ä¼šç¤¾åˆ¥ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé€šå ±æ•°ï¼‰
                </div>
            </div>
            <div class="ranking-list" id="rankingList">
                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å…¨ä¼šç¤¾ç®¡ç† -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="9" y1="6" x2="9" y2="6.01"/><line x1="15" y1="6" x2="15" y2="6.01"/><line x1="9" y1="10" x2="15" y2="10"/></svg></span>
                    å…¨ä¼šç¤¾ä¸€è¦§ãƒ»ç®¡ç†
                </div>
            </div>
            <div class="table-container">
                <table id="companiesTable">
                    <thead>
                        <tr>
                            <th>ä¼šç¤¾ã‚³ãƒ¼ãƒ‰</th>
                            <th>ä¼šç¤¾å</th>
                            <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</th>
                            <th>äº‹æ¥­æ‰€æ•°</th>
                            <th>é€šå ±æ•°</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="companiesTableBody">
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon">ğŸ“¤</span>
                    ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </div>
            </div>
            <div class="export-form">
                <div class="form-group">
                    <label class="form-label">ãƒ‡ãƒ¼ã‚¿å½¢å¼</label>
                    <select class="form-select" id="exportFormat">
                        <option value="csv">CSVå½¢å¼</option>
                        <option value="json">JSONå½¢å¼</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥</label>
                    <select class="form-select" id="exportType">
                        <option value="all">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿</option>
                        <option value="companies">ä¼šç¤¾æƒ…å ±</option>
                        <option value="offices">äº‹æ¥­æ‰€æƒ…å ±</option>
                        <option value="accounts">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</option>
                        <option value="reports">é€šå ±ãƒ‡ãƒ¼ã‚¿</option>
                        <option value="partners">å–å¼•å…ˆæƒ…å ±</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æœŸé–“ï¼ˆé–‹å§‹ï¼‰</label>
                    <input type="date" class="form-input" id="exportStartDate">
                </div>
                <div class="form-group">
                    <label class="form-label">æœŸé–“ï¼ˆçµ‚äº†ï¼‰</label>
                    <input type="date" class="form-input" id="exportEndDate">
                </div>
            </div>
            <button class="btn-export" onclick="exportGlobalData()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
        </div>

        <!-- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-icon">ğŸ”§</span>
                    ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰
                </div>
            </div>
            <div style="background: #fff8e1; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #f59e0b;">æ³¨æ„</div>
                <div style="font-size: 14px; color: #666;">
                    ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ä»¥å¤–ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚<br>
                    å…¨ä¼šç¤¾ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å½±éŸ¿ã—ã¾ã™ã€‚
                </div>
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 16px;">
                <div>
                    <div style="font-weight: 600; margin-bottom: 4px; font-size: 16px;">ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰</div>
                    <div style="font-size: 13px; color: #666;">ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ</div>
                </div>
                <label style="position: relative; display: inline-block; width: 60px; height: 34px;">
                    <input type="checkbox" id="maintenanceMode" onchange="toggleMaintenanceMode()" style="opacity: 0; width: 0; height: 0;">
                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
                    <span style="position: absolute; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                </label>
            </div>
            <div id="maintenanceMessage" style="display:none;">
                <div class="form-group">
                    <label class="form-label">ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                    <input type="text" class="form-input" id="maintenanceText" placeholder="ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" value="ç¾åœ¨ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚">
                </div>
            </div>
        </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢ -->
    <div class="section">
        <div class="section-header">
            <div class="section-title">
                <span class="section-icon">ğŸ’¾</span>
                ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢
            </div>
        </div>

        <!-- æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æƒ…å ± -->
        <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">ğŸ“… æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
            <div id="lastBackupInfo" style="font-size: 14px; color: #333; font-weight: 600;">ã¾ã ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</div>
            <div id="backupWarning" style="display: none; margin-top: 8px; color: #dc2626; font-size: 13px;">
                30æ—¥ä»¥ä¸Šãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼æ—©ã‚ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãã ã•ã„ã€‚
            </div>
        </div>

        <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
        <div style="margin-bottom: 24px;">
            <div style="font-weight: 600; margin-bottom: 12px; font-size: 15px;">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰</div>
            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                <div style="font-size: 13px; color: #666; margin-bottom: 8px;">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿:</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; font-size: 13px;">
                    <div>âœ“ ä¼šç¤¾ãƒã‚¹ã‚¿</div>
                    <div>âœ“ äº‹æ¥­æ‰€ãƒã‚¹ã‚¿</div>
                    <div>âœ“ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒã‚¹ã‚¿</div>
                    <div>âœ“ æ¥­è€…ãƒã‚¹ã‚¿</div>
                    <div>âœ“ é€šå ±ãƒ‡ãƒ¼ã‚¿</div>
                    <div>âœ“ å•†å“ãƒã‚¹ã‚¿</div>
                    <div>âœ“ ç›£æŸ»ãƒ­ã‚°</div>
                    <div>âœ“ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</div>
                </div>
            </div>
            <button onclick="exportAllData()" style="background: #667eea; color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; width: 100%; transition: all 0.2s;">
                ğŸ’¾ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSONå½¢å¼ï¼‰
            </button>
        </div>

        <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
        <div>
            <div style="font-weight: 600; margin-bottom: 12px; font-size: 15px;">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå¾©å…ƒï¼‰</div>
            <div style="background: #fff8e1; border: 1px solid #ffe082; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                <div style="color: #856404; font-size: 13px;">
                    æ³¨æ„: ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚äº‹å‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
                </div>
            </div>
            <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importAllData(event)">
            <button onclick="document.getElementById('importFileInput').click()" style="background: #757575; color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; width: 100%; transition: all 0.2s;">
                ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦å¾©å…ƒ
            </button>
        </div>
    </div>

    <!-- æ¥­è€…Ã—ä¼šç¤¾ å¥‘ç´„ä¸€è¦§ -->
    <div class="section">
        <div class="section-header">
            <div class="section-title">
                <span class="section-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6"/><path d="M23 11h-6"/></svg></span>
                å¥‘ç´„ä¸€è¦§ï¼ˆæ¥­è€… Ã— ä¼šç¤¾ï¼‰
            </div>
        </div>
        <div class="table-container">
            <table class="data-table" id="contractTable">
                <thead>
                    <tr>
                        <th>æ¥­è€…ã‚³ãƒ¼ãƒ‰</th>
                        <th>æ¥­è€…å</th>
                        <th>å¥‘ç´„ä¼šç¤¾</th>
                        <th>æ‹…å½“è€…</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="contractTableBody">
                    <!-- JSã§å‹•çš„ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        <div style="margin-top: 12px; font-size: 12px; color: #aaa;">
            ç´ã¥ã‘ã®å¤‰æ›´ã¯<a href="partner-master.html" style="color:#666;">å–å¼•å…ˆãƒã‚¹ã‚¿</a>ã‹ã‚‰è¡Œãˆã¾ã™
        </div>
    </div>

    <!-- å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ– -->
    <div class="section" style="border: 2px solid #dc2626;">
        <div class="section-header">
            <div class="section-title">
                <span class="section-icon"></span>
                å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
            </div>
        </div>
        <div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <div style="color: #991b1b; font-size: 14px; font-weight: 600; margin-bottom: 8px;">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“</div>
            <div style="color: #991b1b; font-size: 13px; line-height: 1.6;">
                å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆä¼šç¤¾ãƒ»äº‹æ¥­æ‰€ãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»æ¥­è€…ãƒ»é€šå ±ãƒ»å•†å“ãƒ»ç›£æŸ»ãƒ­ã‚°ãƒ»ã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚<br>
                DEMOã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼‰ã®ã¿æ®‹ã‚Šã¾ã™ã€‚<br>
                æœ¬ç•ªé‹ç”¨å‰ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
            </div>
        </div>
        <button onclick="clearAllData()" style="background: #dc2626; color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; width: 100%; transition: all 0.2s;">
             å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹
        </button>
    </div>

    </div><!-- /.container -->

    <script>
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser || currentUser.role !== 'system_admin') {
            alert('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
            window.location.href = 'login.html';
        }

        // åˆæœŸåŒ–
        function init() {
            loadGlobalStats();
            loadCompaniesTable();
            loadActivityRanking();
        }

        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆsession+localStorageä¸¡æ–¹ãƒãƒ¼ã‚¸ï¼‰
        function getMergedData(key) {
            let fromSession = [];
            let fromLocal = [];
            try { fromSession = JSON.parse(sessionStorage.getItem(key) || '[]'); } catch(e) {}
            try { fromLocal = JSON.parse(localStorage.getItem(key) || '[]'); } catch(e) {}
            // é‡è¤‡æ’é™¤ãƒãƒ¼ã‚¸ï¼ˆidãƒ™ãƒ¼ã‚¹ï¼‰
            const merged = [...fromSession];
            fromLocal.forEach(r => {
                const idField = r.id || r.code || r.itemId || r.userId || JSON.stringify(r);
                if (!merged.find(m => (m.id || m.code || m.itemId || m.userId || JSON.stringify(m)) === idField)) {
                    merged.push(r);
                }
            });
            return merged;
        }

        // å…¨ä½“çµ±è¨ˆèª­ã¿è¾¼ã¿
        function loadGlobalStats() {
            try {
                // ä¼šç¤¾æ•°
                const companies = getMergedData('companies');
                document.getElementById('totalCompanies').textContent = companies.length;

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
                const accounts = getMergedData('accounts');
                document.getElementById('totalUsers').textContent = accounts.length;

                // é€šå ±æ•°
                const reports = getMergedData('onetouch.reports');
                document.getElementById('totalReports').textContent = reports.length;

                // ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage.getItem(key).length + key.length;
                    }
                }
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key && (key.startsWith('onetouch.') || key.startsWith('demo.'))) {
                        totalSize += sessionStorage.getItem(key).length + key.length;
                    }
                }
                const sizeKB = (totalSize / 1024).toFixed(2);
                document.getElementById('totalStorage').textContent = sizeKB;
            } catch (e) {
                console.error('çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        // ä¼šç¤¾åˆ¥ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ©ãƒ³ã‚­ãƒ³ã‚°
        function loadActivityRanking() {
            try {
                const companies = getMergedData('companies');
                const reports = getMergedData('onetouch.reports');
                const companyReportCounts = {};
                companies.forEach(company => {
                    const count = reports.filter(r => r.companyCode === company.code).length;
                    companyReportCounts[company.code] = {
                        name: company.name,
                        count: count
                    };
                });

                // ã‚½ãƒ¼ãƒˆ
                const ranking = Object.entries(companyReportCounts)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 5);

                // è¡¨ç¤º
                const rankingList = document.getElementById('rankingList');
                if (ranking.length === 0) {
                    rankingList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                rankingList.innerHTML = ranking.map((item, index) => `
                    <div class="ranking-item">
                        <div class="ranking-number">${index + 1}</div>
                        <div class="ranking-info">
                            <div class="ranking-name">${item[1].name}</div>
                            <div class="ranking-detail">ä¼šç¤¾ã‚³ãƒ¼ãƒ‰: ${item[0]}</div>
                        </div>
                        <div class="ranking-value">${item[1].count} ä»¶</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        // å…¨ä¼šç¤¾ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿
        function loadCompaniesTable() {
            try {
                const companies = getMergedData('companies');
                const offices = getMergedData('offices');
                const accounts = getMergedData('accounts');
                const reports = getMergedData('onetouch.reports');

                const tbody = document.getElementById('companiesTableBody');

                if (companies.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">ä¼šç¤¾ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
                    return;
                }

                tbody.innerHTML = companies.map(company => {
                    const userCount = accounts.filter(a => a.companyCode === company.code).length;
                    const officeCount = offices.filter(o => o.companyCode === company.code).length;
                    const reportCount = reports.filter(r => r.companyCode === company.code).length;
                    const isActive = company.status !== 'inactive';

                    return `
                        <tr>
                            <td><strong>${company.code}</strong></td>
                            <td>${company.name}</td>
                            <td>${userCount} äºº</td>
                            <td>${officeCount} æ‹ ç‚¹</td>
                            <td>${reportCount} ä»¶</td>
                            <td>
                                <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                                    ${isActive ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}
                                </span>
                            </td>
                            <td>
                                <button class="btn-toggle ${isActive ? 'btn-disable' : 'btn-enable'}" 
                                        onclick="toggleCompanyStatus('${company.code}', ${isActive})">
                                    ${isActive ? 'ç„¡åŠ¹åŒ–' : 'æœ‰åŠ¹åŒ–'}
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('ä¼šç¤¾ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        // ä¼šç¤¾ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–
        function toggleCompanyStatus(companyCode, currentlyActive) {
            const action = currentlyActive ? 'ç„¡åŠ¹åŒ–' : 'æœ‰åŠ¹åŒ–';
            if (!confirm(`ä¼šç¤¾ã€Œ${companyCode}ã€ã‚’${action}ã—ã¾ã™ã‹ï¼Ÿ\n\n${currentlyActive ? 'ã“ã®ä¼šç¤¾ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³ã§ããªããªã‚Šã¾ã™ã€‚' : 'ã“ã®ä¼šç¤¾ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚'}`)) {
                return;
            }

            try {
                const companies = JSON.parse(localStorage.getItem('companies') || '[]');
                const index = companies.findIndex(c => c.code === companyCode);
                
                if (index !== -1) {
                    companies[index].status = currentlyActive ? 'inactive' : 'active';
                    localStorage.setItem('companies', JSON.stringify(companies));
                    alert(`ä¼šç¤¾ã‚’${action}ã—ã¾ã—ãŸ`);
                    loadCompaniesTable();
                    loadGlobalStats();
                }
            } catch (e) {
                console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportGlobalData() {
            const format = document.getElementById('exportFormat').value;
            const type = document.getElementById('exportType').value;
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;

            try {
                let data = {};
                
                if (type === 'all' || type === 'companies') {
                    data.companies = JSON.parse(localStorage.getItem('companies') || '[]');
                }
                if (type === 'all' || type === 'offices') {
                    data.offices = JSON.parse(localStorage.getItem('offices') || '[]');
                }
                if (type === 'all' || type === 'accounts') {
                    data.accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                }
                if (type === 'all' || type === 'reports') {
                    let reports = JSON.parse(localStorage.getItem('onetouch.reports') || '[]');
                    
                    // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿
                    if (startDate || endDate) {
                        reports = reports.filter(r => {
                            const reportDate = new Date(r.timestamp);
                            if (startDate && reportDate < new Date(startDate)) return false;
                            if (endDate && reportDate > new Date(endDate + 'T23:59:59')) return false;
                            return true;
                        });
                    }
                    
                    data.reports = reports;
                }
                if (type === 'all' || type === 'partners') {
                    data.partners = JSON.parse(localStorage.getItem('partners') || '[]');
                }

                // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                let content, filename, mimeType;

                if (format === 'json') {
                    content = JSON.stringify(data, null, 2);
                    filename = `global-export-${new Date().toISOString().split('T')[0]}.json`;
                    mimeType = 'application/json';
                } else {
                    // CSVå¤‰æ›ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                    let csv = '';
                    for (let key in data) {
                        if (data[key] && data[key].length > 0) {
                            csv += `\n${key}\n`;
                            const headers = Object.keys(data[key][0]);
                            csv += headers.join(',') + '\n';
                            data[key].forEach(item => {
                                csv += headers.map(h => JSON.stringify(item[h] || '')).join(',') + '\n';
                            });
                        }
                    }
                    content = csv;
                    filename = `global-export-${new Date().toISOString().split('T')[0]}.csv`;
                    mimeType = 'text/csv';
                }

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);

                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
            } catch (e) {
                console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', e);
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleMaintenanceMode() {
            const checkbox = document.getElementById('maintenanceMode');
            const messageDiv = document.getElementById('maintenanceMessage');
            
            if (checkbox.checked) {
                if (!confirm('ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã«ã—ã¾ã™ã€‚\n\nã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ä»¥å¤–ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                    checkbox.checked = false;
                    return;
                }
                messageDiv.style.display = 'block';
                localStorage.setItem('maintenanceMode', 'true');
                alert('ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸã€‚\n\nã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ä»¥å¤–ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚');
            } else {
                messageDiv.style.display = 'none';
                localStorage.removeItem('maintenanceMode');
                alert('ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸã€‚\n\nå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚');
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
            const text = document.getElementById('maintenanceText').value;
            localStorage.setItem('maintenanceMessage', text);
        }

        // ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿
        function loadMaintenanceMode() {
            const isMaintenanceMode = localStorage.getItem('maintenanceMode') === 'true';
            const checkbox = document.getElementById('maintenanceMode');
            const messageDiv = document.getElementById('maintenanceMessage');
            
            if (isMaintenanceMode) {
                checkbox.checked = true;
                messageDiv.style.display = 'block';
            }
            
            const message = localStorage.getItem('maintenanceMessage');
            if (message) {
                document.getElementById('maintenanceText').value = message;
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                sessionStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportAllData() {
            try {
                const backupData = {
                    exportDate: new Date().toISOString(),
                    exportedBy: currentUser.userId,
                    version: '1.0',
                    data: {
                        companies: JSON.parse(localStorage.getItem('companies') || '[]'),
                        offices: JSON.parse(localStorage.getItem('offices') || '[]'),
                        accounts: JSON.parse(localStorage.getItem('accounts') || '[]'),
                        partners: JSON.parse(localStorage.getItem('partners') || '[]'),
                        reports: JSON.parse(localStorage.getItem('onetouch.reports') || '[]'),
                        items: JSON.parse(sessionStorage.getItem('demo.items') || localStorage.getItem('items') || '[]'),
                        auditLogs: JSON.parse(localStorage.getItem('audit.logs') || '[]'),
                        maintenanceMode: localStorage.getItem('maintenanceMode'),
                        maintenanceMessage: localStorage.getItem('maintenanceMessage')
                    }
                };

                // JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const jsonStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                a.href = url;
                a.download = `onetouch-backup-${timestamp}.json`;
                a.click();
                URL.revokeObjectURL(url);

                // æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ—¥æ™‚ã‚’ä¿å­˜
                localStorage.setItem('lastBackupDate', new Date().toISOString());
                updateLastBackupInfo();

                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚');
            } catch (e) {
                console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', e);
                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('æ³¨æ„: ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚\n\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);

                    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    if (!backupData.data) {
                        throw new Error('ç„¡åŠ¹ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
                    }

                    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                    const exportDate = new Date(backupData.exportDate).toLocaleString('ja-JP');
                    const dataCount = {
                        companies: backupData.data.companies?.length || 0,
                        offices: backupData.data.offices?.length || 0,
                        accounts: backupData.data.accounts?.length || 0,
                        partners: backupData.data.partners?.length || 0,
                        reports: backupData.data.reports?.length || 0,
                        items: backupData.data.items?.length || 0,
                        auditLogs: backupData.data.auditLogs?.length || 0
                    };

                    const confirmMessage = `ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æƒ…å ±:\n\n` +
                        `ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ—¥æ™‚: ${exportDate}\n` +
                        `ä¼šç¤¾: ${dataCount.companies}ä»¶\n` +
                        `äº‹æ¥­æ‰€: ${dataCount.offices}ä»¶\n` +
                        `ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: ${dataCount.accounts}ä»¶\n` +
                        `æ¥­è€…: ${dataCount.partners}ä»¶\n` +
                        `é€šå ±: ${dataCount.reports}ä»¶\n` +
                        `å•†å“: ${dataCount.items}ä»¶\n` +
                        `ç›£æŸ»ãƒ­ã‚°: ${dataCount.auditLogs}ä»¶\n\n` +
                        `ã“ã®ãƒ‡ãƒ¼ã‚¿ã§å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ`;

                    if (!confirm(confirmMessage)) {
                        event.target.value = '';
                        return;
                    }

                    // ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
                    if (backupData.data.companies) localStorage.setItem('companies', JSON.stringify(backupData.data.companies));
                    if (backupData.data.offices) localStorage.setItem('offices', JSON.stringify(backupData.data.offices));
                    if (backupData.data.accounts) localStorage.setItem('accounts', JSON.stringify(backupData.data.accounts));
                    if (backupData.data.partners) localStorage.setItem('partners', JSON.stringify(backupData.data.partners));
                    if (backupData.data.reports) localStorage.setItem('onetouch.reports', JSON.stringify(backupData.data.reports));
                    if (backupData.data.items) localStorage.setItem('items', JSON.stringify(backupData.data.items));
                    if (backupData.data.auditLogs) localStorage.setItem('audit.logs', JSON.stringify(backupData.data.auditLogs));
                    if (backupData.data.maintenanceMode) localStorage.setItem('maintenanceMode', backupData.data.maintenanceMode);
                    if (backupData.data.maintenanceMessage) localStorage.setItem('maintenanceMessage', backupData.data.maintenanceMessage);

                    alert('ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
                    location.reload();
                } catch (e) {
                    console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', e);
                    alert('ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + e.message);
                }
            };

            reader.onerror = function() {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            };

            reader.readAsText(file);
            event.target.value = '';
        }

        // æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æƒ…å ±ã‚’æ›´æ–°
        function updateLastBackupInfo() {
            const lastBackupDate = localStorage.getItem('lastBackupDate');
            const infoElement = document.getElementById('lastBackupInfo');
            const warningElement = document.getElementById('backupWarning');

            if (!lastBackupDate) {
                infoElement.textContent = 'ã¾ã ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“';
                infoElement.style.color = '#dc2626';
                warningElement.style.display = 'none';
                return;
            }

            const lastDate = new Date(lastBackupDate);
            const now = new Date();
            const daysDiff = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));

            const formattedDate = lastDate.toLocaleString('ja-JP');
            infoElement.textContent = `${formattedDate} (${daysDiff}æ—¥å‰)`;

            if (daysDiff > 30) {
                infoElement.style.color = '#dc2626';
                warningElement.style.display = 'block';
            } else if (daysDiff > 7) {
                infoElement.style.color = '#f59e0b';
                warningElement.style.display = 'none';
            } else {
                infoElement.style.color = '#15803d';
                warningElement.style.display = 'none';
            }
        }

        // å¥‘ç´„ä¸€è¦§ã‚’æç”»
        function renderContractTable() {
            var partners = [];
            try { partners = JSON.parse(sessionStorage.getItem('partners') || '[]'); } catch(e) {}
            try { var pl = JSON.parse(localStorage.getItem('partners') || '[]'); pl.forEach(function(p){ if(!partners.find(function(m){return m.id===p.id;})) partners.push(p); }); } catch(e) {}

            var companies = [];
            try { companies = JSON.parse(sessionStorage.getItem('companies') || '[]'); } catch(e) {}
            try { var cl = JSON.parse(localStorage.getItem('companies') || '[]'); cl.forEach(function(c){ if(!companies.find(function(m){return m.companyCode===c.companyCode;})) companies.push(c); }); } catch(e) {}

            // ãƒ‡ãƒ¢ç”¨
            if (partners.length === 0) {
                partners = [
                    { partnerCode: 'P001', name: 'æ±äº¬è¨­å‚™å·¥æ¥­æ ªå¼ä¼šç¤¾', contactName: 'å±±ç”°å¤ªéƒ', assignedCompanies: ['TAMJ'] },
                    { partnerCode: 'P002', name: 'é–¢æ±æ°´é“ã‚µãƒ¼ãƒ“ã‚¹', contactName: 'éˆ´æœ¨ä¸€éƒ', assignedCompanies: ['TAMJ'] },
                    { partnerCode: 'P003', name: 'æ—¥æœ¬é›»æ°—å·¥äº‹', contactName: 'ä½è—¤æ¬¡éƒ', assignedCompanies: ['TAMJ'] }
                ];
            }

            function getCompanyName(code) {
                var c = companies.find(function(x) { return x.companyCode === code; });
                return c ? c.companyName : code;
            }

            var tbody = document.getElementById('contractTableBody');
            if (partners.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;color:#aaa;">æ¥­è€…ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            tbody.innerHTML = partners.map(function(p) {
                var assigned = (p.assignedCompanies || []).map(function(code) {
                    return '<span style="display:inline-block;padding:3px 10px;background:#f0f0f0;border-radius:4px;margin:2px;font-size:12px;">' + getCompanyName(code) + '</span>';
                }).join('') || '<span style="color:#ccc;font-size:12px;">æœªè¨­å®š</span>';

                return '<tr>' +
                    '<td style="font-family:monospace;font-size:13px;">' + (p.partnerCode || '-') + '</td>' +
                    '<td>' + (p.name || '-') + '</td>' +
                    '<td>' + assigned + '</td>' +
                    '<td>' + (p.contactName || '-') + '</td>' +
                    '<td><a href="partner-master.html" style="color:#666;font-size:13px;">ç·¨é›†</a></td>' +
                '</tr>';
            }).join('');
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
        function clearAllData() {
            if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚\n\nä»¥ä¸‹ãŒå…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼š\nãƒ»ä¼šç¤¾/äº‹æ¥­æ‰€/ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ/æ¥­è€…ãƒã‚¹ã‚¿\nãƒ»é€šå ±ãƒ‡ãƒ¼ã‚¿\nãƒ»å•†å“ãƒã‚¹ã‚¿\nãƒ»ç›£æŸ»ãƒ­ã‚°\nãƒ»ã‚·ã‚¹ãƒ†ãƒ è¨­å®š\n\nDEMOã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿æ®‹ã‚Šã¾ã™ã€‚\n\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
            if (!confirm('æœ€çµ‚ç¢ºèªï¼šã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                // localStorageã‹ã‚‰æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ + è¨­å®šã‚’å‰Šé™¤
                const keysToRemove = [
                    'companies', 'offices', 'accounts', 'partners',
                    'onetouch.reports', 'items', 'audit.logs',
                    'lastBackupDate', 'maintenanceMode', 'maintenanceMessage',
                    'error.logs', 'upload.limits'
                ];
                keysToRemove.forEach(key => localStorage.removeItem(key));

                // sessionStorageã‹ã‚‰DEMOãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤
                const sessionKeysToRemove = [];
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key && (key.startsWith('onetouch.') || key.startsWith('demo.') || key === 'items' || key === 'partners' || key === 'accounts' || key === 'companies' || key === 'offices' || key === 'audit.logs')) {
                        sessionKeysToRemove.push(key);
                    }
                }
                sessionKeysToRemove.forEach(key => sessionStorage.removeItem(key));

                alert('å…¨ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
                location.reload();
            } catch (e) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', e);
                alert('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        function init() {
            loadGlobalStats();
            loadCompaniesTable();
            loadActivityRanking();
            loadMaintenanceMode();
            updateLastBackupInfo();
            renderContractTable();
        }

        init();
    </script>

    <script>
    // çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼åˆæœŸåŒ–
    UnifiedHeader.init({
        icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>',
        title: 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
        backButton: true,
        onBack: function() {
            window.location.href = 'system-admin.html';
        }
    });
    </script>
</body>
</html>
