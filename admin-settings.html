<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áµ±ÂêàÁÆ°ÁêÜÁîªÈù¢ | „ÉØ„É≥„Çø„ÉÉ„ÉÅÁÆ°ÁêÜ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", sans-serif;
            background: #fafafa;
            min-height: 100vh;
        }
h1 {
            font-size: 24px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .stat-unit {
            font-size: 18px;
            font-weight: 400;
            color: #666;
            margin-left: 4px;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #fafafa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #666;
        }

        tr:hover {
            background: #fafafa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-active {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-inactive {
            background: #ffebee;
            color: #c62828;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1a1a1a, #333);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(155, 35, 53, 0.3);
        }

        .btn-secondary {
            background: #757575;
            color: white;
        }

        .btn-secondary:hover {
            background: #616161;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .ranking-number {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            width: 50px;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .ranking-stats {
            font-size: 13px;
            color: #666;
        }

        @media (max-width: 768px) {
.container {
                padding: 0 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
    <script src="demo-mode.js"></script>
    <script src="unified-header.js"></script>
    <meta name="theme-color" content="#1a1a1a">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
</head>
<body>
    <!-- Áµ±‰∏Ä„Éò„ÉÉ„ÉÄ„Éº -->
    <div id="unified-header-mount"></div>
<div class="container">
        <!-- ÂÖ®„Ç∑„Çπ„ÉÜ„É†Áµ±Ë®à -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Á∑è‰ºöÁ§æÊï∞</div>
                <div class="stat-value" id="totalCompanies">0<span class="stat-unit">Á§æ</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Á∑è„É¶„Éº„Ç∂„ÉºÊï∞</div>
                <div class="stat-value" id="totalUsers">0<span class="stat-unit">‰∫∫</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Á∑è‰∫ãÊ•≠ÊâÄÊï∞</div>
                <div class="stat-value" id="totalOffices">0<span class="stat-unit">‰ª∂</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Á∑èÈÄöÂ†±Êï∞</div>
                <div class="stat-value" id="totalReports">0<span class="stat-unit">‰ª∂</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">„Ç∑„Çπ„ÉÜ„É†„Éá„Éº„Çø‰ΩøÁî®Èáè</div>
                <div class="stat-value" id="totalStorage">0<span class="stat-unit">KB</span></div>
            </div>
        </div>

        <!-- ‰ºöÁ§æÂà•„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É©„É≥„Ç≠„É≥„Ç∞ -->
        <div class="section">
            <div class="section-title">üèÜ ‰ºöÁ§æÂà•„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É©„É≥„Ç≠„É≥„Ç∞ÔºàÈÄöÂ†±Êï∞È†ÜÔºâ</div>
            <div id="activityRanking"></div>
        </div>

        <!-- ÂÖ®‰ºöÁ§æ‰∏ÄË¶ß -->
        <div class="section">
            <div class="section-title">üè¢ ÂÖ®‰ºöÁ§æ‰∏ÄË¶ß</div>
            <div style="margin-bottom: 16px; display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="exportAllData()">üì• ÂÖ®„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>‰ºöÁ§æ„Ç≥„Éº„Éâ</th>
                        <th>‰ºöÁ§æÂêç</th>
                        <th>„É¶„Éº„Ç∂„ÉºÊï∞</th>
                        <th>‰∫ãÊ•≠ÊâÄÊï∞</th>
                        <th>ÈÄöÂ†±Êï∞</th>
                        <th>Áä∂ÊÖã</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody id="companyTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // „É≠„Ç∞„Ç§„É≥„ÉÅ„Çß„ÉÉ„ÇØ
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        } else if (currentUser.role !== 'system_admin') {
            alert('„Åì„ÅÆÁîªÈù¢„ÅØ„Ç∑„Çπ„ÉÜ„É†ÁÆ°ÁêÜËÄÖ„ÅÆ„Åø„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åô„ÄÇ');
            window.location.href = 'system-admin.html';
        }

        // Êàª„ÇãÊ©üËÉΩ
        // Êàª„ÇãÔºà„É≠„Éº„É´„Å´Âøú„Åò„Åü„Éõ„Éº„É†„Å´ÈÅ∑ÁßªÔºâ
        function goBack() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                
                if (!currentUser || !currentUser.role) {
                    window.location.href = 'login.html';
                    return;
                }

                // „É≠„Éº„É´Âà•„ÅÆ„Éõ„Éº„É†ÁîªÈù¢
                const homePages = {
                    'system_admin': 'system-admin.html',
                    'company_admin': 'master-top.html',
                    'office_admin': 'master-top.html',
                    'staff': 'report.html',
                    'contractor': 'contractor-dashboard.html'
                };

                const homePage = homePages[currentUser.role] || 'master-top.html';
                window.location.href = homePage;
            } catch (e) {
                console.error('goBack error:', e);
                window.location.href = 'system-admin.html';
            }
        }

        // ÂÖ®„Ç∑„Çπ„ÉÜ„É†Áµ±Ë®à„ÇíË®àÁÆó
        function calculateGlobalStats() {
            try {
                const companies = JSON.parse(localStorage.getItem('companies') || '[]');
                const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                const offices = JSON.parse(localStorage.getItem('offices') || '[]');
                const reports = JSON.parse(localStorage.getItem('onetouch.reports') || '[]');
                
                // Á∑è‰ºöÁ§æÊï∞
                document.getElementById('totalCompanies').innerHTML = companies.length + '<span class="stat-unit">Á§æ</span>';
                
                // Á∑è„É¶„Éº„Ç∂„ÉºÊï∞
                document.getElementById('totalUsers').innerHTML = accounts.length + '<span class="stat-unit">‰∫∫</span>';
                
                // Á∑è‰∫ãÊ•≠ÊâÄÊï∞
                document.getElementById('totalOffices').innerHTML = offices.length + '<span class="stat-unit">‰ª∂</span>';
                
                // Á∑èÈÄöÂ†±Êï∞
                document.getElementById('totalReports').innerHTML = reports.length + '<span class="stat-unit">‰ª∂</span>';
                
                // „Ç∑„Çπ„ÉÜ„É†„Éá„Éº„Çø‰ΩøÁî®Èáè
                const getSize = (key) => {
                    const data = localStorage.getItem(key);
                    return data ? new Blob([data]).size / 1024 : 0;
                };
                const totalSize = getSize('companies') + getSize('accounts') + getSize('offices') + getSize('onetouch.reports') + getSize('audit.logs') + getSize('partners');
                document.getElementById('totalStorage').innerHTML = totalSize.toFixed(2) + '<span class="stat-unit">KB</span>';
                
            } catch (e) {
                console.error('Áµ±Ë®àË®àÁÆó„Ç®„É©„Éº:', e);
            }
        }

        // ‰ºöÁ§æÂà•„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É©„É≥„Ç≠„É≥„Ç∞
        function renderActivityRanking() {
            try {
                const companies = JSON.parse(localStorage.getItem('companies') || '[]');
                const reports = JSON.parse(localStorage.getItem('onetouch.reports') || '[]');
                const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                const offices = JSON.parse(localStorage.getItem('offices') || '[]');
                
                // ‰ºöÁ§æ„Åî„Å®„ÅÆÁµ±Ë®à„ÇíË®àÁÆó
                const companyStats = companies.map(company => {
                    const companyReports = reports.filter(r => r.companyCode === company.code).length;
                    const companyAccounts = accounts.filter(a => a.companyCode === company.code).length;
                    const companyOffices = offices.filter(o => o.companyCode === company.code).length;
                    
                    return {
                        code: company.code,
                        name: company.name,
                        reports: companyReports,
                        accounts: companyAccounts,
                        offices: companyOffices
                    };
                });
                
                // ÈÄöÂ†±Êï∞È†Ü„Å´„ÇΩ„Éº„Éà
                companyStats.sort((a, b) => b.reports - a.reports);
                
                // ‰∏ä‰Ωç5Á§æ„ÇíË°®Á§∫
                const rankingHTML = companyStats.slice(0, 5).map((company, index) => `
                    <div class="ranking-item">
                        <div class="ranking-number">${index + 1}</div>
                        <div class="ranking-info">
                            <div class="ranking-name">${company.name}</div>
                            <div class="ranking-stats">
                                ÈÄöÂ†±: ${company.reports}‰ª∂ / „É¶„Éº„Ç∂„Éº: ${company.accounts}‰∫∫ / ‰∫ãÊ•≠ÊâÄ: ${company.offices}‰ª∂
                            </div>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('activityRanking').innerHTML = rankingHTML || '<div style="text-align: center; padding: 40px; color: #999;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                
            } catch (e) {
                console.error('„É©„É≥„Ç≠„É≥„Ç∞Ë®àÁÆó„Ç®„É©„Éº:', e);
            }
        }

        // ÂÖ®‰ºöÁ§æ‰∏ÄË¶ß„ÇíË°®Á§∫
        function renderCompanyTable() {
            try {
                const companies = JSON.parse(localStorage.getItem('companies') || '[]');
                const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                const offices = JSON.parse(localStorage.getItem('offices') || '[]');
                const reports = JSON.parse(localStorage.getItem('onetouch.reports') || '[]');
                
                if (companies.length === 0) {
                    document.getElementById('companyTableBody').innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã‰ºöÁ§æ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const tableHTML = companies.map(company => {
                    const companyAccounts = accounts.filter(a => a.companyCode === company.code).length;
                    const companyOffices = offices.filter(o => o.companyCode === company.code).length;
                    const companyReports = reports.filter(r => r.companyCode === company.code).length;
                    const isActive = company.status === 'active';
                    
                    return `
                        <tr>
                            <td>${company.code}</td>
                            <td><strong>${company.name}</strong></td>
                            <td>${companyAccounts}‰∫∫</td>
                            <td>${companyOffices}‰ª∂</td>
                            <td>${companyReports}‰ª∂</td>
                            <td>
                                <span class="badge ${isActive ? 'badge-active' : 'badge-inactive'}">
                                    ${isActive ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-secondary" onclick="exportCompanyData('${company.code}')">„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('companyTableBody').innerHTML = tableHTML;
                
            } catch (e) {
                console.error('‰ºöÁ§æ‰∏ÄË¶ßË°®Á§∫„Ç®„É©„Éº:', e);
            }
        }

        // ‰ºöÁ§æ„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportCompanyData(companyCode) {
            try {
                const accounts = JSON.parse(localStorage.getItem('accounts') || '[]').filter(a => a.companyCode === companyCode);
                const offices = JSON.parse(localStorage.getItem('offices') || '[]').filter(o => o.companyCode === companyCode);
                const reports = JSON.parse(localStorage.getItem('onetouch.reports') || '[]').filter(r => r.companyCode === companyCode);
                const partners = JSON.parse(localStorage.getItem('partners') || '[]').filter(p => p.companyCode === companyCode);
                
                const data = {
                    companyCode: companyCode,
                    exportDate: new Date().toISOString(),
                    accounts: accounts,
                    offices: offices,
                    reports: reports,
                    partners: partners
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `company-data-${companyCode}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
            } catch (e) {
                console.error('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:', e);
                alert('„Éá„Éº„Çø„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }

        // ÂÖ®„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportAllData() {
            try {
                const allData = {
                    exportDate: new Date().toISOString(),
                    companies: JSON.parse(localStorage.getItem('companies') || '[]'),
                    accounts: JSON.parse(localStorage.getItem('accounts') || '[]'),
                    offices: JSON.parse(localStorage.getItem('offices') || '[]'),
                    reports: JSON.parse(localStorage.getItem('onetouch.reports') || '[]'),
                    partners: JSON.parse(localStorage.getItem('partners') || '[]'),
                    auditLogs: JSON.parse(localStorage.getItem('audit.logs') || '[]')
                };
                
                const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `all-system-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
            } catch (e) {
                console.error('ÂÖ®„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:', e);
                alert('„Éá„Éº„Çø„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }

        // ÂàùÊúüÂåñ
        calculateGlobalStats();
        renderActivityRanking();
        renderCompanyTable();
    </script>

    <script>
    UnifiedHeader.init({
        icon: '',
        title: 'Áµ±ÂêàÁÆ°ÁêÜ',
        backButton: true
    });
    </script>
</body>
</html>
