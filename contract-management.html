<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥‘ç´„ç®¡ç† | ãƒ¯ãƒ³ã‚¿ãƒƒãƒç®¡ç†</title>
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a5f">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans CJK JP", sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 24px;
        }
        .section {
            background: #fff;
            border-radius: 14px;
            border: 1px solid #e8e8e8;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
        }
        .links-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .link-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
        }
        @media (max-width: 768px) {
            .container { padding: 16px; }
            .section { padding: 16px; }
        }
    </style>
    <script src="demo-mode.js"></script>
    <script src="unified-header.js"></script>
</head>
<body>
    <div id="unified-header-mount"></div>
    <div class="container">

        <!-- é–¢é€£ãƒªãƒ³ã‚¯ -->
        <div class="section">
            <div class="links-row">
                <a href="docs.html#guide" class="link-btn" style="background:#f0f7ff; border:1px solid #bfdbfe; color:#1e3a5f;">
                    ğŸ“– å¥‘ç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã¯ï¼ˆæ¦‚è¦ï¼‰
                </a>
                <a href="docs.html#howto" class="link-btn" style="background:#f0fdf4; border:1px solid #bbf7d0; color:#166534;">
                    ğŸ”§ ç®¡ç†ä¼šç¤¾ã®å¤‰æ›´æ‰‹é †
                </a>
                <a href="docs.html#faq" class="link-btn" style="background:#fefce8; border:1px solid #fde68a; color:#854d0e;">
                    â“ ã‚ˆãã‚ã‚‹è³ªå•
                </a>
                <a href="partner-master.html" class="link-btn" style="background:#faf5ff; border:1px solid #e9d5ff; color:#7c3aed;">
                    ğŸ‘¤ ç®¡ç†ä¼šç¤¾ãƒã‚¹ã‚¿ã‚’é–‹ã
                </a>
            </div>
        </div>

        <!-- å¥‘ç´„ä¸€è¦§ -->
        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:12px;">
                <div class="section-title" style="margin-bottom:0;">å¥‘ç´„ä¸€è¦§ï¼ˆç®¡ç†ä¼šç¤¾åˆ¥ï¼‰</div>
                <input type="text" id="contractFilter" placeholder="ç®¡ç†ä¼šç¤¾åã§æ¤œç´¢..." oninput="cm_currentPage=1;renderTable()" style="padding:8px 14px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; width:220px;">
            </div>
            <div id="contractBody"></div>
            <div id="cmPagination"></div>
        </div>

    </div>

    <!-- å¥‘ç´„ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="contractEditModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999;">
        <div style="background:#fff; border-radius:14px; padding:28px; max-width:500px; width:90%; margin:auto; position:relative; top:50%; transform:translateY(-50%);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="font-size:16px; font-weight:700; color:#1e293b;" id="contractEditTitle">å¥‘ç´„ç·¨é›†</h3>
                <button onclick="closeContractEdit()" style="background:none; border:none; font-size:20px; color:#999; cursor:pointer;">âœ•</button>
            </div>
            <input type="hidden" id="editContractId">
            
            <div style="margin-bottom:16px;">
                <label style="display:block; font-size:13px; font-weight:600; color:#64748b; margin-bottom:6px;">æ‹…å½“ã‚«ãƒ†ã‚´ãƒª</label>
                <div id="editCategoryCheckboxes" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; font-size:13px; font-weight:600; color:#64748b; margin-bottom:6px;">çŠ¶æ…‹</label>
                <select id="editContractStatus" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px; font-size:14px;">
                    <option value="active">æœ‰åŠ¹</option>
                    <option value="inactive">åœæ­¢</option>
                </select>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button onclick="closeContractEdit()" style="flex:1; padding:12px; background:#f1f5f9; color:#334155; border:none; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="saveContractEdit()" style="flex:1; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer;">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
    function renderPagination(containerId, currentPage, totalPages, totalItems, onPageChange) {
        var container = document.getElementById(containerId);
        if (!container) return;
        if (totalPages <= 1) { container.innerHTML = totalItems > 0 ? '<div style="text-align:center;padding:12px;font-size:13px;color:#999;">å…¨ ' + totalItems + ' ä»¶</div>' : ''; return; }
        var html = '<div style="display:flex;align-items:center;justify-content:center;gap:6px;padding:16px;flex-wrap:wrap;">';
        html += '<span style="font-size:13px;color:#999;margin-right:8px;">å…¨ ' + totalItems + ' ä»¶</span>';
        html += '<button onclick="window._pgCb' + containerId + '(' + (currentPage-1) + ')" ' + (currentPage<=1?'disabled':'') + ' style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer;font-size:13px;' + (currentPage<=1?'opacity:0.4;cursor:default;':'') + '">å‰ã¸</button>';
        var s=Math.max(1,currentPage-2),e=Math.min(totalPages,s+4); if(e-s<4) s=Math.max(1,e-4);
        for(var p=s;p<=e;p++) html += '<button onclick="window._pgCb' + containerId + '(' + p + ')" style="padding:6px 12px;border:1px solid ' + (p===currentPage?'#2563eb':'#d1d5db') + ';border-radius:6px;background:' + (p===currentPage?'#2563eb':'#fff') + ';color:' + (p===currentPage?'#fff':'#333') + ';cursor:pointer;font-size:13px;font-weight:' + (p===currentPage?'700':'400') + ';">' + p + '</button>';
        html += '<button onclick="window._pgCb' + containerId + '(' + (currentPage+1) + ')" ' + (currentPage>=totalPages?'disabled':'') + ' style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer;font-size:13px;' + (currentPage>=totalPages?'opacity:0.4;cursor:default;':'') + '">æ¬¡ã¸</button></div>';
        container.innerHTML = html; window['_pgCb' + containerId] = onPageChange;
    }

    // æ¨©é™ãƒã‚§ãƒƒã‚¯
    var currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
    if (!currentUser) {
        window.location.href = 'login.html';
    } else if (currentUser.role !== 'system_admin') {
        alert('ã“ã®ç”»é¢ã¯ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚');
        window.location.href = 'login.html';
    }

    UnifiedHeader.init({
        title: 'å¥‘ç´„ç®¡ç†',
        backButton: true,
        onBack: function() { window.location.href = 'system-admin.html'; }
    });

    var ALL_CATEGORIES = ['å»ºç‰©ãƒ»å¤–ã¾ã‚ã‚Š','éƒ¨å±‹ãƒ»å…±ç”¨éƒ¨ã®å®¶å…·ãƒ»å®¶é›»','ä»‹è­·åŒ»ç™‚ãƒ»ãŠé¢¨å‘‚ã®é“å…·','å¨æˆ¿ãƒ»é£Ÿäº‹ã®é“å…·','é€šä¿¡ãƒ»å‘¼å‡ºã—ãƒ»é˜²ç«ã®æ©Ÿå™¨','ãã®ä»–'];
    var _contracts = [];
    var _partners = [];
    var _companies = [];

    function _loadData() {
        _contracts = [];
        try { _contracts = JSON.parse(sessionStorage.getItem('onetouch.contracts') || '[]'); } catch(e) {}
        try { var cl = JSON.parse(localStorage.getItem('onetouch.contracts') || '[]'); cl.forEach(function(c){ if(!_contracts.find(function(x){return x.id===c.id;})) _contracts.push(c); }); } catch(e) {}

        _partners = [];
        try { _partners = JSON.parse(sessionStorage.getItem('partners') || '[]'); } catch(e) {}
        try { var pl = JSON.parse(localStorage.getItem('partners') || '[]'); pl.forEach(function(p){ if(!_partners.find(function(x){return x.id===p.id || x.partnerCode===p.partnerCode;})) _partners.push(p); }); } catch(e) {}

        _companies = [];
        try { _companies = JSON.parse(sessionStorage.getItem('companies') || '[]'); } catch(e) {}
        try { var cl2 = JSON.parse(localStorage.getItem('companies') || '[]'); cl2.forEach(function(c){ if(!_companies.find(function(x){return (x.companyCode||x.code)===(c.companyCode||c.code);})) _companies.push(c); }); } catch(e) {}
    }

    function getPartnerName(id) {
        var p = _partners.find(function(x){ return x.id === id || x.partnerCode === id; });
        return p ? p.name : id;
    }
    function getCompanyName(code) {
        var c = _companies.find(function(x){ return (x.companyCode||x.code) === code; });
        return c ? (c.companyName||c.name) : code;
    }

    var cm_currentPage = 1;
    var cm_pageSize = 30;

    function renderTable() {
        _loadData();
        var container = document.getElementById('contractBody');
        var filterText = (document.getElementById('contractFilter').value || '').trim().toLowerCase();
        
        // ç®¡ç†ä¼šç¤¾ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
        var partnerMap = {};
        _contracts.forEach(function(c) {
            var pid = c.partnerId || 'unknown';
            if (!partnerMap[pid]) {
                partnerMap[pid] = { partnerId: pid, name: getPartnerName(pid), contracts: [] };
            }
            partnerMap[pid].contracts.push(c);
        });
        
        var partners = Object.values(partnerMap);
        
        // ãƒ•ã‚£ãƒ«ã‚¿
        if (filterText) {
            partners = partners.filter(function(p) {
                return p.name.toLowerCase().indexOf(filterText) >= 0 || p.partnerId.toLowerCase().indexOf(filterText) >= 0;
            });
        }
        
        // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚³ãƒ¼ãƒ‰é †ã«ã‚½ãƒ¼ãƒˆ
        partners.sort(function(a, b) { return a.partnerId.localeCompare(b.partnerId); });
        
        if (partners.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:30px; color:#aaa;">' + (filterText ? 'è©²å½“ã™ã‚‹ç®¡ç†ä¼šç¤¾ãŒã‚ã‚Šã¾ã›ã‚“' : 'å¥‘ç´„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“') + '</div>';
            document.getElementById('contractCount').textContent = '';
            if (document.getElementById('cmPagination')) document.getElementById('cmPagination').innerHTML = '';
            return;
        }

        var totalPages = Math.ceil(partners.length / cm_pageSize);
        if (cm_currentPage > totalPages) cm_currentPage = totalPages;
        var start = (cm_currentPage - 1) * cm_pageSize;
        var pageItems = partners.slice(start, start + cm_pageSize);

        container.innerHTML = pageItems.map(function(p) {
            var allCats = [];
            p.contracts.forEach(function(c) { (c.categories || []).forEach(function(cat) { if (allCats.indexOf(cat) < 0) allCats.push(cat); }); });
            
            // å¥‘ç´„å…ˆã®ä¼šç¤¾ä¸€è¦§
            var companyRows = p.contracts.map(function(c) {
                var statusColor = c.status === 'active' ? '#22c55e' : '#ef4444';
                var statusText = c.status === 'active' ? 'æœ‰åŠ¹' : 'åœæ­¢';
                var cats = (c.categories || []).map(function(cat) {
                    return '<span style="display:inline-block;padding:2px 8px;background:#f0f4ff;border:1px solid #d0d8f0;border-radius:4px;margin:2px;font-size:11px;color:#475569;">' + cat + '</span>';
                }).join('');
                return '<tr style="border-bottom:1px solid #f0f0f0;">'
                    + '<td style="padding:8px 12px;font-size:13px;">' + getCompanyName(c.companyCode) + '</td>'
                    + '<td style="padding:8px 12px;">' + (cats || '<span style="color:#ccc;">æœªè¨­å®š</span>') + '</td>'
                    + '<td style="padding:8px 12px;text-align:center;"><span style="display:inline-block;padding:2px 10px;border-radius:10px;font-size:11px;font-weight:600;color:#fff;background:' + statusColor + ';">' + statusText + '</span></td>'
                    + '<td style="padding:8px 12px;text-align:center;"><button onclick="openContractEdit(\'' + c.id + '\')" style="padding:4px 12px;background:#2563eb;color:#fff;border:none;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;">ç·¨é›†</button></td>'
                    + '</tr>';
            }).join('');

            return '<div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;margin-bottom:14px;overflow:hidden;">'
                + '<div style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#f8fafc;border-bottom:1px solid #e2e8f0;">'
                + '<div>'
                + '<span style="font-size:12px;color:#94a3b8;font-family:monospace;margin-right:10px;">' + p.partnerId + '</span>'
                + '<span style="font-size:15px;font-weight:700;color:#1e293b;">' + p.name + '</span>'
                + '</div>'
                + '<span style="font-size:12px;color:#64748b;">å¥‘ç´„å…ˆ: ' + p.contracts.length + 'ç¤¾</span>'
                + '</div>'
                + '<table style="width:100%;border-collapse:collapse;font-size:13px;">'
                + '<thead><tr style="background:#fafbfc;">'
                + '<th style="padding:6px 12px;text-align:left;font-weight:600;color:#94a3b8;font-size:11px;">å¥‘ç´„ä¼šç¤¾</th>'
                + '<th style="padding:6px 12px;text-align:left;font-weight:600;color:#94a3b8;font-size:11px;">æ‹…å½“ã‚«ãƒ†ã‚´ãƒª</th>'
                + '<th style="padding:6px 12px;text-align:center;font-weight:600;color:#94a3b8;font-size:11px;width:50px;">çŠ¶æ…‹</th>'
                + '<th style="padding:6px 12px;text-align:center;font-weight:600;color:#94a3b8;font-size:11px;width:50px;">æ“ä½œ</th>'
                + '</tr></thead>'
                + '<tbody>' + companyRows + '</tbody>'
                + '</table>'
                + '</div>';
        }).join('');

        document.getElementById('contractCount').textContent = '';
        renderPagination('cmPagination', cm_currentPage, totalPages, partners.length, function(page) {
            cm_currentPage = page;
            renderTable();
        });
    }
    renderTable();

    function openContractEdit(contractId) {
        var contract = _contracts.find(function(c) { return c.id === contractId; });
        if (!contract) return;
        document.getElementById('editContractId').value = contractId;
        document.getElementById('contractEditTitle').textContent = getPartnerName(contract.partnerId) + ' ã®å¥‘ç´„ç·¨é›†';
        document.getElementById('editContractStatus').value = contract.status || 'active';
        var currentCats = contract.categories || [];
        document.getElementById('editCategoryCheckboxes').innerHTML = ALL_CATEGORIES.map(function(cat) {
            var checked = currentCats.indexOf(cat) >= 0 ? 'checked' : '';
            return '<label style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:' + (checked ? '#eff6ff' : '#f8f9fa') + ';border:1px solid ' + (checked ? '#2563eb' : '#e5e7eb') + ';border-radius:6px;cursor:pointer;font-size:13px;">'
                + '<input type="checkbox" name="editCat" value="' + cat + '" ' + checked + ' style="accent-color:#2563eb;">'
                + cat + '</label>';
        }).join('');
        document.getElementById('contractEditModal').style.display = 'block';
    }

    function closeContractEdit() {
        document.getElementById('contractEditModal').style.display = 'none';
    }

    function saveContractEdit() {
        var contractId = document.getElementById('editContractId').value;
        var newStatus = document.getElementById('editContractStatus').value;
        var checkboxes = document.querySelectorAll('input[name="editCat"]:checked');
        var newCats = [];
        checkboxes.forEach(function(cb) { newCats.push(cb.value); });
        if (newCats.length === 0) { alert('ã‚«ãƒ†ã‚´ãƒªã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }

        var contracts = [];
        try { contracts = JSON.parse(sessionStorage.getItem('onetouch.contracts') || '[]'); } catch(e) {}
        if (contracts.length === 0) {
            try { contracts = JSON.parse(localStorage.getItem('onetouch.contracts') || '[]'); } catch(e) {}
        }
        var updated = false;
        contracts.forEach(function(c) {
            if (c.id === contractId) { c.categories = newCats; c.status = newStatus; updated = true; }
        });
        if (updated) {
            sessionStorage.setItem('onetouch.contracts', JSON.stringify(contracts));
            localStorage.setItem('onetouch.contracts', JSON.stringify(contracts));
            closeContractEdit();
            renderTable();
            var toast = document.createElement('div');
            toast.textContent = 'å¥‘ç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ';
            toast.style.cssText = 'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#1e3a5f;color:#fff;padding:12px 24px;border-radius:8px;font-size:14px;font-weight:600;z-index:99999;';
            document.body.appendChild(toast);
            setTimeout(function() { toast.remove(); }, 2000);
        }
    }
    </script>
</body>
</html>
