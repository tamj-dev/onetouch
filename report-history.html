<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šå ±å±¥æ­´ | ãƒ¯ãƒ³ã‚¿ãƒƒãƒç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans CJK JP", sans-serif;
            background: #fafafa;
            min-height: 100vh;
        }
.container {
            max-width: 1200px;
            margin: 16px auto;
            padding: 0 20px;
        }

        .filter-panel {
            background: white;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 16px;
            margin-bottom: 16px;
            align-items: center;
        }

        .filter-label {
            font-weight: 600;
            color: #555;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #fafafa;
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #ddd;
            white-space: nowrap;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }

        tbody tr:hover {
            background: #fafafa;
            cursor: pointer;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending { background: #fff3e0; color: #e65100; }
        .status-processing { background: #e3f2fd; color: #1976d2; }
        .status-completed { background: #c8e6c9; color: #2e7d32; }
        .status-unavailable { background: #ffebee; color: #c62828; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ– */
        .status-tabs {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        .status-tab {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .status-tab:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }
        .status-tab.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        .status-tab-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .status-tab.active .status-tab-label {
            color: white;
            font-weight: 600;
        }
        .status-tab-count {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
        .status-tab.active .status-tab-count {
            color: white;
        }
        @media (max-width: 480px) {
            .status-tabs { grid-template-columns: repeat(3, 1fr); }
        }

        /* ã‚¹ãƒãƒ›ç”¨ã‚«ãƒ¼ãƒ‰ */
        .mobile-cards { display: none; }
        .report-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .report-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .report-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .report-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        .report-card-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 8px;
        }
        .report-card-info {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
        }
        .report-card-info span {
            background: #f5f5f5;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .report-card-partner {
            font-size: 12px;
            color: #1e40af;
            font-weight: 600;
        }

        /* PC: ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º / ã‚¹ãƒãƒ›: ã‚«ãƒ¼ãƒ‰è¡¨ç¤º */
        @media (max-width: 768px) {
            .table-container { display: none; }
            .mobile-cards { display: block; }
            .filter-panel { padding: 16px; }
            .filter-row {
                grid-template-columns: 1fr;
            }
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
.filter-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="demo-mode.js"></script>
    <script src="unified-header.js"></script>
    <meta name="theme-color" content="#1a1a1a">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
</head>
<body>
    <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div id="unified-header-mount"></div>

    <div class="container">
        <div class="filter-panel">
            <!-- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®ã¿: ä¼šç¤¾ãƒ•ã‚£ãƒ«ã‚¿ -->
            <div class="filter-row" id="companyFilterRow" style="display: none;">
                <div class="filter-label">ä¼šç¤¾</div>
                <div>
                    <select id="companyFilter" class="filter-input" onchange="onCompanyFilterChange()">
                        <option value="">-- å…¨ä¼šç¤¾ --</option>
                    </select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-label">äº‹æ¥­æ‰€</div>
                <div id="officeFilterArea">
                    <div id="officeInfo" style="color: #666; font-size: 14px;">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <!-- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®ã¿: æ¥­è€…ãƒ•ã‚£ãƒ«ã‚¿ -->
            <div class="filter-row" id="partnerFilterRow" style="display: none;">
                <div class="filter-label">æ¥­è€…</div>
                <div>
                    <select id="partnerFilter" class="filter-input">
                        <option value="">-- å…¨æ¥­è€… --</option>
                    </select>
                </div>
            </div>

            <!-- å…¨ãƒ­ãƒ¼ãƒ«å…±é€š: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ– -->
            <div style="grid-column: 1 / -1;">
                <div class="filter-label" style="margin-bottom: 8px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                <div class="status-tabs">
                    <div class="status-tab active" onclick="filterByContractorStatus('', this)">
                        <div class="status-tab-label">ã™ã¹ã¦</div>
                        <div class="status-tab-count" id="countAll">0</div>
                    </div>
                    <div class="status-tab" onclick="filterByContractorStatus('æœªå¯¾å¿œ', this)">
                        <div class="status-tab-label">æœªå¯¾å¿œ</div>
                        <div class="status-tab-count" id="countPending">0</div>
                    </div>
                    <div class="status-tab" onclick="filterByContractorStatus('å¯¾å¿œä¸­', this)">
                        <div class="status-tab-label">å¯¾å¿œä¸­</div>
                        <div class="status-tab-count" id="countProgress">0</div>
                    </div>
                    <div class="status-tab" onclick="filterByContractorStatus('å®Œäº†', this)">
                        <div class="status-tab-label">å®Œäº†</div>
                        <div class="status-tab-count" id="countComplete">0</div>
                    </div>
                    <div class="status-tab" onclick="filterByContractorStatus('å¯¾å¿œä¸å¯', this)">
                        <div class="status-tab-label">å¯¾å¿œä¸å¯</div>
                        <div class="status-tab-count" id="countUnavailable">0</div>
                    </div>
                </div>
            </div>

            <div class="filter-row" style="margin-top: 20px;">
                <div class="filter-label">æœŸé–“</div>
                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <input type="date" id="startDate" class="filter-input">
                    <span>ã€œ</span>
                    <input type="date" id="endDate" class="filter-input">
                    <button onclick="filterReports()" style="padding: 8px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 12px;">æ¤œç´¢</button>
                    <button onclick="exportCSV()" style="padding: 8px 20px; background: #43a047; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>é€šå ±æ—¥æ™‚</th>
                        <th>é€šå ±è€…</th>
                        <th>äº‹æ¥­æ‰€</th>
                        <th>ã‚«ãƒ†ã‚´ãƒª</th>
                        <th>å†…å®¹</th>
                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th>å¯¾å¿œæ™‚é–“</th>
                        <th>å¯¾å¿œè€…</th>
                    </tr>
                </thead>
                <tbody id="reportList">
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-icon">ğŸ“‹</div>
                            <div>é€šå ±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ã‚¹ãƒãƒ›ç”¨ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
        <div id="reportCards" class="mobile-cards"></div>
    </div>

    <!-- é€šå ±è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="overlay" id="detailOverlay" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;">
        <div class="modal" style="background: white; border-radius: 12px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 id="detailTitle" style="font-size: 20px; font-weight: 700; color: #333;">é€šå ±è©³ç´°</h2>
                <button onclick="closeDetail()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px;">&times;</button>
            </div>
            <div id="detailContent" style="line-height: 1.8;">
                <!-- è©³ç´°å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script>
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        } else if (currentUser.role !== 'system_admin' && currentUser.role !== 'company_admin' && currentUser.role !== 'office_admin') {
            alert('ã“ã®ç”»é¢ã¯ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚');
            window.location.href = 'report.html';
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let selectedOfficeCode = '';
        let allReports = []; // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‰ã®å…¨é€šå ±ã‚’ä¿æŒ

        // é€šå ±è©³ç´°ã‚’è¡¨ç¤º
        function showDetail(index) {
            const report = allReports[index];
            if (!report) return;

            const datetime = new Date(report.timestamp);
            const dateStr = datetime.toLocaleDateString('ja-JP') + ' ' + 
                           datetime.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            
            const typeLabels = {
                wholesale: 'å¸æ¥­è€…',
                building: 'ãƒ“ãƒ«ãƒ¡ãƒ³æ¥­è€…',
                welfare: 'ç¦ç¥‰ç”¨å…·æ¥­è€…',
                emergency: 'ç·Šæ€¥'
            };

            const statusLabels = {
                pending: 'æœªå¯¾å¿œ',
                processing: 'å¯¾å¿œä¸­',
                completed: 'å®Œäº†'
            };

            const label = report.emergency ? 'ğŸš¨ ç·Šæ€¥é€šå ±' : 'ğŸ“¢ é€šå ±';
            document.getElementById('detailTitle').innerHTML = label;

            let content = '';
            
            // é€šå ±ID
            content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
            content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">é€šå ±ID</div>';
            content += '<div style="font-size: 15px; color: #333;">' + (report.id || '-') + '</div>';
            content += '</div>';

            // æ—¥æ™‚
            content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
            content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">æ—¥æ™‚</div>';
            content += '<div style="font-size: 15px; color: #333;">' + dateStr + '</div>';
            content += '</div>';

            // ç¨®åˆ¥
            content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
            content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">ç¨®åˆ¥</div>';
            const chipClass = report.emergency ? 'status-pending' : 'status-processing';
            const chipLabel = report.emergency ? 'ç·Šæ€¥' : 'é€šå ±';
            content += '<div><span class="status-badge ' + chipClass + '">' + chipLabel + '</span></div>';
            content += '</div>';

            // é€šå ±è€…
            content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
            content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">é€šå ±è€…</div>';
            content += '<div style="font-size: 15px; color: #333;">' + (report.reporter || '-') + '</div>';
            content += '</div>';

            // äº‹æ¥­æ‰€
            if (report.officeName) {
                content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">äº‹æ¥­æ‰€</div>';
                content += '<div style="font-size: 15px; color: #333;">' + report.officeName + '</div>';
                content += '</div>';
            }

            // å¯¾è±¡æ¥­è€…
            content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
            content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">å¯¾è±¡æ¥­è€…</div>';
            content += '<div style="font-size: 15px; color: #333;">' + (typeLabels[report.type] || report.category || '-') + '</div>';
            content += '</div>';

            // å ´æ‰€
            if (report.location) {
                content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">å ´æ‰€</div>';
                content += '<div style="font-size: 15px; color: #333;">' + report.location + '</div>';
                content += '</div>';
            }

            // è©³ç´°å†…å®¹
            content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
            content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">è©³ç´°å†…å®¹</div>';
            content += '<div style="background: #f9fafb; padding: 16px; border-radius: 8px; font-size: 14px; line-height: 1.8; white-space: pre-wrap;">' + (report.description || '-') + '</div>';
            content += '</div>';
            
            // å‰²å½“æ¥­è€…ï¼ˆè¿½åŠ ï¼‰
            if (report.assignedPartnerName || report.assignedPartnerId) {
                content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">å‰²å½“æ¥­è€…</div>';
                const partnerName = report.assignedPartnerName || 'æ¥­è€…ID: ' + report.assignedPartnerId;
                content += '<div style="font-size: 15px; color: #333;">ğŸ¢ ' + partnerName + '</div>';
                content += '</div>';
            }
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å±¥æ­´ï¼ˆè¿½åŠ ï¼‰
            if (report.statusHistory && report.statusHistory.length > 0) {
                content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                content += '<div style="font-size: 12px; color: #999; margin-bottom: 12px;">ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å±¥æ­´</div>';
                
                report.statusHistory.forEach(function(history, idx) {
                    const historyTime = new Date(history.timestamp);
                    const historyDateStr = historyTime.toLocaleDateString('ja-JP') + ' ' + 
                                          historyTime.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                    
                    const statusFromClass = history.from === 'æœªå¯¾å¿œ' ? 'status-pending' :
                                           history.from === 'å¯¾å¿œä¸­' ? 'status-processing' :
                                           'status-completed';
                    const statusToClass = history.to === 'æœªå¯¾å¿œ' ? 'status-pending' :
                                         history.to === 'å¯¾å¿œä¸­' ? 'status-processing' :
                                         'status-completed';
                    
                    content += '<div style="display: flex; gap: 12px; margin-bottom: ' + (idx === report.statusHistory.length - 1 ? '0' : '12px') + '; padding: 12px; background: #f8f9fa; border-radius: 8px;">';
                    content += '<div style="flex-shrink: 0; width: 4px; background: #E53935; border-radius: 2px;"></div>';
                    content += '<div style="flex: 1;">';
                    content += '<div style="font-size: 11px; color: #666; margin-bottom: 6px;">' + historyDateStr + ' â€¢ ' + (history.changedBy || 'ä¸æ˜') + '</div>';
                    content += '<div style="display: flex; align-items: center; gap: 8px;">';
                    content += '<span class="status-badge ' + statusFromClass + '" style="font-size: 12px;">' + history.from + '</span>';
                    content += '<span style="color: #666;">â†’</span>';
                    content += '<span class="status-badge ' + statusToClass + '" style="font-size: 12px;">' + history.to + '</span>';
                    content += '</div>';
                    if (history.note) {
                        content += '<div style="font-size: 12px; color: #666; margin-top: 4px;">ğŸ’¬ ' + history.note + '</div>';
                    }
                    content += '</div>';
                    content += '</div>';
                });
                
                content += '</div>';
            }
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆè¿½åŠ ï¼‰
            if (report.contractorStatus) {
                content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>';
                const contractorStatusClass = report.contractorStatus === 'æœªå¯¾å¿œ' ? 'status-pending' :
                                              report.contractorStatus === 'å¯¾å¿œä¸­' ? 'status-processing' :
                                              report.contractorStatus === 'å®Œäº†' ? 'status-completed' :
                                              'status-unavailable';
                content += '<div><span class="status-badge ' + contractorStatusClass + '">' + report.contractorStatus + '</span></div>';
                content += '</div>';
            }
            
            // æ¥­è€…ã‚³ãƒ¡ãƒ³ãƒˆå±¥æ­´ï¼ˆè¿½åŠ ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å½¢å¼ï¼‰
            if (report.contractorComments && report.contractorComments.length > 0) {
                content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                content += '<div style="font-size: 12px; color: #999; margin-bottom: 12px;">ğŸ’¬ æ¥­è€…ã‚³ãƒ¡ãƒ³ãƒˆå±¥æ­´ï¼ˆ' + report.contractorComments.length + 'ä»¶ï¼‰</div>';
                
                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å½¢å¼ã§è¡¨ç¤º
                report.contractorComments.forEach(function(comment, idx) {
                    const commentTime = new Date(comment.timestamp);
                    const commentDateStr = commentTime.toLocaleDateString('ja-JP') + ' ' + 
                                          commentTime.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                    
                    content += '<div style="display: flex; gap: 12px; margin-bottom: ' + (idx === report.contractorComments.length - 1 ? '0' : '16px') + ';">';
                    // æ¥­è€…ã‚¢ã‚¤ã‚³ãƒ³
                    content += '<div style="flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ¢</div>';
                    // ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹
                    content += '<div style="flex: 1; background: #fef3c7; border: 1px solid #fde047; border-radius: 12px; padding: 12px;">';
                    content += '<div style="font-size: 11px; color: #78350f; margin-bottom: 4px; font-weight: 600;">' + (report.assignedPartnerName || 'æ¥­è€…') + ' â€¢ ' + commentDateStr + '</div>';
                    content += '<div style="font-size: 14px; color: #333; line-height: 1.6;">' + comment.text + '</div>';
                    content += '</div>';
                    content += '</div>';
                });
                
                content += '</div>';
            }

            document.getElementById('detailContent').innerHTML = content;
            document.getElementById('detailOverlay').style.display = 'flex';
        }

        // è©³ç´°ã‚’é–‰ã˜ã‚‹
        function closeDetail() {
            document.getElementById('detailOverlay').style.display = 'none';
        }

        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('detailOverlay').addEventListener('click', function(e) {
            if (e.target.id === 'detailOverlay') {
                closeDetail();
            }
        });

        // äº‹æ¥­æ‰€é¸æŠUIã‚’åˆæœŸåŒ–
        function initOfficeFilter() {
            const officeFilterArea = document.getElementById('officeFilterArea');
            
            if (currentUser.role === 'system_admin') {
                // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…å°‚ç”¨ãƒ•ã‚£ãƒ«ã‚¿ã‚’è¡¨ç¤º
                document.getElementById('companyFilterRow').style.display = '';
                document.getElementById('partnerFilterRow').style.display = '';
                
                // ä¼šç¤¾ãƒ•ã‚£ãƒ«ã‚¿åˆæœŸåŒ–
                initCompanyFilter();
                // æ¥­è€…ãƒ•ã‚£ãƒ«ã‚¿åˆæœŸåŒ–
                initPartnerFilter();
                
                // äº‹æ¥­æ‰€ï¼šå…¨äº‹æ¥­æ‰€ã‚’è¡¨ç¤ºï¼ˆä¼šç¤¾é¸æŠã§çµã‚Šè¾¼ã¿ï¼‰
                initOfficeSelect('');
                
            } else if (currentUser.role === 'company_admin') {
                selectedOfficeCode = 'all_company';
                initOfficeSelectForCompany(currentUser.companyCode);
                filterReports();
            } else {
                selectedOfficeCode = currentUser.officeCode || '';
                officeFilterArea.innerHTML = `<div id="officeInfo" style="color: #666; font-size: 14px;">${currentUser.officeName || 'å…¨äº‹æ¥­æ‰€'}</div>`;
                filterReports();
            }
        }

        // ä¼šç¤¾ãƒ•ã‚£ãƒ«ã‚¿åˆæœŸåŒ–
        function initCompanyFilter() {
            const companyFilter = document.getElementById('companyFilter');
            let companies = [];
            try { companies = JSON.parse(sessionStorage.getItem('companies') || '[]'); } catch(e) {}
            let companiesLocal = [];
            try { companiesLocal = JSON.parse(localStorage.getItem('companies') || '[]'); } catch(e) {}
            companiesLocal.forEach(c => { if (!companies.find(m => m.code === c.code)) companies.push(c); });
            
            companies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.code;
                opt.textContent = c.name;
                companyFilter.appendChild(opt);
            });
        }

        // ä¼šç¤¾ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´æ™‚ â†’ äº‹æ¥­æ‰€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é€£å‹•æ›´æ–°
        function onCompanyFilterChange() {
            const companyCode = document.getElementById('companyFilter').value;
            initOfficeSelect(companyCode);
        }

        // äº‹æ¥­æ‰€ã‚»ãƒ¬ã‚¯ãƒˆåˆæœŸåŒ–ï¼ˆä¼šç¤¾ã‚³ãƒ¼ãƒ‰ã§çµã‚Šè¾¼ã¿ï¼‰
        function initOfficeSelect(companyCode) {
            const officeFilterArea = document.getElementById('officeFilterArea');
            let offices = [];
            try { offices = JSON.parse(sessionStorage.getItem('offices') || '[]'); } catch(e) {}
            let officesLocal = [];
            try { officesLocal = JSON.parse(localStorage.getItem('offices') || '[]'); } catch(e) {}
            officesLocal.forEach(o => { if (!offices.find(m => m.code === o.code)) offices.push(o); });
            
            if (companyCode) {
                offices = offices.filter(o => o.companyCode === companyCode);
            }
            
            let optionsHTML = '<option value="">-- äº‹æ¥­æ‰€ã‚’é¸æŠ --</option>';
            optionsHTML += '<option value="all">å…¨äº‹æ¥­æ‰€</option>';
            offices.forEach(office => {
                optionsHTML += `<option value="${office.code}">${office.name}</option>`;
            });
            
            officeFilterArea.innerHTML = `
                <select id="officeSelect" class="filter-input" style="width: 300px;">
                    ${optionsHTML}
                </select>
            `;
        }

        // æœ¬ç¤¾ç®¡ç†è€…ç”¨ï¼šè‡ªç¤¾ã®äº‹æ¥­æ‰€ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹
        function initOfficeSelectForCompany(companyCode) {
            const officeFilterArea = document.getElementById('officeFilterArea');
            let offices = [];
            try { offices = JSON.parse(sessionStorage.getItem('offices') || '[]'); } catch(e) {}
            let officesLocal = [];
            try { officesLocal = JSON.parse(localStorage.getItem('offices') || '[]'); } catch(e) {}
            officesLocal.forEach(o => { if (!offices.find(m => m.code === o.code)) offices.push(o); });

            if (companyCode) {
                offices = offices.filter(o => o.companyCode === companyCode);
            }

            let optionsHTML = '<option value="all_company">å…¨äº‹æ¥­æ‰€</option>';
            offices.forEach(office => {
                optionsHTML += `<option value="${office.code}">${office.name}</option>`;
            });

            officeFilterArea.innerHTML = `
                <select id="companyOfficeSelect" class="filter-input" style="width: 300px;">
                    ${optionsHTML}
                </select>
            `;

            document.getElementById('companyOfficeSelect').addEventListener('change', function() {
                selectedOfficeCode = this.value;
                filterReports();
            });
        }

        // æ¥­è€…ãƒ•ã‚£ãƒ«ã‚¿åˆæœŸåŒ–
        function initPartnerFilter() {
            const partnerFilter = document.getElementById('partnerFilter');
            let partners = [];
            try { partners = JSON.parse(sessionStorage.getItem('partners') || '[]'); } catch(e) {}
            let partnersLocal = [];
            try { partnersLocal = JSON.parse(localStorage.getItem('partners') || '[]'); } catch(e) {}
            partnersLocal.forEach(p => { if (!partners.find(m => m.id === p.id)) partners.push(p); });
            
            partners.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.companyName || p.name || p.id;
                partnerFilter.appendChild(opt);
            });
        }

        // æˆ»ã‚‹æ©Ÿèƒ½
        // æˆ»ã‚‹ï¼ˆãƒ­ãƒ¼ãƒ«ã«å¿œã˜ãŸãƒ›ãƒ¼ãƒ ã«é·ç§»ï¼‰
        function goBack() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                
                if (!currentUser || !currentUser.role) {
                    window.location.href = 'login.html';
                    return;
                }

                // ãƒ­ãƒ¼ãƒ«åˆ¥ã®ãƒ›ãƒ¼ãƒ ç”»é¢
                const homePages = {
                    'system_admin': 'system-admin.html',
                    'company_admin': 'master-top.html',
                    'office_admin': 'master-top.html',
                    'staff': 'report.html',
                    'contractor': 'contractor-dashboard.html'
                };

                const homePage = homePages[currentUser.role] || 'master-top.html';
                window.location.href = homePage;
            } catch (e) {
                console.error('goBack error:', e);
                window.location.href = 'master-top.html';
            }
        }

        // é€šå ±å±¥æ­´ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦è¡¨ç¤º
        function filterReports() {
            // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®å ´åˆã¯é¸æŠã•ã‚ŒãŸäº‹æ¥­æ‰€ã‚’å–å¾—
            if (currentUser.role === 'system_admin') {
                const officeSelect = document.getElementById('officeSelect');
                selectedOfficeCode = officeSelect ? officeSelect.value : '';
            }

            // LocalStorage/SessionStorageã‹ã‚‰é€šå ±ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆDEMOå¯¾å¿œï¼‰
            let reportsFromSession = [];
            let reportsFromLocal = [];
            try { reportsFromSession = JSON.parse(sessionStorage.getItem('onetouch.reports') || '[]'); } catch(e) {}
            try { reportsFromLocal = JSON.parse(localStorage.getItem('onetouch.reports') || '[]'); } catch(e) {}
            let reports = [...reportsFromSession];
            reportsFromLocal.forEach(r => { if (!reports.find(m => m.id === r.id)) reports.push(r); });
            console.log('[report-history] å…¨é€šå ±æ•°:', reports.length, '(session:', reportsFromSession.length, '/ local:', reportsFromLocal.length, ')');
            console.log('[report-history] currentUser:', currentUser.role, currentUser.companyCode, 'selectedOffice:', selectedOfficeCode);
            
            // ä¼šç¤¾ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®ã¿ï¼‰
            if (currentUser.role === 'system_admin') {
                const companyCode = document.getElementById('companyFilter') ? document.getElementById('companyFilter').value : '';
                if (companyCode) {
                    reports = reports.filter(r => r.companyCode === companyCode);
                }
            }

            // äº‹æ¥­æ‰€ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            if (selectedOfficeCode === 'all_company') {
                reports = reports.filter(r => r.companyCode === currentUser.companyCode);
                console.log('[report-history] all_company ãƒ•ã‚£ãƒ«ã‚¿å¾Œ:', reports.length, 'ä»¶ (companyCode:', currentUser.companyCode, ')');
            } else if (selectedOfficeCode && selectedOfficeCode !== 'all' && selectedOfficeCode !== '') {
                reports = reports.filter(r => r.officeCode === selectedOfficeCode);
            }

            // æ¥­è€…ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã®ã¿ï¼‰
            if (currentUser.role === 'system_admin') {
                const partnerId = document.getElementById('partnerFilter') ? document.getElementById('partnerFilter').value : '';
                if (partnerId) {
                    reports = reports.filter(r => r.assignedPartnerId === partnerId);
                }
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨å‰ï¼‰
            updateStatusCounts(reports);

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆã‚¿ãƒ–æ–¹å¼ï¼‰
            if (currentContractorStatusFilter) {
                reports = reports.filter(r => (r.contractorStatus || 'æœªå¯¾å¿œ') === currentContractorStatusFilter);
            }
            
            // æ—¥ä»˜ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate) {
                const startTime = new Date(startDate + 'T00:00:00').getTime();
                reports = reports.filter(r => new Date(r.timestamp).getTime() >= startTime);
            }
            
            if (endDate) {
                const endTime = new Date(endDate + 'T23:59:59').getTime();
                reports = reports.filter(r => new Date(r.timestamp).getTime() <= endTime);
            }
            
            renderReports(reports);
        }

        var currentContractorStatusFilter = '';

        function filterByContractorStatus(status, el) {
            currentContractorStatusFilter = status;
            document.querySelectorAll('.status-tab').forEach(function(t) { t.classList.remove('active'); });
            if (el) el.classList.add('active');
            filterReports();
        }

        function updateStatusCounts(reports) {
            var counts = { all: reports.length, 'æœªå¯¾å¿œ': 0, 'å¯¾å¿œä¸­': 0, 'å®Œäº†': 0, 'å¯¾å¿œä¸å¯': 0 };
            reports.forEach(function(r) {
                var s = r.contractorStatus || 'æœªå¯¾å¿œ';
                if (counts[s] !== undefined) counts[s]++;
            });
            document.getElementById('countAll').textContent = counts.all;
            document.getElementById('countPending').textContent = counts['æœªå¯¾å¿œ'];
            document.getElementById('countProgress').textContent = counts['å¯¾å¿œä¸­'];
            document.getElementById('countComplete').textContent = counts['å®Œäº†'];
            document.getElementById('countUnavailable').textContent = counts['å¯¾å¿œä¸å¯'];
        }

        // é€šå ±å±¥æ­´ã‚’è¡¨ç¤º
        function renderReports(reports) {
            const reportList = document.getElementById('reportList');
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®é€šå ±ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
            allReports = reports;
            
            if (reports.length === 0) {
                reportList.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-icon">ğŸ“‹</div>
                            <div>é€šå ±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
                        </td>
                    </tr>
                `;
                return;
            }

            const statusLabels = {
                pending: 'æœªå¯¾å¿œ',
                processing: 'å¯¾å¿œä¸­',
                completed: 'å®Œäº†'
            };
            
            const contractorStatusLabels = {
                'æœªå¯¾å¿œ': 'æœªå¯¾å¿œ',
                'å¯¾å¿œä¸­': 'å¯¾å¿œä¸­',
                'å®Œäº†': 'å®Œäº†',
                'å¯¾å¿œä¸å¯': 'å¯¾å¿œä¸å¯'
            };

            const typeLabels = {
                wholesale: 'å¸æ¥­è€…',
                building: 'ãƒ“ãƒ«ãƒ¡ãƒ³æ¥­è€…',
                welfare: 'ç¦ç¥‰ç”¨å…·æ¥­è€…',
                emergency: 'ç·Šæ€¥'
            };
            
            // æ¥­è€…ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿
            const partners = JSON.parse(localStorage.getItem('partners') || '[]');

            reportList.innerHTML = reports.map((report, index) => {
                const datetime = new Date(report.timestamp);
                const dateStr = datetime.toLocaleDateString('ja-JP') + ' ' + 
                               datetime.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                const status = report.status || 'pending';
                const category = report.emergency ? 'ç·Šæ€¥é€šå ±' : (typeLabels[report.type] || report.category || '-');
                const officeName = report.officeName || '-';
                
                // å‰²å½“æ¥­è€…åã‚’å–å¾—
                let assignedPartnerName = '-';
                let assignedPartnerWarning = '';
                if (report.assignedPartnerId) {
                    const partner = partners.find(p => p.id === report.assignedPartnerId);
                    assignedPartnerName = partner ? partner.name : 'ä¸æ˜';
                } else {
                    assignedPartnerWarning = ' style="color: #f59e0b; font-weight: 600;"';
                }
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                const contractorStatus = report.contractorStatus || '-';
                const contractorStatusClass = contractorStatus === 'æœªå¯¾å¿œ' ? 'status-pending' : 
                                              contractorStatus === 'å¯¾å¿œä¸­' ? 'status-processing' :
                                              contractorStatus === 'å®Œäº†' ? 'status-completed' :
                                              contractorStatus === 'å¯¾å¿œä¸å¯' ? 'status-unavailable' : '';
                
                // å¯¾å¿œæ™‚é–“ã‚’è¨ˆç®—
                let responseTime = '-';
                if (report.assignedAt && report.firstResponseAt) {
                    const assigned = new Date(report.assignedAt);
                    const responded = new Date(report.firstResponseAt);
                    const diffMs = responded - assigned;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    
                    if (diffHours > 0) {
                        responseTime = `${diffHours}æ™‚é–“${diffMinutes}åˆ†`;
                    } else {
                        responseTime = `${diffMinutes}åˆ†`;
                    }
                }
                
                return `
                    <tr onclick="showDetail(${index})" style="cursor: pointer;">
                        <td>${dateStr}</td>
                        <td>${report.reporter || '-'}</td>
                        <td>${officeName}</td>
                        <td>${category}</td>
                        <td>${(report.description || report.category || '-').length > 15 ? (report.description || report.category || '-').substring(0, 15) + '...' : (report.description || report.category || '-')}</td>
                        <td>${contractorStatus !== '-' ? `<span class="status-badge ${contractorStatusClass}">${contractorStatus}</span>` : '-'}</td>
                        <td>${responseTime}</td>
                        <td>${report.handler || '-'}</td>
                    </tr>
                `;
            }).join('');

            // ã‚¹ãƒãƒ›ç”¨ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
            const reportCards = document.getElementById('reportCards');
            if (reports.length === 0) {
                reportCards.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">ğŸ“‹ é€šå ±å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            } else {
                reportCards.innerHTML = reports.map((report, index) => {
                    const datetime = new Date(report.timestamp);
                    const dateStr = datetime.toLocaleDateString('ja-JP') + ' ' + 
                                   datetime.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                    const category = report.emergency ? 'ç·Šæ€¥é€šå ±' : (typeLabels[report.type] || report.category || '-');
                    const contractorStatus = report.contractorStatus || 'æœªå¯¾å¿œ';
                    const contractorStatusClass = contractorStatus === 'æœªå¯¾å¿œ' ? 'status-pending' : 
                                                  contractorStatus === 'å¯¾å¿œä¸­' ? 'status-processing' :
                                                  contractorStatus === 'å®Œäº†' ? 'status-completed' :
                                                  contractorStatus === 'å¯¾å¿œä¸å¯' ? 'status-unavailable' : '';
                    
                    let assignedPartnerName = '';
                    if (report.assignedPartnerId) {
                        const partner = partners.find(p => p.id === report.assignedPartnerId);
                        assignedPartnerName = partner ? partner.name : 'ä¸æ˜';
                    }

                    return `
                        <div class="report-card" onclick="showDetail(${index})">
                            <div class="report-card-header">
                                <div class="report-card-title">${(report.description || report.category || 'é€šå ±').length > 15 ? (report.description || report.category || 'é€šå ±').substring(0, 15) + '...' : (report.description || report.category || 'é€šå ±')}</div>
                                <span class="status-badge ${contractorStatusClass}">${contractorStatus}</span>
                            </div>
                            <div class="report-card-date">${dateStr}ã€€${report.reporter || '-'}</div>
                            <div class="report-card-info">
                                <span>${report.officeName || '-'}</span>
                                <span>${category}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportCSV() {
            if (!allReports || allReports.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹é€šå ±ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nå…ˆã«æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼åã®ãƒãƒƒãƒ”ãƒ³ã‚°
            let partners = [];
            try { partners = JSON.parse(sessionStorage.getItem('partners') || '[]'); } catch(e) {}
            let partnersLocal = [];
            try { partnersLocal = JSON.parse(localStorage.getItem('partners') || '[]'); } catch(e) {}
            partnersLocal.forEach(p => { if (!partners.find(m => m.id === p.id)) partners.push(p); });

            const headers = ['é€šå ±æ—¥æ™‚','é€šå ±è€…','ä¼šç¤¾ã‚³ãƒ¼ãƒ‰','äº‹æ¥­æ‰€','ã‚«ãƒ†ã‚´ãƒª','å†…å®¹','ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹','å¯¾å¿œæ™‚é–“','å¯¾å¿œè€…'];
            const rows = allReports.map(r => {
                const date = r.timestamp ? new Date(r.timestamp).toLocaleString('ja-JP') : '';
                let responseTime = '';
                if (r.assignedAt && r.firstResponseAt) {
                    const diffMs = new Date(r.firstResponseAt) - new Date(r.assignedAt);
                    const h = Math.floor(diffMs / 3600000);
                    const m = Math.floor((diffMs % 3600000) / 60000);
                    responseTime = h > 0 ? h + 'æ™‚é–“' + m + 'åˆ†' : m + 'åˆ†';
                }
                return [
                    date,
                    r.reporter || '',
                    r.companyCode || '',
                    r.officeName || '',
                    r.category || '',
                    (r.description || r.category || '').replace(/,/g, 'ï¼Œ'),
                    r.contractorStatus || '',
                    responseTime,
                    r.handler || ''
                ].map(v => '"' + String(v).replace(/"/g, '""') + '"').join(',');
            });

            const bom = '\uFEFF';
            const csv = bom + headers.join(',') + '\n' + rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const dateStr = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = 'report-history-' + dateStr + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // åˆæœŸåŒ–
        initOfficeFilter();

        // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®šï¼‰
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
        
        // 1ãƒ¶æœˆå‰ã‚’é–‹å§‹æ—¥ã«è¨­å®š
        const monthAgo = new Date();
        monthAgo.setMonth(monthAgo.getMonth() - 1);
        document.getElementById('startDate').value = monthAgo.toISOString().split('T')[0];
    </script>

    <script>
    // çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼åˆæœŸåŒ–
    UnifiedHeader.init({
        icon: 'ğŸ“œ',
        title: 'é€šå ±å±¥æ­´',
        backButton: true
    });
    </script>
</body>
</html>