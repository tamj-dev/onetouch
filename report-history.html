<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通報履歴 | ワンタッチ管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html { overflow-x: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans CJK JP", sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            overflow-x: hidden;
        }
        body.modal-open { overflow: hidden; position: fixed; width: 100%; }
.container {
            max-width: 1200px;
            margin: 16px auto;
            padding: 0 20px;
        }

        .filter-panel {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 16px;
            margin-bottom: 16px;
            align-items: center;
        }

        .filter-label {
            font-weight: 600;
            color: #555;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .table-container {
            display: block;
            overflow-x: auto;
        }
        .report-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
        }
        .report-table thead th {
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .report-table tbody tr {
            cursor: pointer;
            transition: background 0.15s;
        }
        .report-table tbody tr:hover {
            background: #f1f5f9;
        }
        .report-table tbody tr.is-new {
            background: #f8fafc;
        }
        .report-table tbody tr.is-new:hover {
            background: #f1f5f9;
        }
        .report-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
            vertical-align: middle;
        }
        .new-dot {
            display: inline-block;
            width: 7px;
            height: 7px;
            background: #3b82f6;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
        }
        .td-desc {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ステータスバッジ */
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-processing { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #e8f0fe; color: #1e3a5f; }
        .status-unavailable { background: #fee2e2; color: #991b1b; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* ステータスタブ */
        .status-tabs {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        .status-tab {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .status-tab:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        }
        .status-tab.active {
            border-color: #2563eb;
            background: #1e3a5f;
        }
        .status-tab-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }
        .status-tab.active .status-tab-label {
            color: white;
            font-weight: 600;
        }
        .status-tab-count {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }
        .status-tab.active .status-tab-count {
            color: white;
        }
        @media (max-width: 480px) {
            .status-tabs { grid-template-columns: repeat(3, 1fr); }
        }

        /* スマホ: カード表示 */
        .report-cards {
            display: none;
        }
        .report-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #2563eb;
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .report-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .report-card.is-new { border-left-color: #3b82f6; background: #fafbfc; }
        .report-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }
        .report-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            flex: 1;
            margin-right: 8px;
        }
        .report-card-date {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .report-card-info {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 12px;
            color: #475569;
            margin-bottom: 6px;
        }
        .report-card-info span {
            background: #f1f5f9;
            color: #475569;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .report-card-partner {
            font-size: 12px;
            color: #2563eb;
            font-weight: 600;
        }
        .report-card-response {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            .table-container { display: none; }
            .report-cards {
                display: grid;
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .filter-panel { padding: 16px; }
            .filter-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="demo-mode.js"></script>
    <script src="unified-header.js"></script>
    <meta name="theme-color" content="#1e3a5f">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
</head>
<body>
    <!-- 統一ヘッダー -->
    <div id="unified-header-mount"></div>

    <div class="container">
        <div class="filter-panel">
            <!-- システム管理者のみ: 会社フィルタ -->
            <div class="filter-row" id="companyFilterRow" style="display: none;">
                <div class="filter-label">会社</div>
                <div>
                    <select id="companyFilter" class="filter-input" onchange="onCompanyFilterChange()">
                        <option value="">-- 全会社 --</option>
                    </select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-label">事業所</div>
                <div id="officeFilterArea">
                    <div id="officeInfo" style="color: #666; font-size: 14px;">読み込み中...</div>
                </div>
            </div>

            <!-- システム管理者のみ: 業者フィルタ -->
            <div class="filter-row" id="partnerFilterRow" style="display: none;">
                <div class="filter-label">業者</div>
                <div>
                    <select id="partnerFilter" class="filter-input">
                        <option value="">-- 全業者 --</option>
                    </select>
                </div>
            </div>

            <!-- KPIカード + 滞留アラート（管理者のみ） -->
            <div id="stagnationAlert" style="grid-column: 1 / -1; display: none;">
                <!-- KPIカード -->
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px;">
                    <div style="flex: 1; min-width: 140px; padding: 14px 16px; background: #fff; border: 1px solid #e0e0e0; border-radius: 10px;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">今日の未対応</div>
                        <div style="font-size: 24px; font-weight: 700; color: #1e3a5f;" id="kpiTodayPending">0</div>
                    </div>
                    <div style="flex: 1; min-width: 140px; padding: 14px 16px; background: #fff; border: 1px solid #e0e0e0; border-radius: 10px;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">最長滞留</div>
                        <div style="font-size: 24px; font-weight: 700; color: #1e3a5f;" id="kpiMaxStagnation">-</div>
                    </div>
                    <div id="alertUnassigned" style="display:none; flex: 1; min-width: 140px; padding: 14px 16px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 10px; cursor: pointer;" onclick="filterByContractorStatus('', document.querySelector('.status-tab'));showUnassignedOnly();">
                        <div style="font-size: 13px; font-weight: 600; color: #92400e;">⚠ 担当未割当</div>
                        <div style="font-size: 24px; font-weight: 700; color: #92400e;" id="alertUnassignedCount">0</div>
                    </div>
                    <div id="alertStagnation" style="display:none; flex: 1; min-width: 140px; padding: 14px 16px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 10px; cursor: pointer;" onclick="filterByContractorStatus('未対応', document.querySelectorAll('.status-tab')[1]);">
                        <div style="font-size: 13px; font-weight: 600; color: #991b1b;">⚠ <span id="alertStagnationDays">3</span>日以上滞留</div>
                        <div style="font-size: 24px; font-weight: 700; color: #991b1b;" id="alertStagnationCount">0</div>
                    </div>
                </div>
            </div>

            <!-- 全ロール共通: ステータスタブ -->
            <div style="grid-column: 1 / -1;">
                <div class="filter-label" style="margin-bottom: 8px;">ステータス</div>
                <div class="status-tabs">
                    <div class="status-tab active" onclick="filterByContractorStatus('', this)">
                        <div class="status-tab-label">すべて</div>
                        <div class="status-tab-count" id="countAll">0</div>
                    </div>
                    <div class="status-tab" onclick="filterByContractorStatus('未対応', this)">
                        <div class="status-tab-label">未対応</div>
                        <div class="status-tab-count" id="countPending">0</div>
                    </div>
                    <div class="status-tab" onclick="filterByContractorStatus('対応中', this)">
                        <div class="status-tab-label">対応中</div>
                        <div class="status-tab-count" id="countProgress">0</div>
                    </div>
                    <div class="status-tab" onclick="filterByContractorStatus('完了', this)">
                        <div class="status-tab-label">完了</div>
                        <div class="status-tab-count" id="countComplete">0</div>
                    </div>
                    <div class="status-tab" onclick="filterByContractorStatus('対応不可', this)">
                        <div class="status-tab-label">対応不可</div>
                        <div class="status-tab-count" id="countUnavailable">0</div>
                    </div>
                </div>
            </div>

            <div class="filter-row" style="margin-top: 20px;">
                <div class="filter-label">期間</div>
                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <input type="date" id="startDate" class="filter-input">
                    <span>〜</span>
                    <input type="date" id="endDate" class="filter-input">
                    <button onclick="filterReports();this.textContent='検索中...';var b=this;setTimeout(function(){b.textContent='検索';},300);" style="padding: 8px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-left: 12px;">検索</button>
                    <button onclick="exportCSV()" style="padding: 8px 20px; background: #1e3a5f; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">CSVエクスポート</button>
                </div>
            </div>
        </div>

        <!-- PC: テーブル表示 -->
        <div class="table-container">
            <table class="report-table">
                <thead>
                    <tr>
                        <th>日時</th>
                        <th>内容</th>
                        <th>カテゴリ</th>
                        <th>事業所</th>
                        <th>通報者</th>
                        <th>担当業者</th>
                        <th>ステータス</th>
                        <th>対応時間</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
            </table>
        </div>

        <!-- スマホ: カード表示 -->
        <div id="reportCards" class="report-cards"  >
            <div style="grid-column: 1 / -1;" class="empty-state">
                <div class="empty-icon"></div>
                <div>通報履歴がありません</div>
            </div>
        </div>
        <div id="reportPagination"></div>
    </div>
    <div class="overlay" id="detailOverlay" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;">
        <div class="modal" style="background: white; border-radius: 12px; padding: 32px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 id="detailTitle" style="font-size: 20px; font-weight: 700; color: #333;">通報詳細</h2>
                <button onclick="closeDetail()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px;">&times;</button>
            </div>
            <div id="detailContent" style="line-height: 1.8;">
                <!-- 詳細内容がここに表示される -->
            </div>
        </div>
    </div>

    <script>
        // 共通ページネーション描画
        function renderPagination(containerId, currentPage, totalPages, totalItems, onPageChange) {
            var container = document.getElementById(containerId);
            if (!container) return;
            if (totalPages <= 1) {
                container.innerHTML = totalItems > 0 ? '<div style="text-align:center;padding:12px;font-size:13px;color:#999;">全 ' + totalItems + ' 件</div>' : '';
                return;
            }
            var html = '<div style="display:flex;align-items:center;justify-content:center;gap:6px;padding:16px;flex-wrap:wrap;">';
            html += '<span style="font-size:13px;color:#999;margin-right:8px;">全 ' + totalItems + ' 件</span>';
            html += '<button onclick="window._pgCb' + containerId + '(' + (currentPage - 1) + ')" ' + (currentPage <= 1 ? 'disabled' : '') + ' style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer;font-size:13px;' + (currentPage <= 1 ? 'opacity:0.4;cursor:default;' : '') + '">前へ</button>';
            var startP = Math.max(1, currentPage - 2);
            var endP = Math.min(totalPages, startP + 4);
            if (endP - startP < 4) startP = Math.max(1, endP - 4);
            for (var p = startP; p <= endP; p++) {
                html += '<button onclick="window._pgCb' + containerId + '(' + p + ')" style="padding:6px 12px;border:1px solid ' + (p === currentPage ? '#2563eb' : '#d1d5db') + ';border-radius:6px;background:' + (p === currentPage ? '#2563eb' : '#fff') + ';color:' + (p === currentPage ? '#fff' : '#333') + ';cursor:pointer;font-size:13px;font-weight:' + (p === currentPage ? '700' : '400') + ';">' + p + '</button>';
            }
            html += '<button onclick="window._pgCb' + containerId + '(' + (currentPage + 1) + ')" ' + (currentPage >= totalPages ? 'disabled' : '') + ' style="padding:6px 12px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer;font-size:13px;' + (currentPage >= totalPages ? 'opacity:0.4;cursor:default;' : '') + '">次へ</button>';
            html += '</div>';
            container.innerHTML = html;
            window['_pgCb' + containerId] = onPageChange;
        }

        // ログインチェック
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        } else if (currentUser.role !== 'system_admin' && currentUser.role !== 'company_admin' && currentUser.role !== 'office_admin') {
            alert('この画面は管理者のみアクセスできます。');
            window.location.href = 'report.html';
        }

        // グローバル変数
        let selectedOfficeCode = '';
        let allReports = []; // フィルタリング前の全通報を保持

        // 通報詳細を表示
        function showDetail(index) {
            const report = allReports[index];
            if (!report) return;

            const datetime = new Date(report.timestamp);
            const dateStr = datetime.toLocaleDateString('ja-JP') + ' ' + 
                           datetime.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            
            const typeLabels = {
                wholesale: '居室・生活',
                building: '居室・生活',
                welfare: '介護・医療',
                emergency: '緊急'
            };

            const statusLabels = {
                pending: '未対応',
                processing: '対応中',
                completed: '完了'
            };

            const label = report.emergency ? '緊急通報' : '通報';
            document.getElementById('detailTitle').innerHTML = label;

            let content = '';
            
            // 通報ID
            content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
            content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">通報ID</div>';
            content += '<div style="font-size: 15px; color: #333;">' + (report.id || '-') + '</div>';
            content += '</div>';

            // 日時
            content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
            content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">日時</div>';
            content += '<div style="font-size: 15px; color: #333;">' + dateStr + '</div>';
            content += '</div>';

            // 種別
            content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
            content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">種別</div>';
            const chipClass = report.emergency ? 'status-pending' : 'status-processing';
            const chipLabel = report.emergency ? '緊急' : '通報';
            content += '<div><span class="status-badge ' + chipClass + '">' + chipLabel + '</span></div>';
            content += '</div>';

            // 通報者
            content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
            content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">通報者</div>';
            content += '<div style="font-size: 15px; color: #333;">' + (report.reporter || '-') + '</div>';
            content += '</div>';

            // 事業所
            if (report.officeName) {
                content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">事業所</div>';
                content += '<div style="font-size: 15px; color: #333;">' + report.officeName + '</div>';
                content += '</div>';
            }

            // 対象業者
            content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
            content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">対象業者</div>';
            content += '<div style="font-size: 15px; color: #333;">' + (typeLabels[report.type] || report.category || '-') + '</div>';
            content += '</div>';

            // 場所
            if (report.location) {
                content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">場所</div>';
                content += '<div style="font-size: 15px; color: #333;">' + report.location + '</div>';
                content += '</div>';
            }

            // 詳細内容
            content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
            content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">詳細内容</div>';
            content += '<div style="background: #f9fafb; padding: 16px; border-radius: 8px; font-size: 14px; line-height: 1.8; white-space: pre-wrap;">' + (report.description || '-') + '</div>';
            content += '</div>';
            
            // 割当業者（追加）
            if (report.assignedPartnerName || report.assignedPartnerId) {
                content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">割当業者</div>';
                const partnerName = report.assignedPartnerName || '業者ID: ' + report.assignedPartnerId;
                content += '<div style="font-size: 15px; color: #333;">' + partnerName + '</div>';
                content += '</div>';
            }
            
            // ステータス変更履歴（追加）
            if (report.statusHistory && report.statusHistory.length > 0) {
                content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                content += '<div style="font-size: 12px; color: #999; margin-bottom: 12px;">ステータス変更履歴</div>';
                
                report.statusHistory.forEach(function(entry, idx) {
                    const entryTime = new Date(entry.timestamp);
                    const entryDateStr = entryTime.toLocaleDateString('ja-JP') + ' ' + 
                                          entryTime.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                    
                    // データ形式対応: { status, author } または { from, to, changedBy }
                    var statusText = entry.status || '';
                    var authorText = entry.author || entry.changedBy || '不明';
                    var isComment = entry.type === 'comment';
                    
                    var displayStatus = statusText;
                    
                    var dotColor = '#999';
                    if (statusText === '未対応') dotColor = '#f59e0b';
                    else if (statusText === '対応中') dotColor = '#3b82f6';
                    else if (statusText === '完了') dotColor = '#1e3a5f';
                    else if (statusText === '対応不可') dotColor = '#ef4444';

                    content += '<div style="display: flex; gap: 12px; margin-bottom: ' + (idx === report.statusHistory.length - 1 ? '0' : '12px') + '; padding: 12px; background: #f8f9fa; border-radius: 8px;">';
                    content += '<div style="flex-shrink: 0; width: 4px; background: ' + dotColor + '; border-radius: 2px;"></div>';
                    content += '<div style="flex: 1;">';
                    content += '<div style="font-size: 11px; color: #666; margin-bottom: 6px;">' + entryDateStr + ' • ' + authorText + '</div>';
                    
                    if (entry.from && entry.to) {
                        // from → to 形式
                        var displayFrom = entry.from;
                        var displayTo = entry.to;
                        content += '<div style="display: flex; align-items: center; gap: 8px;">';
                        content += '<span class="status-badge status-pending" style="font-size: 12px;">' + displayFrom + '</span>';
                        content += '<span style="color: #666;">→</span>';
                        content += '<span class="status-badge status-processing" style="font-size: 12px;">' + displayTo + '</span>';
                        content += '</div>';
                    } else if (statusText) {
                        // status 形式
                        content += '<div style="display: flex; align-items: center; gap: 8px;">';
                        content += '<span class="status-badge" style="font-size: 12px; background: ' + dotColor + '15; color: ' + dotColor + ';">' + displayStatus + '</span>';
                        content += '</div>';
                    }
                    
                    if (entry.comment) {
                        content += '<div style="font-size: 13px; color: #555; margin-top: 6px; background: white; padding: 8px 12px; border-radius: 6px;">' + entry.comment + '</div>';
                    }
                    if (entry.note) {
                        content += '<div style="font-size: 12px; color: #666; margin-top: 4px;">' + entry.note + '</div>';
                    }
                    content += '</div>';
                    content += '</div>';
                });
                
                content += '</div>';
            }
            
            // ステータス（追加）
            if (report.contractorStatus) {
                content += '<div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;">';
                content += '<div style="font-size: 12px; color: #999; margin-bottom: 4px;">状況</div>';
                const contractorStatusClass = report.contractorStatus === '未対応' ? 'status-pending' :
                                              report.contractorStatus === '対応中' ? 'status-processing' :
                                              report.contractorStatus === '完了' ? 'status-completed' :
                                              'status-unavailable';
                content += '<div><span class="status-badge ' + contractorStatusClass + '">' + (report.contractorStatus || '未対応') + '</span></div>';
                content += '</div>';
            }
            
            document.getElementById('detailContent').innerHTML = content;
            document.body._scrollY = window.scrollY;
            document.body.style.top = (-window.scrollY) + 'px';
            document.body.classList.add('modal-open');
            document.getElementById('detailOverlay').style.display = 'flex';
        }

        // 詳細を閉じる
        function closeDetail() {
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            window.scrollTo(0, document.body._scrollY || 0);
            document.getElementById('detailOverlay').style.display = 'none';
        }

        // オーバーレイクリックで閉じる
        document.getElementById('detailOverlay').addEventListener('click', function(e) {
            if (e.target.id === 'detailOverlay') {
                closeDetail();
            }
        });

        // 事業所選択UIを初期化
        function initOfficeFilter() {
            try {
            const officeFilterArea = document.getElementById('officeFilterArea');
            
            if (currentUser.role === 'system_admin') {
                // システム管理者専用フィルタを表示
                document.getElementById('companyFilterRow').style.display = '';
                document.getElementById('partnerFilterRow').style.display = '';
                
                // 会社フィルタ初期化
                initCompanyFilter();
                // 業者フィルタ初期化
                initPartnerFilter();
                
                // 事業所：全事業所を表示（会社選択で絞り込み）
                initOfficeSelect('');
                filterReports();
                
            } else if (currentUser.role === 'company_admin') {
                selectedOfficeCode = 'all_company';
                initOfficeSelectForCompany(currentUser.companyCode);
                filterReports();
            } else {
                selectedOfficeCode = currentUser.officeCode || '';
                officeFilterArea.innerHTML = '<div id="officeInfo" style="color: #666; font-size: 14px;">' + (currentUser.officeName || '全事業所') + '</div>';
                filterReports();
            }
            } catch(e) {
                console.error('initOfficeFilter error:', e);
                document.getElementById('officeFilterArea').innerHTML = '<div style="color:#666;font-size:14px;">全事業所</div>';
                filterReports();
            }
        }

        // 会社フィルタ初期化
        function initCompanyFilter() {
            const companyFilter = document.getElementById('companyFilter');
            let companies = [];
            try { companies = JSON.parse(sessionStorage.getItem('companies') || '[]'); } catch(e) {}
            let companiesLocal = [];
            try { companiesLocal = JSON.parse(localStorage.getItem('companies') || '[]'); } catch(e) {}
            companiesLocal.forEach(c => { if (!companies.find(m => m.code === c.code)) companies.push(c); });
            
            companies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.code;
                opt.textContent = c.name;
                companyFilter.appendChild(opt);
            });
        }

        // 会社フィルタ変更時 → 事業所ドロップダウンを連動更新
        function onCompanyFilterChange() {
            const companyCode = document.getElementById('companyFilter').value;
            initOfficeSelect(companyCode);
        }

        // 事業所セレクト初期化（会社コードで絞り込み）
        function initOfficeSelect(companyCode) {
            const officeFilterArea = document.getElementById('officeFilterArea');
            let offices = [];
            try { offices = JSON.parse(sessionStorage.getItem('offices') || '[]'); } catch(e) {}
            let officesLocal = [];
            try { officesLocal = JSON.parse(localStorage.getItem('offices') || '[]'); } catch(e) {}
            officesLocal.forEach(o => { if (!offices.find(m => m.code === o.code)) offices.push(o); });
            
            if (companyCode) {
                offices = offices.filter(o => o.companyCode === companyCode);
            }
            
            let optionsHTML = '<option value="">-- 事業所を選択 --</option>';
            optionsHTML += '<option value="all">全事業所</option>';
            offices.forEach(office => {
                optionsHTML += `<option value="${office.code}">${office.name}</option>`;
            });
            
            officeFilterArea.innerHTML = `
                <select id="officeSelect" class="filter-input" style="width: 300px;">
                    ${optionsHTML}
                </select>
            `;
        }

        // 本社管理者用：自社の事業所セレクトボックス
        function initOfficeSelectForCompany(companyCode) {
            const officeFilterArea = document.getElementById('officeFilterArea');
            let offices = [];
            try { offices = JSON.parse(sessionStorage.getItem('offices') || '[]'); } catch(e) {}
            let officesLocal = [];
            try { officesLocal = JSON.parse(localStorage.getItem('offices') || '[]'); } catch(e) {}
            officesLocal.forEach(o => { if (!offices.find(m => m.code === o.code)) offices.push(o); });

            if (companyCode) {
                offices = offices.filter(o => o.companyCode === companyCode);
            }

            let optionsHTML = '<option value="all_company">全事業所</option>';
            offices.forEach(office => {
                optionsHTML += `<option value="${office.code}">${office.name}</option>`;
            });

            officeFilterArea.innerHTML = `
                <select id="companyOfficeSelect" class="filter-input" style="width: 300px;">
                    ${optionsHTML}
                </select>
            `;

            document.getElementById('companyOfficeSelect').addEventListener('change', function() {
                selectedOfficeCode = this.value;
                filterReports();
            });
        }

        // 業者フィルタ初期化
        function initPartnerFilter() {
            const partnerFilter = document.getElementById('partnerFilter');
            let partners = [];
            try { partners = JSON.parse(sessionStorage.getItem('partners') || '[]'); } catch(e) {}
            let partnersLocal = [];
            try { partnersLocal = JSON.parse(localStorage.getItem('partners') || '[]'); } catch(e) {}
            partnersLocal.forEach(p => { if (!partners.find(m => m.id === p.id)) partners.push(p); });
            
            partners.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.companyName || p.name || p.id;
                partnerFilter.appendChild(opt);
            });
        }

        // 戻る機能
        // 戻る（ロールに応じたホームに遷移）
        function goBack() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                
                if (!currentUser || !currentUser.role) {
                    window.location.href = 'login.html';
                    return;
                }

                // ロール別のホーム画面
                const homePages = {
                    'system_admin': 'system-admin.html',
                    'company_admin': 'master-top.html',
                    'office_admin': 'master-top.html',
                    'staff': 'report.html',
                    'contractor': 'contractor-dashboard.html'
                };

                const homePage = homePages[currentUser.role] || 'master-top.html';
                window.location.href = homePage;
            } catch (e) {
                console.error('goBack error:', e);
                window.location.href = 'master-top.html';
            }
        }

        // 通報履歴をフィルタリングして表示
        function filterReports() {
            rh_currentPage = 1;
            // システム管理者の場合は選択された事業所を取得
            if (currentUser.role === 'system_admin') {
                const officeSelect = document.getElementById('officeSelect');
                selectedOfficeCode = officeSelect ? officeSelect.value : '';
            }

            // LocalStorage/SessionStorageから通報データを取得（DEMO対応）
            let reportsFromSession = [];
            let reportsFromLocal = [];
            try { reportsFromSession = JSON.parse(sessionStorage.getItem('onetouch.reports') || '[]'); } catch(e) {}
            try { reportsFromLocal = JSON.parse(localStorage.getItem('onetouch.reports') || '[]'); } catch(e) {}
            let reports = [...reportsFromSession];
            reportsFromLocal.forEach(r => { if (!reports.find(m => m.id === r.id)) reports.push(r); });
            
            // 会社フィルタ（システム管理者のみ）
            if (currentUser.role === 'system_admin') {
                const companyCode = document.getElementById('companyFilter') ? document.getElementById('companyFilter').value : '';
                if (companyCode) {
                    reports = reports.filter(r => r.companyCode === companyCode);
                }
            }

            // 事業所でフィルタリング
            if (selectedOfficeCode === 'all_company') {
                reports = reports.filter(r => r.companyCode === currentUser.companyCode);
            } else if (selectedOfficeCode && selectedOfficeCode !== 'all' && selectedOfficeCode !== '') {
                reports = reports.filter(r => r.officeCode === selectedOfficeCode);
            }

            // 業者フィルタ（システム管理者のみ）
            if (currentUser.role === 'system_admin') {
                const partnerId = document.getElementById('partnerFilter') ? document.getElementById('partnerFilter').value : '';
                if (partnerId) {
                    reports = reports.filter(r => r.assignedPartnerId === partnerId);
                }
            }

            // ステータスカウント更新（ステータスフィルタ適用前）
            updateStatusCounts(reports);

            // ステータスフィルタ（タブ方式）
            if (currentContractorStatusFilter) {
                reports = reports.filter(r => (r.contractorStatus || '未対応') === currentContractorStatusFilter);
            }
            
            // 担当未割当フィルター
            if (showUnassignedFlag) {
                reports = reports.filter(r => !r.assignedPartnerId);
                showUnassignedFlag = false;
            }
            
            // 日付でフィルタリング
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate) {
                const startTime = new Date(startDate + 'T00:00:00').getTime();
                reports = reports.filter(r => new Date(r.timestamp).getTime() >= startTime);
            }
            
            if (endDate) {
                const endTime = new Date(endDate + 'T23:59:59').getTime();
                reports = reports.filter(r => new Date(r.timestamp).getTime() <= endTime);
            }
            
            renderReports(reports);
        }

        var currentContractorStatusFilter = '';

        function filterByContractorStatus(status, el) {
            currentContractorStatusFilter = status;
            document.querySelectorAll('.status-tab').forEach(function(t) { t.classList.remove('active'); });
            if (el) el.classList.add('active');
            filterReports();
        }

        // 確認済みにする（新着バナーを消す）
        function markReportsViewed() {
            const userId = currentUser.userId || currentUser.id || '';
            localStorage.setItem('ONE_report_lastViewed_' + userId, new Date().toISOString());
            filterReports(); // 再描画
        }

        function updateStatusCounts(reports) {
            var counts = { all: reports.length, '未対応': 0, '対応中': 0, '完了': 0, '対応不可': 0 };
            reports.forEach(function(r) {
                var s = r.contractorStatus || '未対応';
                if (counts[s] !== undefined) counts[s]++;
            });
            document.getElementById('countAll').textContent = counts.all;
            document.getElementById('countPending').textContent = counts['未対応'];
            document.getElementById('countProgress').textContent = counts['対応中'];
            document.getElementById('countComplete').textContent = counts['完了'];
            document.getElementById('countUnavailable').textContent = counts['対応不可'];
            
            // 滞留アラート（管理者のみ）
            updateStagnationAlert(reports);
        }

        function updateStagnationAlert(reports) {
            // 管理者ロール判定
            if (!currentUser || (currentUser.role !== 'company_admin' && currentUser.role !== 'office_admin' && currentUser.role !== 'system_admin')) {
                return;
            }
            
            var stagnationDays = parseInt(localStorage.getItem('onetouch.stagnationDays') || sessionStorage.getItem('onetouch.stagnationDays') || '3');
            var now = new Date();
            var todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var unassignedCount = 0;
            var stagnationCount = 0;
            var todayPendingCount = 0;
            var maxStagnationDays = 0;
            
            reports.forEach(function(r) {
                // 完了・対応不可は除外
                if (r.contractorStatus === '完了' || r.contractorStatus === '対応不可') return;
                
                // 担当未割当
                if (!r.assignedPartnerId) {
                    unassignedCount++;
                }
                
                var status = r.contractorStatus || '未対応';
                
                // 今日の未対応（今日受付でまだ未対応）
                if (status === '未対応' && r.timestamp) {
                    var created = new Date(r.timestamp);
                    if (created >= todayStart) {
                        todayPendingCount++;
                    }
                }
                
                // 滞留判定（未対応のまま X日以上経過）+ 最長滞留
                if (status === '未対応' && r.timestamp) {
                    var created = new Date(r.timestamp);
                    var diffDays = (now - created) / (1000 * 60 * 60 * 24);
                    if (diffDays > maxStagnationDays) {
                        maxStagnationDays = diffDays;
                    }
                    if (diffDays >= stagnationDays) {
                        stagnationCount++;
                    }
                }
                
                // 対応中の滞留も最長に含める
                if (status === '対応中' && r.timestamp) {
                    var created = new Date(r.timestamp);
                    var diffDays = (now - created) / (1000 * 60 * 60 * 24);
                    if (diffDays > maxStagnationDays) {
                        maxStagnationDays = diffDays;
                    }
                }
            });
            
            // KPIカード更新
            document.getElementById('kpiTodayPending').textContent = todayPendingCount;
            if (maxStagnationDays > 0) {
                var d = Math.floor(maxStagnationDays);
                document.getElementById('kpiMaxStagnation').textContent = d + '日';
                // 滞留日数が設定値以上なら赤く
                var maxEl = document.getElementById('kpiMaxStagnation');
                if (d >= stagnationDays) {
                    maxEl.style.color = '#dc2626';
                } else {
                    maxEl.style.color = '#1e3a5f';
                }
            } else {
                document.getElementById('kpiMaxStagnation').textContent = '-';
            }
            
            var alertSection = document.getElementById('stagnationAlert');
            var alertUnassigned = document.getElementById('alertUnassigned');
            var alertStagnation = document.getElementById('alertStagnation');
            
            // KPIカードは常に表示
            alertSection.style.display = 'block';
            
            if (unassignedCount > 0) {
                alertUnassigned.style.display = 'block';
                document.getElementById('alertUnassignedCount').textContent = unassignedCount;
            } else {
                alertUnassigned.style.display = 'none';
            }
            
            if (stagnationCount > 0) {
                alertStagnation.style.display = 'block';
                document.getElementById('alertStagnationDays').textContent = stagnationDays;
                document.getElementById('alertStagnationCount').textContent = stagnationCount;
            } else {
                alertStagnation.style.display = 'none';
            }
        }
        
        // 担当未割当フィルター
        var showUnassignedFlag = false;
        function showUnassignedOnly() {
            showUnassignedFlag = true;
            currentContractorStatusFilter = '';
            document.querySelectorAll('.status-tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelector('.status-tab').classList.add('active');
            filterReports();
        }

        // 通報履歴を表示
        var rh_currentPage = 1;
        var rh_pageSize = 30;

        function renderReports(reports) {
            const reportCards = document.getElementById('reportCards');
            const reportTableBody = document.getElementById('reportTableBody');
            
            // フィルタリング後の通報をグローバル変数に保存
            allReports = reports;

            // 新着判定
            const userId = currentUser.userId || currentUser.id || '';
            const lastViewed = localStorage.getItem('ONE_report_lastViewed_' + userId) || '1970-01-01';
            const newCount = reports.filter(function(r) { return r.timestamp > lastViewed; }).length;

            // 新着バナー表示
            var banner = document.getElementById('newReportBanner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'newReportBanner';
                banner.style.cssText = 'background:#e8f0fe;border:1px solid #93b4f5;border-radius:8px;padding:12px 20px;margin-bottom:16px;display:none;align-items:center;justify-content:space-between;';
                var tableContainer = document.querySelector('.table-container');
                tableContainer.parentNode.insertBefore(banner, tableContainer);
            }
            if (newCount > 0 && banner) {
                banner.style.display = 'flex';
                banner.innerHTML = '<span style="font-weight:600;color:#1e3a5f;">新着 ' + newCount + ' 件の通報があります</span>'
                    + '<button onclick="markReportsViewed()" style="background:#1e3a5f;color:#fff;border:none;border-radius:6px;padding:6px 16px;cursor:pointer;font-size:13px;">確認済みにする</button>';
            } else if (banner) {
                banner.style.display = 'none';
            }
            
            if (reports.length === 0) {
                reportTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:60px 20px;color:#94a3b8;">通報履歴がありません</td></tr>';
                reportCards.innerHTML = '<div style="text-align:center;padding:60px 20px;color:#94a3b8;"><div style="font-size:48px;margin-bottom:16px;"></div><div>通報履歴がありません</div></div>';
                renderPagination('reportPagination', 0, 0, 0, function(){});
                return;
            }

            // ページネーション計算
            var totalPages = Math.ceil(reports.length / rh_pageSize);
            if (rh_currentPage > totalPages) rh_currentPage = totalPages;
            var start = (rh_currentPage - 1) * rh_pageSize;
            var pageReports = reports.slice(start, start + rh_pageSize);

            const typeLabels = {
                wholesale: '居室・生活',
                building: '居室・生活',
                welfare: '介護・医療',
                emergency: '緊急'
            };
            
            // 業者マスタを読み込み
            const partners = JSON.parse(localStorage.getItem('partners') || '[]');

            // ===== PC: テーブル行を生成 =====
            reportTableBody.innerHTML = pageReports.map((report, i) => {
                const globalIndex = start + i;
                const datetime = new Date(report.timestamp);
                const dateStr = datetime.toLocaleDateString('ja-JP', {month:'2-digit', day:'2-digit'});
                const timeStr = datetime.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                const category = report.emergency ? '緊急通報' : (typeLabels[report.type] || report.category || '-');
                const officeName = report.officeName || '-';
                
                let assignedPartnerName = '';
                if (report.assignedPartnerId) {
                    const partner = partners.find(p => p.id === report.assignedPartnerId);
                    assignedPartnerName = partner ? partner.name : '不明';
                }
                
                const contractorStatus = report.contractorStatus || '未対応';
                const contractorStatusClass = contractorStatus === '未対応' ? 'status-pending' : 
                                              contractorStatus === '対応中' ? 'status-processing' :
                                              contractorStatus === '完了' ? 'status-completed' :
                                              contractorStatus === '対応不可' ? 'status-unavailable' : '';
                let responseTime = '';
                if (report.assignedAt && report.firstResponseAt) {
                    const diffMs = new Date(report.firstResponseAt) - new Date(report.assignedAt);
                    const diffH = Math.floor(diffMs / 3600000);
                    const diffM = Math.floor((diffMs % 3600000) / 60000);
                    responseTime = diffH > 0 ? diffH + '時間' + diffM + '分' : diffM + '分';
                }
                
                const isNew = report.timestamp > lastViewed;
                const description = (report.description || report.category || '通報');
                const descShort = description.length > 25 ? description.substring(0, 25) + '…' : description;
                
                return '<tr class="' + (isNew ? 'is-new' : '') + '" onclick="showDetail(' + globalIndex + ')">'
                    + '<td style="white-space:nowrap;font-size:12px;color:#64748b;">' + dateStr + '<br>' + timeStr + '</td>'
                    + '<td class="td-desc">' + (isNew ? '<span class="new-dot"></span>' : '') + descShort + '</td>'
                    + '<td>' + category + '</td>'
                    + '<td>' + officeName + '</td>'
                    + '<td>' + (report.reporter || '-') + '</td>'
                    + '<td style="color:#2563eb;font-weight:500;">' + (assignedPartnerName || '<span style="color:#ccc;">—</span>') + '</td>'
                    + '<td><span class="status-badge ' + contractorStatusClass + '">' + contractorStatus + '</span></td>'
                    + '<td style="font-size:12px;color:#64748b;">' + (responseTime || '—') + '</td>'
                    + '</tr>';
            }).join('');

            // ===== スマホ: カード表示を生成 =====
            reportCards.innerHTML = pageReports.map((report, i) => {
                const globalIndex = start + i;
                const datetime = new Date(report.timestamp);
                const dateStr = datetime.toLocaleDateString('ja-JP') + ' ' + 
                               datetime.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                const category = report.emergency ? '緊急通報' : (typeLabels[report.type] || report.category || '-');
                const officeName = report.officeName || '-';
                
                let assignedPartnerName = '';
                if (report.assignedPartnerId) {
                    const partner = partners.find(p => p.id === report.assignedPartnerId);
                    assignedPartnerName = partner ? partner.name : '不明';
                }
                
                const contractorStatus = report.contractorStatus || '未対応';
                const contractorStatusClass = contractorStatus === '未対応' ? 'status-pending' : 
                                              contractorStatus === '対応中' ? 'status-processing' :
                                              contractorStatus === '完了' ? 'status-completed' :
                                              contractorStatus === '対応不可' ? 'status-unavailable' : '';
                
                const isNew = report.timestamp > lastViewed;
                const description = (report.description || report.category || '通報');
                const descShort = description.length > 20 ? description.substring(0, 20) + '...' : description;
                
                return `
                    <div class="report-card${isNew ? ' is-new' : ''}" onclick="showDetail(${globalIndex})">
                        <div class="report-card-header">
                            <div class="report-card-title">${isNew ? '<span class="new-dot"></span>' : ''}${descShort}</div>
                            <span class="status-badge ${contractorStatusClass}">${contractorStatus}</span>
                        </div>
                        <div class="report-card-date">${dateStr}　${report.reporter || '-'}</div>
                        <div class="report-card-info">
                            <span>${officeName}</span>
                            <span>${category}</span>
                        </div>
                        ${assignedPartnerName ? `<div class="report-card-partner">担当: ${assignedPartnerName}</div>` : ''}
                    </div>
                `;
            }).join('');

            renderPagination('reportPagination', rh_currentPage, totalPages, reports.length, function(page) {
                rh_currentPage = page;
                renderReports(allReports);
            });
        }

        // CSVエクスポート
        function exportCSV() {
            if (!allReports || allReports.length === 0) {
                alert('エクスポートする通報データがありません。\n先に検索を実行してください。');
                return;
            }

            // パートナー名のマッピング
            let partners = [];
            try { partners = JSON.parse(sessionStorage.getItem('partners') || '[]'); } catch(e) {}
            let partnersLocal = [];
            try { partnersLocal = JSON.parse(localStorage.getItem('partners') || '[]'); } catch(e) {}
            partnersLocal.forEach(p => { if (!partners.find(m => m.id === p.id)) partners.push(p); });

            var esc = function(v) { return '"' + String(v || '').replace(/"/g, '""').replace(/\n/g, ' ') + '"'; };

            const headers = ['通報ID','通報日時','通報者','会社コード','事業所','設備名','カテゴリ','場所','状況詳細','割当業者','業者ステータス','対応時間','最新コメント','写真枚数'];
            const rows = allReports.map(r => {
                const date = r.timestamp ? new Date(r.timestamp).toLocaleString('ja-JP') : '';
                let responseTime = '';
                if (r.assignedAt && r.firstResponseAt) {
                    const diffMs = new Date(r.firstResponseAt) - new Date(r.assignedAt);
                    const h = Math.floor(diffMs / 3600000);
                    const m = Math.floor((diffMs % 3600000) / 60000);
                    responseTime = h > 0 ? h + '時間' + m + '分' : m + '分';
                }
                // 割当業者名
                var partnerName = r.assignedPartnerName || '';
                if (!partnerName && r.assignedPartnerId) {
                    var p = partners.find(function(x) { return x.id === r.assignedPartnerId; });
                    partnerName = p ? p.name : r.assignedPartnerId;
                }
                // 最新コメント
                var latestComment = '';
                if (r.statusHistory && r.statusHistory.length > 0) {
                    for (var i = r.statusHistory.length - 1; i >= 0; i--) {
                        if (r.statusHistory[i].comment) { latestComment = r.statusHistory[i].comment; break; }
                    }
                }
                if (!latestComment && r.contractorComments && r.contractorComments.length > 0) {
                    latestComment = r.contractorComments[r.contractorComments.length - 1].text || '';
                }
                // 写真枚数
                var photoCount = (r.photos && r.photos.length) || 0;

                return [
                    esc(r.id),
                    esc(date),
                    esc(r.reporter),
                    esc(r.companyCode),
                    esc(r.officeName),
                    esc(r.title),
                    esc(r.category),
                    esc(r.location),
                    esc(r.description),
                    esc(partnerName),
                    esc(r.contractorStatus),
                    esc(responseTime),
                    esc(latestComment),
                    esc(photoCount)
                ].join(',');
            });

            const bom = '\uFEFF';
            const csv = bom + headers.join(',') + '\n' + rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const dateStr = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = 'report-history-' + dateStr + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // 初期化
        initOfficeFilter();

        // 日付フィルタ（今日の日付を設定）
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
        
        // 1ヶ月前を開始日に設定
        const monthAgo = new Date();
        monthAgo.setMonth(monthAgo.getMonth() - 1);
        document.getElementById('startDate').value = monthAgo.toISOString().split('T')[0];
    </script>

    <script>
    // 統一ヘッダー初期化
    UnifiedHeader.init({
        icon: '',
        title: '通報履歴',
        backButton: true
    });
    </script>
</body>
</html>